# プロジェクト仕様書：RC-Notice（v0.3）

最終更新: 2025-08-03
作成: 花木（前版 v0.2: 2025‑07‑31）

## 0. プロジェクト概要

* **目的**：ロータリークラブ事務局（柴崎さん）の通知・出欠回収・集計の負荷を軽減し、会員42名が **スマホでワンタップ出欠** と **自動集計** を行える仕組みを提供する。
* **主方針**：**B案採用**（LINE公式＋Messaging APIボタン回答＋n8n自動処理） + **LIFF 延長**（登録時のみ）。
  * **登録フロー**：LIFF + LINEログインチャネル → `userId` と `member_id` を確実に紐付け
  * **回答フロー**：Messaging API ボタン（postback）＋ n8n
  * **公開ビュー**：Notion（DBミラー）で提供。マスターはGoogleスプレッドシート。
  * **FAX希望者**：代理登録で同一DBに統合。
* **対象**：月1回程度の**イベント出欠**（例会ではない）。

---

## 1. 成果物（Deliverables）

### 1.1 LINE 側

| # | 名称                                 | 役割                          |
| - | ---------------------------------- | --------------------------- |
| 1 | **LINE公式アカウント**（Messaging APIチャネル） | 配信・出欠ボタン・自動応答               |
| 2 | **LINE ログインチャネル**                  | LIFF アプリ保持・Botとリンク          |
| 3 | **LIFF アプリ**（Web App／Full）         | 会員ID登録フォーム（`register.html`） |

### 1.2 n8n ワークフロー

| WF            | 概要                                                           |
| ------------- | ------------------------------------------------------------ |
| `WF-Register` | **LIFF→Webhook** で `member_id` + `user_id` を Sheets へ Upsert |
| `WF-RSVP`     | 回答受信 → Sheets 記録 → Notion反映                                  |
| `WF-Remind`   | 未回答者自動リマインド（毎日18:00）                                         |
| `WF-ProxyFAX` | 事務局代理登録フォーム                                                  |

### 1.3 データ／資料

1. **Google スプレッドシート**（マスター）: `Members / Events / RSVPs / Views-*`
2. **Notion DB** （公開ビュー）: `RSVPs_Public`（イベント別の出席者一覧などビュー構成）
3. **会員向け 1 枚もの（QR 付）**：登録〜出欠の使い方
4. **当日デモ用スライド**（3–5 枚, 8/19 用）

---

## 2. スコープ

* **含む**：出欠の収集・集計・未回答リマインド／一覧の会員公開／FAX代理登録
**含まない**：会員専用サイト全般／会計・受付・名札等の周辺機能

---

## 3. 役割と権限

* **管理者**：花木（LINE公式・LINE Dev・n8n・Sheets・Notion管理）
* **事務局**：柴崎さん（配信、イベント登録、代理登録、一覧確認）
* **会員**：出欠回答（LINE）、一覧の閲覧（Notion公開URL）

---

## 4. システム構成（テキスト図）

```text
[会員 LINE] --(LIFF DeepLink)--> [LINE Login Ch] --OIDC--> [LIFF register.html]
                                         │                         │ POST JSON
                                         └───────────────> [n8n /register/step2]
                                                            │  │  │
[会員 LINE] --(Postback)--> [Messaging API] --Webhook--> [n8n /rsvp] --Sheets--> RSVPs
                                                        │                           │
                                                        └──Notion DB (Public) <────┘
```

* 静的 HTML (`register.html`) は VPS `/opt/www` に配置し、Caddy で `/static/*` として配信。

---

## 5. データモデル（Sheets＝マスター）

### 5.1 Members

* `member_id` (文字列; 例: "A-012")
* `name`（漢字フルネーム）
* `fax_flag`（TRUE/FALSE）
* `line_user_id`（LINEのuserId；登録後に格納）
* `registered_at`（登録日時）

### 5.2 Events

* `event_id`（例: `E250819` = 2025-08-19 の短縮）
* `title`（例: 納涼家族会）
* `date`（開催日時）
* `deadline`（回答締切日時）
* `remind_start`（リマインド開始日）
* `remind_end`（リマインド終了日）
* `note`（将来拡張）

### 5.3 RSVPs

* `event_id`
* `member_id`
* `status`（**出席** | **欠席**）
* `timestamp`（回答日時）
* `via`（LINE | FAX代理）
* `memo`（将来拡張）

> **Views-**\*：イベント別一覧、未回答者抽出などのクエリ／フィルタ用タブ。

---

## 6. Notion（公開ビュー：DBミラー）

* DB名：`RSVPs_Public`
* プロパティ：

  * `Event`（テキスト or 関連; `event_id`で紐付け表示）
  * `Member`（テキスト; `member_id`から名前展開）
  * `Status`（出席/欠席）
  * `Updated`（日時）
* 主なビュー：

  * **イベント別（出席者一覧）**：Status=出席のみ
  * **サマリー**：イベントごとの出席人数/欠席人数
* 公開：**公開リンク**を会員に共有（検索避け）。URL変更でアクセス停止可能。

---

## 7. メッセージ/画面フロー

### 7.1 会員登録（本人確認：**2ステップ**）

* **登録URL**：**期限なし**（固定URL）。
  あいさつメッセージに **Deep Link** `https://liff.line.me/LIFF_ID` を送付。
  ※リッチメニュー固定項目は**設置しない**。初回告知・必要時の案内メッセージで周知。

* **運用前提**：当日、**氏名＋会員IDの一覧を配布**。

* **displayName補助**：LINEの`displayName`を取得し、名簿（空白除去のみで正規化）に**一意一致**した場合、**会員ID欄に初期値**として表示（最終確定は会員ID）。

* **STEP1：会員ID入力ページ**

1. **友だち追加直後**：あいさつメッセージに **Deep Link** `https://liff.line.me/LIFF_ID` を送付。
2. **LIFF 起動**：`liff.getProfile()` で `userId` を取得し、`register.html` に埋め込み。

3. **STEP1**：会員ID入力 → 送信。Sheets Lookup。存在しなければエラー。

4. `Members`で該当IDを検索（Sheets Lookup）
4-1. 見つからない → エラー表示（戻る）
4-2. 見つかった → **STEP2**へリダイレクト（`member_id`を引継ぎ）

* **STEP2：確認ページ**

  * 表示内容：

    * 「会員ID：A-012」
    * 「氏名：山田太郎」
  * ボタン：「この内容で登録する」
  * 送信時の処理：

    * **上書き禁止**：`Members.line_user_id` が**空のときのみ**登録可
    * 未登録：`line_user_id` を保存、`registered_at` 記録 → **完了**
    * 既登録：**エラー表示**（事務局へ解除依頼を案内）

    * ボタン押下 → `/register/step2` (n8n Webhook) へ POST(JSON)。

> **レート制限/CAPTCHA**：実装**しない**（今回の方針）。
> **将来強化**：必要になれば「登録のみLIFF化」で `userId` を確実取得し堅牢化。

### 7.2 出欠回答（ワンタップ）

* 事務局が一斉配信：

  > 【出欠のお願い】8/25(日) 18:00〜「納涼家族会」
  > 締切：8/18(日) 18:00
  > ［出席］［欠席］｜［概要を見る］
* ボタンpostbackペイロード（例）：

  ```
  action=rsvp&event_id=E250825&status=attend   # 出席
  action=rsvp&event_id=E250825&status=absent   # 欠席
  ```
* 完了応答（暫定）：

  > **「出欠を受け付けました。訂正はもう一度ボタンを押してください。」**

### 7.3 未回答リマインド（自動）

* **毎日18:00**、`remind_start`〜`remind_end`の範囲で**未回答者のみ**に送信。
* 文面例：

  > 「まだ出欠の回答が確認できていません。下のボタンからご登録ください。」
  > ［出席］［欠席］

### 7.4 FAX代理登録

* 事務局用フォームで `event_id` と `member_id` と `status` を入力 → `via=FAX代理`でRSVPsへ記録。
* 一覧にはLINE回答と同じく反映。

---

## 8. n8nワークフロー仕様

### 8.1 `WF-Register`（会員登録 2ステップ）

| Seq | ノード                                     | 処理                                  |
| --- | --------------------------------------- | ----------------------------------- |
| 1   | **Webhook Trigger** (`/register/step2`) | POST JSON `{member_id, user_id}` 受信 |
| 2   | **Lookup Rows** (Members)               | `member_id` で検索                     |
| 3   | **IF**                                  | `line_user_id` 空 → 続行／既登録 → エラー返却   |
| 4   | **Update Row**                          | `line_user_id`, `registered_at` 書込み |
| 5   | **HTTP Request (Push API)**             | 完了メッセージ送信                           |
| 6   | **Response**                            | HTML/JSON で「登録完了」を返却                |

v1.1版
---
1. **登録リンクアクセス（期限なしURL）**

   * LINE内ブラウザ時、`displayName`取得 → 名簿正規化（空白除去）で一意一致→ **会員ID初期表示**
2. **STEP1 Form Trigger**：`member_id`入力 → Sheets Lookup
3. **分岐**：未存在→エラー／存在→STEP2へ（クエリに`member_id`）
4. **STEP2 Form Trigger**：氏名表示→確認「登録する」
5. **上書き禁止チェック**：`Members.line_user_id` が空か判定
6. **Upsert**：`line_user_id` 保存、`registered_at` 記録
7. **完了メッセージ**：LINE送信
---


### 8.2 `WF-RSVP`（出欠記録）

1. **Webhook**（LINE postback: `action=rsvp`）
2. **Parse**：`event_id` / `status(attend|absent)` / `userId`
3. **Sheets Lookup**：`userId` → `member_id` 特定（`Members`）
4. **分岐処理**：

   * `member_id` が見つかった場合 → **Step 5 以降へ進む**
   * 見つからない場合（未登録） →

     * LINE返信：

       > 「まだ会員登録が完了していません。
       > 下のリンクから登録後、もう一度ボタンを押してください。」
       > ［登録はこちら］
     * RSVP登録処理はスキップ
5. **Upsert**：`RSVPs`（一意キー = `event_id` + `member_id`）
6. **Notion Upsert**：`RSVPs_Public` へ反映
7. **Reply**：受付メッセージ

   > 「出欠を受け付けました。訂正はもう一度ボタンを押してください。」

### 8.3 `WF-Remind`（未回答）

1. **Cron（毎日 18:00 JST）**
2. **Sheets Query**：`Events` から対象イベント抽出（締切前、かつ `remind_start`〜`remind_end`）
3. **差集合計算**：`Members`全員 − `RSVPs(event_id)`回答済み → **未回答者**
4. **LINE Multicast**：未回答者へボタンメッセージ送付

### 8.4 `WF-ProxyFAX`（代理）

1. **Form Trigger（事務局用）**：`event_id` / `member_id` / `status`
2. **Upsert**：`RSVPs`（`via=FAX代理`）
3. **Notion Upsert**

> 重要ノード：署名検証、エラーハンドリング、通知（メール/Slack）を要所に配置。

---

## 9. メッセージテンプレ（抜粋）

* 初回登録案内 / 出欠依頼 / リマインド / 受付完了 / 〆後のサンクス
  ※当面は本文例を利用。テンプレは運用で磨く。

---

## 10. セキュリティ & プライバシー

* **Webhook 署名検証**（`X‑Line‑Signature`）を全エンドポイントに実装。
* **登録URL**は**期限なし**だが、**上書き禁止**と**氏名確認の最終確認**で誤登録を防止。
* **個人情報**：`member_id` と `line_user_id` の紐付けはSheetsで管理。Notion公開DBへは**必要最小限（氏名・ステータス）**。
* **アクセス制御**：Notion公開URLは**会員のみ共有**（必要時URL変更）。

---

## 11. 運用手順（SOP）

1. **イベント登録**：`Events`に行追加（`event_id`/日時/締切/リマインド期間）
2. **配信**：テンプレを編集して一斉配信（**出席／欠席**ボタン付）
3. **モニタ**：`Views-*`で回答進捗・未回答者を確認
4. **FAX対応**：代理フォームで登録
5. **終了**：締切後に最終一覧を確認（必要ならPDF出力）

---

## 12. スケジュール（8/19デモ基準）

* **〜8/05**：LINE公式/Dev準備・Sheets雛形・n8n骨組み・Notion DB
* **8/06〜8/12**：ボタン配信テンプレ、リマインド、代理登録の通し動作確認
* **8/13〜8/18**：役員テスト→資料作成（1枚もの／スライド）→FAQ整備
* **8/19**：デモ（登録→ワンタップ回答→Notion一覧→自動リマインド）

---

## 13. テスト計画（要点）

* **登録**：

  * displayName一意一致→ID初期表示→最終は会員IDで確定
  * 不一致→空欄でID入力→登録成功
  * **既登録上書き禁止**の動作
* **回答**：

  * 出席/欠席→RSVPs Upsert→Notion反映→メッセ返答
  * 2回目回答で**上書き**
* **リマインド**：

  * 期間中18:00のみ、未回答者だけに送られる
  * 〆後は送られない
* **FAX代理**：

  * 事務局登録→一覧反映

---

## 14. リスクと対策

* **友だち追加未完了で配信不可**：説明会で登録を場内誘導（QR掲示＋その場テスト）。
* **誤紐付け**：**氏名確認の最終確認**＋**上書き禁止**で抑止。
* **Notion URL拡散**：URL変更・一時非公開で対応。
* **displayName依存過多**：補助のみ（空白除去一致時の初期表示）。最終は会員ID。

---

## 15. 環境変数（.env例・VPS/n8n）

```
LINE_CHANNEL_SECRET=***
LINE_CHANNEL_ACCESS_TOKEN=***
N8N_BASE_URL=https://awf.technavigation.jp  # 例
NOTION_API_KEY=***
NOTION_DATABASE_ID_RSVPS_PUBLIC=***
GOOGLE_SERVICE_ACCOUNT_JSON=***   # n8nでCredentials登録
TIMEZONE=Asia/Tokyo
```

---

## 16. 命名規約

* `event_id`: `EyyMMdd`（例：2025-08-25 → `E250825`）
* `status`: `attend`（出席） / `absent`（欠席）
* LINE postback payload: `action=rsvp&event_id=E250825&status=attend`

---

## 17. 変更履歴

* **v0.2（2025-07-31）**

  * 登録URL：**期限なし**に変更
  * **2ステップ登録**（ID入力→氏名確認→確定）に変更
  * **上書き禁止**（既登録はブロック）を明記
  * **レート制限/CAPTCHA**：**実装しない**
  * **リッチメニューへの登録項目**：**設置しない**
  * 出欠ボタン：**出席／欠席**（保留なし）
* v0.1（2025-07-31）初版


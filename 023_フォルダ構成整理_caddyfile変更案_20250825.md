【フォルダ構成整理】
フォルダ構成の整理とcaddyfileの見直しをAIに依頼しました。AIには細かな環境面が考慮できていない可能性もあるため、結果が妥当かチェックしてください。

# フォルダ、ファイルを示したログ（AIに提示したもの）

現状の構成です。
'''
root@x162-43-19-162:/opt/rcline# pwd
/opt/rcline
root@x162-43-19-162:/opt/rcline# ls -l
合計 300
-rw-r--r-- 1 root root 61591  8月 24 17:43 012_RC公式LINE設計書.md
-rw-r--r-- 1 root root 13622  8月 24 17:43 013_RC公式LINE開発環境構築ガイド.md
-rw-r--r-- 1 root root 18433  8月 24 17:43 016_開発の進め方.md
-rw-r--r-- 1 root root  5040  8月 24 17:43 020_実装記録_サイレント自動紐づけ_20250818.md
-rw-r--r-- 1 root root  5312  8月 18 13:55 021_作業ログ_20250802.md
-rw-r--r-- 1 root root  3702  8月 24 17:43 041_デバッグ手法メモ.md
-rw-r--r-- 1 root root 13140  8月 24 17:43 042_技術ノート_Docker環境_落穂ひろい.md
-rw-r--r-- 1 root root  2979  8月 24 17:43 043_技術ノート_ログ出力標準.md
-rw-r--r-- 1 root root  5804  8月 18 13:55 20250818_VPS環境メモ.txt
-rw-r--r-- 1 root root   799  8月 18 13:55 README.md
-rw-r--r-- 1 root root  2799  8月 24 17:43 VPS展開手順_Phase_A.md
drwxr-xr-x 2 root root  4096  8月 24 20:57 caddy
-rw-r--r-- 1 root root  1220  8月 24 17:50 docker-compose.yml
-rw-r--r-- 1 root root   372  8月 18 15:58 insert-test-data.sql
drwxr-xr-x 5 root root  4096  8月 24 17:50 logs
-rw-r--r-- 1 root root  4914  8月 24 17:43 migration_role_staff.sql
-rw-r--r-- 1 root root  4915  8月 21 11:44 migration_role_staff.sql.vps.backup
drwxr-xr-x 2 root root  4096  8月 24 19:10 old-configs
-rw-r--r-- 1 root root 98304  8月 18 15:58 rcline.db
drwxr-xr-x 2 root root  4096  8月 24 17:43 scripts
drwxr-xr-x 4 root root  4096  8月 18 13:55 services
-rw-r--r-- 1 root root  1153  8月 24 17:43 setup_admin_user.js
root@x162-43-19-162:/opt/rcline#
root@x162-43-19-162:/opt/rcline#
root@x162-43-19-162:/opt/rcline#
root@x162-43-19-162:/opt/rcline# ls -l scripts
合計 4
-rwxr-xr-x 1 root root 2796  8月 24 17:43 deploy-vps.sh
root@x162-43-19-162:/opt/rcline#
root@x162-43-19-162:/opt/rcline# ls -l services
合計 8
drwxr-xr-x 6 root root 4096  8月 24 17:43 api-server
drwxr-xr-x 2 root root 4096  8月 18 13:55 linehook
root@x162-43-19-162:/opt/rcline#
root@x162-43-19-162:/opt/rcline# ls -l services/api-server
合計 24
-rw-r--r-- 1 root root  338  8月 18 16:28 Dockerfile
drwxr-xr-x 2 root root 4096  8月 18 13:55 db
-rw-r--r-- 1 root root 1155  8月 24 17:43 package.json
drwxr-xr-x 3 root root 4096  8月 24 17:43 public
drwxr-xr-x 2 root root 4096  8月 24 17:43 scripts
drwxr-xr-x 5 root root 4096  8月 24 17:43 src
root@x162-43-19-162:/opt/rcline#
root@x162-43-19-162:/opt/rcline# ls -l services/linehook
合計 44
-rw-r--r-- 1 root root   131  8月 18 13:55 Dockerfile
-rw-r--r-- 1 root root  2969  8月 18 13:55 index.js
-rw-r--r-- 1 root root 29470  8月 18 13:55 package-lock.json
-rw-r--r-- 1 root root   163  8月 18 13:55 package.json
root@x162-43-19-162:/opt/rcline#
root@x162-43-19-162:/opt/rcline# cat docker-compose.yml
version: '3.8'

services:
  api-server:
    build:
      context: ./services/api-server
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - DATABASE_PATH=/app/data/rcline.db
      - FILES_PUBLIC_URL_BASE=https://awf.technavigation.jp/files
    volumes:
      - ./rcline.db:/app/data/rcline.db
      - ./logs:/app/logs
      - /var/www/files:/app/uploads  # ファイルアップロード用
    depends_on:
      - redis
    env_file:
      - .env.production

  linehook:
    build:
      context: ./services/linehook
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      - NODE_ENV=production
    depends_on:
      - redis
    env_file:
      - .env.production

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - redis_data:/data

  caddy:
    image: caddy:2
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
      - /var/www:/var/www  # 静的ファイル用
    depends_on:
      - api-server
      - linehook

volumes:
  redis_data:
  caddy_data:
  caddy_config:root@x162-43-19-162:/opt/rcline#
'''


以下、AIによる結果です。
---
いまの実体（/opt/rcline 配下、docker-compose の中身）を踏まえて、**/opt/rcline に完全集約**する形で “設計から” きれいに整える提案です。下の「結論 → 具体ファイル → 手順」の順でどうぞ。

---

# 結論（方針）

1. **パス集約**

* 静的/SPA と公開ファイル（画像等）を /opt/rcline にまとめます。

  * 静的/SPA: `/opt/rcline/www`（= /static/*, /rcline/*）
  * 公開ファイル: `/opt/rcline/files-public`（= /files/\*）
* これで `/var/www` 依存を解消できます。

2. **URL ルールの整理**

* API は `/api/*` の一本化。旧 `/rcline/api/*` は 301 で `/api/*` へリダイレクト（互換維持、後で削除）。
* それ以外は **404**（意図しない公開を防止）。

3. **いま使わないものは外す/コメント化**

* n8n は使わない → **Caddyfile 側ハンドラはコメントアウト**
* `linehook` サービスが不要なら **docker-compose から削除**（移行中なら残してコメント化でもOK）

---

# 具体ファイル（提案）

## 1. Caddyfile（/opt/rcline/caddy/Caddyfile）

```caddy
awf.technavigation.jp {

    # 圧縮と基本セキュリティヘッダ
    encode zstd gzip
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        Referrer-Policy "strict-origin-when-cross-origin"
    }

    # /files/* : 公開してよいファイル（画像等）
    handle_path /files/* {
        root * /opt/rcline/files-public
        file_server
        header Cache-Control "public, max-age=604800, immutable"
    }

    # /static/* : 配布用の静的ファイル（register.html 等）
    handle_path /static/* {
        root * /opt/rcline/www
        file_server
        header Cache-Control "public, max-age=3600"
    }

    # /rcline/* : SPA (LIFF/管理画面など)
    handle_path /rcline/* {
        root * /opt/rcline/www/rcline
        try_files {path} /index.html
        file_server
        header Cache-Control "no-cache"
    }

    # 旧URL /rcline/api/* → /api/* へ恒久リダイレクト（移行後に削除可）
    handle /rcline/api/* {
        @old path /rcline/api/*
        redir @old /api/{path./rcline/api/} 301
    }

    # API（本線）
    handle /api/* {
        reverse_proxy api-server:4000
    }

    # n8n は現状未使用（復活時に宛先を適宜変更）
    # handle_path /webhook/* {
    #     reverse_proxy n8n:5678
    # }

    # 旧 linehook を使わないなら削除（使うなら残す）
    # handle /linehook/* {
    #     reverse_proxy linehook:3000
    # }

    # デフォルト：想定外のパスは 404
    respond 404
}
```

> 変更点：`/var/www` をやめ、`/opt/rcline/files-public` と `/opt/rcline/www` へ集約。
> 旧 `/rcline/api/*` は 301 リダイレクトで互換維持。最後は 404。

---

## 2. docker-compose.yml（差し替え案）

**ポイント**

* caddy へのマウントを `/opt/rcline/www` と `/opt/rcline/files-public` に変更
* api-server のアップロード先を `/opt/rcline/files-public` へ（従来 `/var/www/files` だった箇所）
* `linehook` を使わないならサービス削除（ここではコメントアウト例を記載）
* `depends_on` も整理

```yaml
version: '3.8'

services:
  api-server:
    build:
      context: ./services/api-server
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - DATABASE_PATH=/app/data/rcline.db
      - FILES_PUBLIC_URL_BASE=https://awf.technavigation.jp/files
      # ↓ アップロード保存先（アプリ側で /app/uploads を参照しているなら合わせる）
      - UPLOADS_DIR=/app/uploads
    volumes:
      - ./rcline.db:/app/data/rcline.db
      - ./logs:/app/logs
      - ./files-public:/app/uploads          # ← /opt/rcline/files-public をコンテナに提供
    depends_on:
      - redis
    env_file:
      - .env.production

  # linehook を完全に使わないなら削除（移行中なら残す）
  # linehook:
  #   build:
  #     context: ./services/linehook
  #     dockerfile: Dockerfile
  #   restart: unless-stopped
  #   environment:
  #     - NODE_ENV=production
  #   depends_on:
  #     - redis
  #   env_file:
  #     - .env.production

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - redis_data:/data

  caddy:
    image: caddy:2
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
      - ./www:/opt/rcline/www:ro               # ← 静的/SPA をここから配信
      - ./files-public:/opt/rcline/files-public:ro
    depends_on:
      - api-server
      # - linehook   # 使わないなら外す

volumes:
  redis_data:
  caddy_data:
  caddy_config:
```

> 変更点：
>
> * **/var/www のマウントを撤廃**し、**./files-public と ./www** を Caddy に読ませます。
> * api-server 側は **./files-public → /app/uploads** へ RW で渡す想定（アプリがアップロードで使う）。
> * `FILES_PUBLIC_URL_BASE=https://awf.technavigation.jp/files` は Caddy の `/files/*` と一致。

---

# ディレクトリ作成（サーバ上）

```bash
cd /opt/rcline
sudo mkdir -p www/rcline files-public
# 必要なら既存の /var/www 配下の公開物を移行
# 例: sudo rsync -av /var/www/ files-public/
```

> 以後は、静的/SPA は `/opt/rcline/www/...`、公開ファイルは `/opt/rcline/files-public/...` に置く運用です。

---

# 反映手順（安全・簡潔）

```bash
cd /opt/rcline

# 1) 既存の Caddyfile をバックアップ
sudo cp -a caddy/Caddyfile caddy/Caddyfile.bak.$(date +%F-%H%M)

# 2) 上記 Caddyfile に置換（/opt/rcline/caddy/Caddyfile）
# 3) 上記 docker-compose.yml に置換（/opt/rcline/docker-compose.yml）

# 4) 初回だけ空ディレクトリを用意
sudo mkdir -p www/rcline files-public

# 5) 再起動
docker compose down
docker compose up -d --build

# 6) 動作確認
# 静的:
curl -I https://awf.technavigation.jp/static/any.txt
# SPA:
curl -I https://awf.technavigation.jp/rcline/
# ファイル:
curl -I https://awf.technavigation.jp/files/
# API:
curl -I https://awf.technavigation.jp/api/health || true
```

---

# よくある質問（今回の整理に絡むところだけ）

* **Q. `/var/www` のままでも動いていたが？**
  A. 動きますが、**プロジェクトが /opt/rcline に完結**している方が、バックアップ/権限/見通しがよく、将来の構成変更も安全です。

* **Q. アップロード先の実体はどこ？**
  A. ホスト側 `/opt/rcline/files-public` です。api-server コンテナ内では `/app/uploads` に見えます（compose の volumes で結合）。

* **Q. SPA 配信の置き場は？**
  A. `/opt/rcline/www/rcline`。ビルド成果物（`index.html`, `assets/*`）を置けば `/rcline/*` で配信されます。

* **Q. 旧 `/rcline/api/*` を使ってしまっている箇所がある**
  A. そのまま動きます（301で `/api/*` に案内）。フロントや外部連携が `/api/*` に切り替わったら、Caddy の旧APIブロックを削除してください。

---

# “ここまでやれれば完成” のチェックリスト

* [ ] `https://awf.technavigation.jp/static/register.html` が 200
* [ ] `https://awf.technavigation.jp/files/...jpg` が 200（何か1枚置いて確認）
* [ ] `https://awf.technavigation.jp/rcline/` が SPA（`index.html` にフォールバック）
* [ ] `https://awf.technavigation.jp/rcline/api/...` で 301 → `/api/...`
* [ ] `https://awf.technavigation.jp/api/line/webhook` がルーティングされる（署名なしでも 200 応答想定）
* [ ] 想定外パス（例 `/foo`）は 404

---

必要なら、\*\*api-server 側のアップロード保存パス（環境変数名や実装上のパス）\*\*まで合わせて点検し、確実に `/opt/rcline/files-public` に落ちるように微修正案も書けます。
この内容で進めて OK なら、次は **既存ファイルの移設（/var/www → /opt/rcline/**）**のコマンド例**を作ります。

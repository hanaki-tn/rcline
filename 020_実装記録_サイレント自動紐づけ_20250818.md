# RC公式LINE サイレント自動紐づけ実装記録

📅 **作業日**: 2025年8月18日  
🎯 **目的**: 公式LINE友だち追加時のサイレント自動紐づけ機能実装

## 実装完了事項

### ✅ 基本環境構築
- **ローカル開発環境**: Docker Compose（api-server, redis, caddy, linehook）
- **VPS本番環境**: 162.43.19.162 (awf.technavigation.jp)
- **リポジトリ**: https://github.com/hanaki-tn/rcline.git
- **データベース**: SQLite (設計書通りのスキーマ)

### ✅ サイレント自動紐づけ機能
- **エントリポイント**: `POST /api/line/webhook`
- **紐づけロジック**: `src/services/linker.js`
  - displayName正規化 (`name_key`との完全一致)
  - 空白除去・英字小文字化・NFKC無効
- **非同期処理**: Redis + Bull Queue
- **ログ出力**: `/app/logs/line/WEBHOOK-YYYY-MM-DD.ndjson`

### ✅ テスト・デバッグ機能
- **紐づけロジックテスト**: `npm run test-linking`
- **未紐づけユーザー抽出**: `npm run extract-unlinked-users`
- **データ確認**: `npm run check-members`
- **SQLite直接アクセス**: `sqlite3 /app/data/rcline.db`

### ✅ Google Sheets同期機能（骨格）
- **OAuth認証準備**: `npm run oauth-setup`
- **同期スクリプト**: `npm run sync-sheets`
- **環境変数**: GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET等

## 環境設定情報

### ローカル環境
```bash
# 起動
docker compose up --build -d

# 主要ポート
- api-server: 4000
- redis: 6379 (内部)
- caddy: 80, 443
```

### VPS環境
```bash
# パス
/opt/rcline/

# 起動
docker compose up --build -d

# 主要URL
- API: https://awf.technavigation.jp/api/
- Webhook: https://awf.technavigation.jp/api/line/webhook
```

### LINE Developers設定
- **Webhook URL**: `https://awf.technavigation.jp/api/line/webhook`
- **Client ID**: 487021331289-s3v512dpcf4hn6h1crb7bitolp6sea2q.apps.googleusercontent.com

### Google Cloud Console設定
- **承認済みリダイレクトURI**:
  - `https://awf.technavigation.jp/rest/oauth2-credential/callback`
  - `https://awf.technavigation.jp/oauth/callback`
  - `http://localhost:3001/oauth/callback`

## データベース構造

### members テーブル（重要）
```sql
-- テスト用データ例
id: 12053868
name: '花木 英雄'
name_key: '花木英雄'  -- 紐づけキー
line_user_id: NULL → 'U_xxxx' (自動設定)
line_display_name: NULL → '花木 英雄' (自動設定)
is_target: 1
role: 'admin'
```

## 運用手順

### 1. 通常動作確認
```bash
# VPS上で実行
docker compose logs api-server --tail=10
docker compose exec api-server npm run check-members
```

### 2. 未紐づけユーザー確認・手動対応
```bash
# 未紐づけユーザー抽出
docker compose exec api-server npm run extract-unlinked-users

# 手動紐づけ（SQLiteコンソール）
docker compose exec api-server sqlite3 /app/data/rcline.db
UPDATE members SET line_user_id = 'U_xxxx', line_display_name = '表示名' WHERE id = XXXX;
```

### 3. デバッグ・テスト
```bash
# 紐づけロジック単体テスト
docker compose exec api-server npm run test-linking

# Webhook疑似テスト
curl -X POST https://awf.technavigation.jp/api/line/webhook \
  -H "Content-Type: application/json" \
  -d "{\"events\":[{\"type\":\"follow\",\"source\":{\"userId\":\"U_test\"},\"timestamp\":$(date +%s)000}]}"
```

## 重要な設定項目

### 環境変数（.env）
```env
# 署名検証スキップ（開発・テスト用）
DEV_ALLOW_INSECURE=1

# サイレントモード
ONBOARDING_MODE=silent

# データベース・ファイル
DATABASE_PATH=/app/data/rcline.db
FILES_PUBLIC_URL_BASE=https://awf.technavigation.jp/files
```

### Docker Volume
- `sqlite_data`: データベース永続化
- `files_storage`: 画像ファイル保存
- `logs_storage`: ログファイル保存

## トラブルシューティング

### よくある問題
1. **Webhook受信できない**
   - Caddyfile: `awf.technavigation.jp` (HTTPS必須)
   - LINE署名検証: `DEV_ALLOW_INSECURE=1`で回避

2. **紐づけ失敗**
   - displayName取得失敗 → プロフィールAPI要確認
   - name_key不一致 → 正規化ロジック確認

3. **スクリプト反映されない**
   - `docker compose up --build -d` で再ビルド必須

### ログ確認方法
```bash
# APIサーバーログ
docker compose logs api-server --tail=20

# 友だち追加ログ
docker compose exec api-server sh -c "find /app/logs -name '*.ndjson' -exec cat {} \;"

# Redisキュー状況
docker compose exec redis redis-cli KEYS "*"
```

## 次のステップ（未実装）

### 優先度高
- [ ] Google Sheets本格同期（Refresh Token取得）
- [ ] 管理画面UI実装
- [ ] LIFF画面実装

### 優先度中
- [ ] イベント作成・配信機能
- [ ] audiences管理機能
- [ ] 本番環境での署名検証有効化

## 備考
- 設計書: `012_RC公式LINE設計書.md`
- 本記録: 継続開発の起点として活用
- VPS: n8nと併用可能（ポート分離済み）
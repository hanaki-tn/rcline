# RCå…¬å¼LINE ã‚µã‚¤ãƒ¬ãƒ³ãƒˆè‡ªå‹•ç´ã¥ã‘å®Ÿè£…è¨˜éŒ²

ğŸ“… **ä½œæ¥­æ—¥**: 2025å¹´8æœˆ18æ—¥  
ğŸ¯ **ç›®çš„**: å…¬å¼LINEå‹ã ã¡è¿½åŠ æ™‚ã®ã‚µã‚¤ãƒ¬ãƒ³ãƒˆè‡ªå‹•ç´ã¥ã‘æ©Ÿèƒ½å®Ÿè£…

## å®Ÿè£…å®Œäº†äº‹é …

### âœ… åŸºæœ¬ç’°å¢ƒæ§‹ç¯‰
- **ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒ**: Docker Composeï¼ˆapi-server, redis, caddy, linehookï¼‰
- **VPSæœ¬ç•ªç’°å¢ƒ**: 162.43.19.162 (awf.technavigation.jp)
- **ãƒªãƒã‚¸ãƒˆãƒª**: https://github.com/hanaki-tn/rcline.git
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: SQLite (è¨­è¨ˆæ›¸é€šã‚Šã®ã‚¹ã‚­ãƒ¼ãƒ)

### âœ… ã‚µã‚¤ãƒ¬ãƒ³ãƒˆè‡ªå‹•ç´ã¥ã‘æ©Ÿèƒ½
- **ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ**: `POST /api/line/webhook`
- **ç´ã¥ã‘ãƒ­ã‚¸ãƒƒã‚¯**: `src/services/linker.js`
  - displayNameæ­£è¦åŒ– (`name_key`ã¨ã®å®Œå…¨ä¸€è‡´)
  - ç©ºç™½é™¤å»ãƒ»è‹±å­—å°æ–‡å­—åŒ–ãƒ»NFKCç„¡åŠ¹
- **éåŒæœŸå‡¦ç†**: Redis + Bull Queue
- **ãƒ­ã‚°å‡ºåŠ›**: `/app/logs/line/WEBHOOK-YYYY-MM-DD.ndjson`

### âœ… ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½
- **ç´ã¥ã‘ãƒ­ã‚¸ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ**: `npm run test-linking`
- **æœªç´ã¥ã‘ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ½å‡º**: `npm run extract-unlinked-users`
- **ãƒ‡ãƒ¼ã‚¿ç¢ºèª**: `npm run check-members`
- **SQLiteç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹**: `sqlite3 /app/data/rcline.db`

### âœ… Google SheetsåŒæœŸæ©Ÿèƒ½ï¼ˆéª¨æ ¼ï¼‰
- **OAuthèªè¨¼æº–å‚™**: `npm run oauth-setup`
- **åŒæœŸã‚¹ã‚¯ãƒªãƒ—ãƒˆ**: `npm run sync-sheets`
- **ç’°å¢ƒå¤‰æ•°**: GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRETç­‰

## ç’°å¢ƒè¨­å®šæƒ…å ±

### ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ
```bash
# èµ·å‹•
docker compose up --build -d

# ä¸»è¦ãƒãƒ¼ãƒˆ
- api-server: 4000
- redis: 6379 (å†…éƒ¨)
- caddy: 80, 443
```

### VPSç’°å¢ƒ
```bash
# ãƒ‘ã‚¹
/opt/rcline/

# èµ·å‹•
docker compose up --build -d

# ä¸»è¦URL
- API: https://awf.technavigation.jp/api/
- Webhook: https://awf.technavigation.jp/api/line/webhook
```

### LINE Developersè¨­å®š
- **Webhook URL**: `https://awf.technavigation.jp/api/line/webhook`
- **Client ID**: 487021331289-s3v512dpcf4hn6h1crb7bitolp6sea2q.apps.googleusercontent.com

### Google Cloud Consoleè¨­å®š
- **æ‰¿èªæ¸ˆã¿ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURI**:
  - `https://awf.technavigation.jp/rest/oauth2-credential/callback`
  - `https://awf.technavigation.jp/oauth/callback`
  - `http://localhost:3001/oauth/callback`

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ 

### members ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆé‡è¦ï¼‰
```sql
-- ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ä¾‹
id: 12053868
name: 'èŠ±æœ¨ è‹±é›„'
name_key: 'èŠ±æœ¨è‹±é›„'  -- ç´ã¥ã‘ã‚­ãƒ¼
line_user_id: NULL â†’ 'U_xxxx' (è‡ªå‹•è¨­å®š)
line_display_name: NULL â†’ 'èŠ±æœ¨ è‹±é›„' (è‡ªå‹•è¨­å®š)
is_target: 1
role: 'admin'
```

## é‹ç”¨æ‰‹é †

### 1. é€šå¸¸å‹•ä½œç¢ºèª
```bash
# VPSä¸Šã§å®Ÿè¡Œ
docker compose logs api-server --tail=10
docker compose exec api-server npm run check-members
```

### 2. æœªç´ã¥ã‘ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªãƒ»æ‰‹å‹•å¯¾å¿œ
```bash
# æœªç´ã¥ã‘ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ½å‡º
docker compose exec api-server npm run extract-unlinked-users

# æ‰‹å‹•ç´ã¥ã‘ï¼ˆSQLiteã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼‰
docker compose exec api-server sqlite3 /app/data/rcline.db
UPDATE members SET line_user_id = 'U_xxxx', line_display_name = 'è¡¨ç¤ºå' WHERE id = XXXX;
```

### 3. ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒ†ã‚¹ãƒˆ
```bash
# ç´ã¥ã‘ãƒ­ã‚¸ãƒƒã‚¯å˜ä½“ãƒ†ã‚¹ãƒˆ
docker compose exec api-server npm run test-linking

# Webhookç–‘ä¼¼ãƒ†ã‚¹ãƒˆ
curl -X POST https://awf.technavigation.jp/api/line/webhook \
  -H "Content-Type: application/json" \
  -d "{\"events\":[{\"type\":\"follow\",\"source\":{\"userId\":\"U_test\"},\"timestamp\":$(date +%s)000}]}"
```

## é‡è¦ãªè¨­å®šé …ç›®

### ç’°å¢ƒå¤‰æ•°ï¼ˆ.envï¼‰
```env
# ç½²åæ¤œè¨¼ã‚¹ã‚­ãƒƒãƒ—ï¼ˆé–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨ï¼‰
DEV_ALLOW_INSECURE=1

# ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰
ONBOARDING_MODE=silent

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«
DATABASE_PATH=/app/data/rcline.db
FILES_PUBLIC_URL_BASE=https://awf.technavigation.jp/files
```

### Docker Volume
- `sqlite_data`: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ°¸ç¶šåŒ–
- `files_storage`: ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
- `logs_storage`: ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ
1. **Webhookå—ä¿¡ã§ããªã„**
   - Caddyfile: `awf.technavigation.jp` (HTTPSå¿…é ˆ)
   - LINEç½²åæ¤œè¨¼: `DEV_ALLOW_INSECURE=1`ã§å›é¿

2. **ç´ã¥ã‘å¤±æ•—**
   - displayNameå–å¾—å¤±æ•— â†’ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«APIè¦ç¢ºèª
   - name_keyä¸ä¸€è‡´ â†’ æ­£è¦åŒ–ãƒ­ã‚¸ãƒƒã‚¯ç¢ºèª

3. **ã‚¹ã‚¯ãƒªãƒ—ãƒˆåæ˜ ã•ã‚Œãªã„**
   - `docker compose up --build -d` ã§å†ãƒ“ãƒ«ãƒ‰å¿…é ˆ

### ãƒ­ã‚°ç¢ºèªæ–¹æ³•
```bash
# APIã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°
docker compose logs api-server --tail=20

# å‹ã ã¡è¿½åŠ ãƒ­ã‚°
docker compose exec api-server sh -c "find /app/logs -name '*.ndjson' -exec cat {} \;"

# Redisã‚­ãƒ¥ãƒ¼çŠ¶æ³
docker compose exec redis redis-cli KEYS "*"
```

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆæœªå®Ÿè£…ï¼‰

### å„ªå…ˆåº¦é«˜
- [ ] Google Sheetsæœ¬æ ¼åŒæœŸï¼ˆRefresh Tokenå–å¾—ï¼‰
- [ ] ç®¡ç†ç”»é¢UIå®Ÿè£…
- [ ] LIFFç”»é¢å®Ÿè£…

### å„ªå…ˆåº¦ä¸­
- [ ] ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆãƒ»é…ä¿¡æ©Ÿèƒ½
- [ ] audiencesç®¡ç†æ©Ÿèƒ½
- [ ] æœ¬ç•ªç’°å¢ƒã§ã®ç½²åæ¤œè¨¼æœ‰åŠ¹åŒ–

## å‚™è€ƒ
- è¨­è¨ˆæ›¸: `012_RCå…¬å¼LINEè¨­è¨ˆæ›¸.md`
- æœ¬è¨˜éŒ²: ç¶™ç¶šé–‹ç™ºã®èµ·ç‚¹ã¨ã—ã¦æ´»ç”¨
- VPS: n8nã¨ä½µç”¨å¯èƒ½ï¼ˆãƒãƒ¼ãƒˆåˆ†é›¢æ¸ˆã¿ï¼‰
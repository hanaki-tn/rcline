# LINE公式アカウントへのメッセージ送信（Flex Message）を、管理画面の「イベント作成」から行うための実装案

ChatGPTによる実装案です。参考にしてください。
実装方法については信じて良いですが、スクリプトの配置場所など、環境について、細かく把握せず、案として出していますので、あくまで参考です。

# 「イベント作成」→ LINE配信の送信実装を“公式準拠”に修正

## 目的

* 公式の **line-bot-sdk-nodejs** に準拠した **Flex メッセージ送信**を実装・修正する。
* 既存UI（`admin-demo.html` / `admin-script.js`）は極力変更せず、**サーバ側で送信を正規フローに差し替え**る。

## 参照（公式）

* LINE SDK (Node.js): [https://github.com/line/line-bot-sdk-nodejs](https://github.com/line/line-bot-sdk-nodejs)

  * `Client#pushMessage`, `Client#multicast`, `Client#replyMessage` を参照

## 必須ルール（現場で多発するエラー回避）

1. **画像URLは https 必須**（`http`や`data:`はNG → invalid uri scheme になる）
2. **Flex 構造はラップが正解**：`{ type:'flex', altText, contents: { type:'bubble'| 'carousel', ... } }`
3. **multicast は対象IDを分割送信**（上限対策。chunkサイズは150でOK/調整可）
4. `.env` に `CHANNEL_ACCESS_TOKEN` を設定して SDK を初期化

---

## 変更ファイル（追加OK）

* `src/line/flex-payload.js`（新規）
* `src/line/line-send.js`（新規）
* `routes/admin/events.js`（または相当の「イベント作成API」ルート内の送信箇所）

---

## 実装手順

### 1) 依存追加

```bash
npm i @line/bot-sdk
```

### 2) Flex ペイロード（公式構造）

```js
// src/line/flex-payload.js
export const buildEventFlex = ({ title, description, heroUrl, detailUrl }) => ({
  type: 'flex',
  altText: title || 'イベント案内',
  contents: {
    type: 'bubble',
    hero: {
      type: 'image',
      url: heroUrl,           // ← HTTPS必須
      size: 'full',
      aspectRatio: '20:13',
      aspectMode: 'cover',
      action: detailUrl ? { type: 'uri', uri: detailUrl } : undefined
    },
    body: {
      type: 'box',
      layout: 'vertical',
      contents: [
        { type: 'text', text: title, weight: 'bold', size: 'xl' },
        ...(description
          ? [{ type: 'text', text: description, size: 'sm', color: '#666666', wrap: true }]
          : [])
      ]
    }
  }
});
```

> Memo: Flex Simulator で作成した JSON は **`contents` にそのまま差し込む**運用でOK。

### 3) 送信ロジック（SDK）

```js
// src/line/line-send.js
import { Client } from '@line/bot-sdk';
import { buildEventFlex } from './flex-payload.js';

const client = new Client({ channelAccessToken: process.env.CHANNEL_ACCESS_TOKEN });

export async function sendEventFlexMulticast({ userIds, title, description, heroUrl, detailUrl }) {
  if (!Array.isArray(userIds) || userIds.length === 0) {
    return { success: 0, fail: 0 };
  }
  const message = buildEventFlex({ title, description, heroUrl, detailUrl });

  const CHUNK = 150; // 上限対策。必要に応じて調整
  let success = 0, fail = 0;

  for (let i = 0; i < userIds.length; i += CHUNK) {
    const slice = userIds.slice(i, i + CHUNK);
    try {
      await client.multicast(slice, message);
      success += slice.length;
    } catch (err) {
      // ここで err.response?.data などをログに残す
      fail += slice.length;
    }
  }
  return { success, fail };
}
```

### 4) ルート側で呼び出し（イベント作成API内）

```js
// routes/admin/events.js（抜粋・擬似コード）
import { sendEventFlexMulticast } from '../line/line-send.js';

router.post('/api/admin/events', upload.single('image'), async (req, res) => {
  try {
    // 1) フォーム値を取得
    const { title, body, target_member_ids, detail_url } = req.body;
    const memberIds = JSON.parse(target_member_ids || '[]');

    // 2) 画像を保存し、HTTPSでアクセス可能な公開URLを取得
    //    ※ saveAndGetHttpsUrl は既存の保存処理があればそれをラップしてOK
    const httpsImageUrl = await saveAndGetHttpsUrl(req.file); // 必ず https を返す

    // 3) 対象メンバーから line_user_id を引いて配列化（未紐づけは除外）
    const userIds = await findLineUserIdsByMemberIds(memberIds);

    // 4) 送信（ドライラン環境フラグがあるなら分岐）
    let pushStats = { success: 0, fail: 0 };
    if (process.env.DEV_PUSH_DISABLE !== '1') {
      pushStats = await sendEventFlexMulticast({
        userIds,
        title,
        description: body,
        heroUrl: httpsImageUrl,
        detailUrl: detail_url
      });
    }

    // 5) イベント作成・送信結果を返す（既存UIの想定に合わせる）
    return res.json({
      ok: true,
      event: { title, detail_url },
      targets: userIds.length,
      push: pushStats
    });
  } catch (e) {
    // エラー時のレスポンス（UIで表示される）
    return res.status(500).json({ ok: false, error: e.message });
  }
});
```

### 5) 環境変数（.env）

```env
CHANNEL_ACCESS_TOKEN=xxxxxxxxxxxxxxxx
# 開発用の誤送信防止（配信なしでAPIだけ通す）
DEV_PUSH_DISABLE=1
```

---

## 動作確認手順（最小）

1. `.env` に `CHANNEL_ACCESS_TOKEN` を設定
2. 画像を **JPG** でアップロード（**httpsで公開されるURL**に変換されること）
3. 少人数 audience を選び「イベント作成→送信」
4. サーバログに `multicast` のレスポンス/失敗時のエラー本文を記録
5. UI に `push.success` / `push.fail` が表示されること

---

## 参考（HTTP直叩きでの最小検証：任意）

SDKで難がある場合の一時検証用。

```js
// tools/send-flex-axios.js（任意）
import axios from 'axios';
const LINE_API = 'https://api.line.me/v2/bot/message';
const headers = {
  'Content-Type': 'application/json',
  Authorization: `Bearer ${process.env.CHANNEL_ACCESS_TOKEN}`,
};
export async function multicast(userIds, message) {
  return axios.post(`${LINE_API}/multicast`, { to: userIds, messages: [message] }, { headers });
}
```

> 送る `message` は上記 `buildEventFlex()` の戻り値。

---

## 受け入れ条件（Doneの定義）

* 画像URLが https で送られ、**invalid uri scheme が出ない**
* Flex 構造が公式に準拠（`type:flex` + `altText` + `contents` ラップ）
* `multicast` で分割送信され、成功/失敗件数がUIに表示
* `.env` 切替で **ドライラン**（DEV\_PUSH\_DISABLE=1）と **本番送信**（=0）が即座に切替可能

---

以上を反映してください。必要に応じて、Flex の `contents` を Simulator で作成した完成JSONに差し替えて構いません（`buildEventFlex()` の `contents` を置換）。

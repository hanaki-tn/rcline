n8nå°å…¥ãƒ¡ãƒ¢ï¼ˆDifyã‚µãƒ¼ãƒã‚’å†åˆ©ç”¨ï¼‰
==================================

ğŸ“… å®Ÿæ–½æ—¥ï¼š2025å¹´7æœˆ30æ—¥
ğŸ§‘ å®Ÿæ–½è€…ï¼šèŠ±æœ¨ è‹±é›„
ğŸ“ ã‚µãƒ¼ãƒæƒ…å ±ï¼š
- VPSï¼šã‚¨ãƒƒã‚¯ã‚¹ã‚µãƒ¼ãƒ VPS
- IPï¼š162.43.19.162
- ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼šawf.technavigation.jp
- OSï¼šUbuntu 22.04
- SSHæ¥ç¶šæ–¹æ³•ï¼šPuTTYï¼ˆid_ed25519_new.ppk ã‚’ä½¿ç”¨ï¼‰

Step 0. æ—¢å­˜Difyã®åœæ­¢ï¼ˆ80/443ç•ªãƒãƒ¼ãƒˆè§£æ”¾ï¼‰
----------------------------------------------
DifyãŒè‡ªå‹•èµ·å‹•ã—ãªã„ã‚ˆã†ã«ä»¥ä¸‹ã‚’å®Ÿè¡Œï¼š

docker stop docker-nginx-1 docker-api-1 docker-web-1 docker-worker-1 \
            docker-db-1 docker-redis-1 docker-sandbox-1 docker-ssrf_proxy-1 docker-weaviate-1

docker update --restart=no $(docker ps -a -q)
docker ps  # ç¢ºèª

Step 1. n8nå°å…¥æº–å‚™
--------------------
mkdir -p /opt/n8n/{data,caddy}
cd /opt/n8n
openssl rand -hex 32 > .encryption_key
chmod 600 .encryption_key
chown -R 1000:1000 /opt/n8n/data

Step 2. .env è¨­å®š
------------------
cat <<EOF > .env
DOMAIN=awf.technavigation.jp
N8N_ENCRYPTION_KEY=$(cat .encryption_key)
N8N_USER=admin
N8N_PASSWORD=ä»»æ„ã®å¼·ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
TZ=Asia/Tokyo
EOF

Step 3. docker-compose.yml ä½œæˆ
--------------------------------
cat <<'EOF' > docker-compose.yml
version: "3.8"
services:
  n8n:
    image: docker.n8n.io/n8nio/n8n:latest
    restart: unless-stopped
    environment:
      - N8N_HOST=${DOMAIN}
      - WEBHOOK_URL=https://${DOMAIN}/
      - N8N_PORT=5678
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - GENERIC_TIMEZONE=${TZ}
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD}
    volumes:
      - ./data:/home/node/.n8n

  caddy:
    image: caddy:latest
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile
      - ./caddy/data:/data
      - ./caddy/config:/config
    depends_on:
      - n8n
EOF

Step 4. Caddyfile è¨­å®šï¼ˆHTTPSå¯¾å¿œï¼‰
-------------------------------------
cat <<'EOF' > ./caddy/Caddyfile
awf.technavigation.jp {
    encode gzip
    reverse_proxy n8n:5678
}
EOF

Step 5. èµ·å‹•
-------------
docker compose --env-file .env up -d

# èµ·å‹•ãƒ­ã‚°ä¾‹ï¼š
# âœ” Container n8n-n8n-1    Started
# âœ” Container n8n-caddy-1  Started

Step 6. ã‚¢ã‚¯ã‚»ã‚¹
-----------------
ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ https://awf.technavigation.jp ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€
n8nã®åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ï¼ˆEmail / åå‰ / ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ï¼‰ã‚’ç¢ºèªã€‚

è£œè¶³
----
- n8nã®è¨­å®šå¤‰æ›´ã¯ /opt/n8n é…ä¸‹ã§è¡Œã†
- ã‚³ãƒ³ãƒ†ãƒŠæ›´æ–°ï¼šdocker compose pull && docker compose up -d
- æœ€åˆã« .env ã§è¨­å®šã—ãŸ Basic èªè¨¼ï¼ˆadmin / ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰ã‚’æ±‚ã‚ã‚‰ã‚Œã‚‹

==================================
 docker memoï¼ˆ2025.08.18ï¼‰
==================================

root@x162-43-19-162:/opt/n8n# cat docker-compose.yml
version: "3.8"
services:
  n8n:
    image: docker.n8n.io/n8nio/n8n:latest
    restart: unless-stopped
    environment:
      - N8N_HOST=${DOMAIN}
      - WEBHOOK_URL=https://${DOMAIN}/
      - N8N_PORT=5678
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - GENERIC_TIMEZONE=${TZ}
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD}
    volumes:
      - ./data:/home/node/.n8n
    env_file:
      - .env

  caddy:
    image: caddy:latest
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile
      - ./caddy/data:/data
      - ./caddy/config:/config
      - /opt/www:/opt/www:ro        # â˜…RCã®å…¬å¼LINEã§LIFFã‚’ä½¿ã†ãŸã‚ã«è¿½åŠ ã€‚ï¼ˆä¼šå“¡ç¢ºèªã®ãŸã‚ã«ã€é™çš„ç”»é¢ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ï¼‰
    depends_on:
      - n8n
root@x162-43-19-162:/opt/n8n#

==================================
 ã”å‚è€ƒï¼šå…¬å¼LINE webhook ï¼ˆä»¥å‰ã®ä»•æ§˜ã§ã€ãŠå‹é”ç™»éŒ²æ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹htmlã€‚å½“æ™‚ã¯ä¼šå“¡IDã‚’å…¥åŠ›ã•ã›ã€ãã‚Œã‚’n8nã«é€ã£ã¦ã„ãŸï¼‰
==================================
root@x162-43-19-162:/opt/n8n# cat /opt/www/register.html
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ä¼šå“¡IDç™»éŒ²</title>
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <style>body{font-family:sans-serif;padding:1.5rem;}</style>
</head>
<body>
  <h2>ä¼šå“¡IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
  <input id="member" type="text" placeholder="ä¾‹: A-001" style="width:100%;padding:8px">
  <button id="submit" style="margin-top:1rem;padding:8px 16px">ç™»éŒ²ã™ã‚‹</button>

  <script>
    // 1) LIFF åˆæœŸåŒ–
    liff.init({ liffId: "2007866921-qY9ZPxWN" }).then(() => {
      if (!liff.isLoggedIn()) { liff.login(); return; }

      document.getElementById('submit').onclick = async () => {
        const memberId = document.getElementById('member').value.trim();
        if (!memberId) { alert('ä¼šå“¡IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

        // 2) ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–ã‚Šå‡ºã—
        const profile = await liff.getProfile();             // â† userId å–å¾— :contentReference[oaicite:1]{index=1}
        const userId   = profile.userId;

        // 3) n8n STEP2 ã¸ POST
        const res = await fetch(
          "https://awf.technavigation.jp/webhook/register_step2",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              member_id: memberId,
              user_id  : userId
            })
          }
        );
        const txt = await res.text();
        alert(txt);               // n8n å´ã§ JSON è¿”ã™ãªã‚‰ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚„ç”»é¢é·ç§»ã«å¤‰æ›´å¯
        liff.closeWindow();       // LINE ã«æˆ»ã‚‹ï¼ˆä»»æ„ï¼‰
      };
    });
  </script>
</body>
</html>
root@x162-43-19-162:/opt/n8n#


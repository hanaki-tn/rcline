# RC公式LINE 開発の進め方

策定日: 2025年8月21日  
対象: サイレント自動紐づけ後の本格機能開発

## 基本方針

### 環境の位置づけ
- ローカル環境: 開発・単体テスト・UI確認
- VPS環境: 本番環境（HTTPS必須のため、LINE関連の最終確認もここで実施）

### 開発原則
1. 安全第一: 配信機能は早期実装、フラグで段階的有効化
2. ログ重視: NDJSON + 運用スクリプトでトラブル対応可能に
3. ローカル中心: UI・ロジック・DB更新はローカルで開発
4. 段階的リリース: フェーズごとに動作確認、VPSで最終検証

---

## 開発ロードマップ

### フェーズ0: 基盤整備（完了済み）
- サイレント自動紐づけ: VPS環境で動作確認済み  
- ログ・運用スクリプト: extract-unlinked-users.js等の基盤完成  
- DB設計変更: members.role staff対応、admin_users必須化

### フェーズ1: 管理画面基盤（データ閲覧系）

#### 1-1. A-LOGIN（管理者ログイン）
- 機能: admin_users認証、Cookieセッション + CSRF
- 実装: 連続失敗ロック、成功後はイベント作成画面へ遷移
- テスト: ローカルでUI/セッション確認

#### 1-2. A-MEMBERS（会員参照）
- 機能: members一覧表示（参照のみ、編集なし）
- 表示項目: id, name, display_order, role, line_user_id有無, is_target, line_display_name
- テスト: CLI同期 → 画面反映確認

#### 1-3. A-AUDIENCE（audiencesマスタ + 所属割当）
- 機能: CRUD + 会員の所属ON/OFF（role='member'のみ表示）
- UI: ONのみ表示トグル、インクリメンタルフィルタ
- テスト: audience_members データ作成・確認

完了条件: ログイン→Members参照→Audiences CRUD/割当がJST表示・名簿順で正常動作

#### 実装結果 2025.08.21 15:50
● フェーズ1完了！ ✅

  実装完了事項

  1-1. A-LOGIN（管理者ログイン） ✅

  - 機能: admin_users認証、セッション管理、連続失敗ロック
  - セキュリティ: bcryptパスワード、5回失敗で10分ロック
  - テスト結果: hanaki/vLJCUJ でログイン成功確認

  1-2. A-MEMBERS（会員参照） ✅

  - 機能: members一覧表示（参照のみ）
  - フィルタ: role（member/staff）、line_user_id有無
  - テスト結果: 42名の会員データ表示、staff除外可能

  1-3. A-AUDIENCE（audiencesマスタ管理） ✅

  - 機能: CRUD（作成・読取・更新・削除）
  - 所属管理: メンバーの割当・削除（PUT /audiences/:id/members）
  - テスト結果: 「理事会」audience作成成功

  フェーズ1統合テスト

  最後に、フェーズ1の完了条件を満たしているか確認します：

  完了条件: ログイン→Members参照→Audiences CRUD/割当がJST表示・名簿順で正常動作

  各機能の連携テスト

  1. ログイン認証: ✅ hanaki アカウントでセッション確立
  2. 会員参照: ✅ display_order順で名簿表示、JST時刻
  3. audiences CRUD: ✅ 理事会作成・一覧取得
  4. role='member'フィルタ: ✅ staff除外機能

  API エンドポイント動作確認

  - POST /api/admin/login ✅
  - GET /api/admin/me ✅
  - GET /api/admin/members ✅
  - GET /api/admin/audiences ✅
  - POST /api/admin/audiences ✅

---

### フェーズ2: イベント機能（登録→プレビュー→集計）

#### 2-1. A-EVENT-NEW（イベント作成）
- 機能: 基本情報 + JPG必須 + 配信先選択 + 受信者プレビュー + 登録&送信
- 重要: 送信機能は初期実装するが、フラグでドライラン（ログのみ、LINE API呼ばない）
- 画像処理: オリジナル + プレビュー(1080px)の2種保存
- テスト: 
  - ローカル: ドライラン送信でログ・DB更新確認
  - VPS: 少人数audienceで実送信テスト

#### 2-2. A-EVENT-DETAIL（詳細・集計・CSV）
- 機能: 送信要約（成功/失敗件数） + 名簿順の最新出欠状況 + CSV出力（最新・履歴）
- データソース: event_push_stats + event_responses（最新行=現在値）
- テスト: 送信後の要約・状況表示の整合性確認

完了条件: イベント登録→受信者確定→ドライラン送信→詳細で要約/最新状態/CSVが整合

---

### フェーズ3: LIFF画面（会員向けUI）

#### 3-1. L-LIST（イベント一覧）
- 機能: 自分が対象のイベント一覧（未回答優先→開催日近い順）
- 認証: x-line-user-id ヘッダー
- 開発用: DEV_ALLOW_INSECURE=1時に x-dev-line-user-id ヘッダー受付

#### 3-2. L-DETAIL（イベント詳細・回答）
- 機能: 詳細表示 + 出席/欠席回答 + 状況/履歴確認（折りたたみ）
- 画像: プレビュー表示 + 全画面表示リンク
- 追記型回答: 何度でも可能、最新が現在値

#### 3-3. L-REGISTER（セルフ登録）
- 機能: 未紐づけ者向け氏名入力 + name_key完全一致照合
- 安全策: 既紐づけは上書き禁止

完了条件: 会員（擬似でも可）が一覧/詳細で回答→履歴が追記型で反映

---

## 開発環境の使い分け

### ローカル環境での開発
```bash
# 起動
docker compose up --build -d

# 開発用設定
DEV_ALLOW_INSECURE=1          # 署名検証スキップ
ONBOARDING_MODE=silent        # サイレント紐づけ
DEV_PUSH_DISABLE=1           # 送信無効化（ドライラン）
```

用途:
- 管理画面UI・バリデーション・DB更新の開発
- LIFF画面の開発（x-dev-line-user-id で擬似認証）
- 送信ロジックのドライラン確認

### VPS環境での確認
```bash
# 場所: /opt/rcline/
# URL: https://awf.technavigation.jp/

# 本番用設定
DEV_ALLOW_INSECURE=0          # 署名検証有効
DEV_PUSH_DISABLE=0           # 送信有効
```

用途:
- LINE Webhook/LIFF の HTTPS 必須機能
- 実際の配信テスト
- サイレント自動紐づけの動作確認

---

## テスト戦略

### 単体テスト
```bash
# 紐づけロジック
npm run test-linking

# 会員データ確認
npm run check-members

# 未紐づけユーザー抽出
npm run extract-unlinked-users
```

### 結合テスト（ローカル）
```bash
# Webhook擬似テスト（ドライラン）
curl -X POST http://localhost:4000/api/line/webhook \
  -H "Content-Type: application/json" \
  -d "{\"events\":[{\"type\":\"follow\",\"source\":{\"userId\":\"U_test\"},\"timestamp\":$(date +%s)000}]}"
```

### E2Eテスト（VPS）
```bash
# 実際のWebhook確認
curl -X POST https://awf.technavigation.jp/api/line/webhook \
  -H "Content-Type: application/json" \
  -d "{\"events\":[{\"type\":\"follow\",\"source\":{\"userId\":\"U_test\"},\"timestamp\":$(date +%s)000}]}"

# 少人数配信テスト
# → 管理画面でテスト用audienceに実配信
```

---

## 運用準備・ログ確認

### ログ監視
```bash
# APIサーバーログ
docker compose logs api-server --tail=20

# 友だち追加ログ
docker compose exec api-server sh -c "find /app/logs -name '*.ndjson' -exec cat {} \;"

# 送信ログ確認
docker compose exec api-server sh -c "cat /app/logs/push/$(date +%Y-%m-%d).ndjson"
```

### 動作確認スクリプト
- check-members.js: 会員データ・紐づけ状況確認
- extract-unlinked-users.js: 手動対応が必要なユーザー抽出
- test-linking.js: 紐づけロジック単体テスト

---

## セキュリティ・リスク管理

### 開発時の注意点
- DEV_ALLOW_INSECURE=1: 開発時のみ使用、本番では必ず0
- DEV_PUSH_DISABLE=1: ローカル開発時の誤送信防止
- x-dev-line-user-id: 開発時のみ有効な擬似認証

### 本番投入前チェックリスト
- [ ] .env の管理者パスワード差し替え
- [ ] LINE_CHANNEL_SECRET等の本番トークン設定
- [ ] DEV_ALLOW_INSECURE=0 で署名検証有効化
- [ ] 少人数テスト配信で動作確認
- [ ] ログ出力・確認コマンドの動作確認

---

## 除外事項（初回実装では対象外）

### 優先度低（将来実装）
- Google Sheets自動同期: OAuth Refresh Token取得が必要
- オンボーディングinteractive化: ONBOARDING_MODE=interactive
- 管理画面でのMembers編集: CLI同期のみの方針維持

### 理由
- 核となる出欠機能の安定稼働を優先
- 運用負荷を最小化（手動同期で十分）
- 段階的な機能追加でリスク管理

---

## 次のステップ

**現在の状況**: フェーズ1完了 ✅ + Browser Interface対応完了 ✅

管理画面テスト用URL:
- 簡易版: http://localhost:4000/admin/simple-admin.html
- 完全版: http://localhost:4000/admin/admin-demo.html
- ログイン情報: hanaki / vLJCUJ

**ブラウザアクセス問題の解決** 2025.08.21 16:08
- 問題: ログインボタンが反応しない（CSP：Content Security Policyがインラインスクリプトをブロック）
- 解決: helmet設定でscriptSrc: ['unsafe-inline']を追加
- 確認: 両管理画面でログイン機能が正常動作

**現在の状況**: フェーズ1完了 ✅ + フェーズ2完了 ✅ + フェーズ3完了 ✅ + Docker環境改善完了 ✅

### フェーズ2-1: A-EVENT-NEW（イベント作成）完了 ✅ 2025.08.21 17:35

**実装完了事項**
- イベント作成API（POST `/api/admin/events`）
- 画像アップロード処理（JPG必須、オリジナル+プレビュー1080px生成）
- ドライラン送信機能（DEV_PUSH_DISABLE=1で模擬送信統計作成）
- 管理画面UI（配信対象選択、受信者プレビュー、イベント一覧）
- データベース修正：`event_targets`テーブルに`created_at`カラム追加

### フェーズ2-2: A-EVENT-DETAIL＋代理回答機能 完了 ✅ 2025.08.22 21:00

**実装完了事項**
- イベント詳細・集計表示（送信統計、出欠状況一覧）
- CSV出力機能（出欠状況エクスポート）
- 代理回答機能（管理者による会員代理出欠入力）
- `event_responses`テーブルに`via`カラム追加（'liff'|'admin'）
- プロキシ回答UI（出席・欠席ボタン、確認ダイアログ）
- 権限制御（イベント作成者のみ代理回答可能）

**VPS環境反映済み**：ALTER TABLE文適用完了

**技術ノート作成**：
- 042_技術ノート_Docker環境_落穂ひろい.md：Docker環境問題の根本原因分析と再発防止策
- 043_技術ノート_ログ出力標準.md：開発・本番環境でのログ出力方針統一

### フェーズ3: LIFF画面実装 🚧 2025.08.23 開始

#### 3-1. L-LIST（イベント一覧）完了 ✅ 2025.08.23 07:00

**実装完了事項**
- LIFF基盤構築（common.css, common.js, index.html）
- API仕様変更対応：表示条件拡張（自分が対象 OR 自分が作成したイベント）
- 並び順変更：開催日順（held_at ASC）
- 開発環境擬似認証（x-dev-line-user-id）
- レスポンシブデザイン（スマホ最適化）
- プルリフレッシュ対応

**技術ノート更新**：
- 042_技術ノート_Docker環境_落穂ひろい.md：srcディレクトリ問題の追記
- 013_RC公式LINE開発環境構築ガイド.md：LIFF開発手順の体系化

#### 3-2. L-DETAIL（イベント詳細・回答）完了 ✅ 2025.08.23 11:30

**実装完了事項**：
- イベント詳細表示（タイトル、日時、画像、説明）
- 出席・欠席回答機能（追記型、最新が現在値）
- 出欠状況一覧表示（🟢⚪✏️絵文字対応、折りたたみ）
- 回答履歴表示（折りたたみ）
- 凡例表示
- **レイアウト変更**：タイトル→日時→画像→コメント→現在回答状況→回答セクション（テキスト入力がボタンの上）
- **ナビゲーション改善**：「← 一覧」ボタンのみ（「詳細」「セルフ登録」ボタンを削除）

**API動作確認**：
- `GET /api/liff/events/:id`：イベント詳細取得
- `POST /api/liff/events/:id/response`：出席・欠席回答送信
- ボタン状態管理（対象外、開催終了、既回答による無効化）
- 権限チェック（event_targets + admin_users）

**UI/UX改善**：
- L-LIST画面のナビゲーションボタンを非表示化
- L-DETAIL画面を「← 一覧」ボタンのみに簡素化
- カード形式レイアウトでの要素順序最適化

#### 3-3. L-REGISTER（セルフ登録）完了 ✅ 2025.08.24

**実装完了事項**:
- 会員登録画面（氏名入力、登録、スキップボタン）
- 紐付け状態（`is_target`）による自動遷移
- 開発用テストボタン（GUI操作でユーザー切替）
- `/api/liff/me`エンドポイントで紐付け状態確認

---

## 本番環境移行計画 2025.08.24策定

### 基本方針
**早期通知開始を最優先**とし、最小限のテストで本番運用を開始。見栄えや管理画面の改善は運用しながら段階的に実施。

### Phase A: 最小限VPS移行（実施中 🚧 2025.08.25）

#### A-1. VPS環境への反映手順 ✅ 完了 2025.08.25

**1. URLパス変更対応** ✅
- 本番URL: `https://awf.technavigation.jp/rcline/*`
- 管理画面: `https://awf.technavigation.jp/rcline/admin/`
- LIFF画面: `https://awf.technavigation.jp/rcline/`
- API: `https://awf.technavigation.jp/rcline/api/*`

**実装内容**:
- Caddyfile: `uri strip_prefix /rcline` でパス変換
- API-Server修正は不要（Caddyで対応）
- 静的ファイル配信: `/var/www/rcline/`

**Caddyfile修正（実装済み）**:
```
awf.technavigation.jp {
    # RC LINE システム
    handle_path /rcline/files/* {
        root * /var/www
        file_server
    }
    
    handle /rcline/api/* {
        reverse_proxy api-server:4000
    }
    
    handle /rcline/* {
        reverse_proxy api-server:4000
    }
    
    # 既存システム（n8n等）
    handle_path /webhook/* {
        reverse_proxy n8n:5678
    }
    
    reverse_proxy n8n:5678
}
```

**API-Server修正**:
```javascript
// public ファイルのベースパス調整
app.use('/rcline', express.static('public'));
app.use('/rcline/api', apiRoutes);
```

**2. 環境変数の本番設定** ✅ 完了 2025.08.25
```bash
# VPS用 .env.production（設定済み）
NODE_ENV=production           ✅
FILES_PUBLIC_URL_BASE=https://awf.technavigation.jp/files  ✅
DEV_ALLOW_INSECURE=0          ✅ # 署名検証有効
DEV_PUSH_DISABLE=1            ✅ # 初期は配信無効でテスト
ONBOARDING_MODE=silent        ✅
DATABASE_PATH=/app/data/rcline.db  ✅
```

**解決した問題**:
- Docker環境での環境変数反映（リビルド必要）
- docker-compose.override.yml競合（VPSでは無効化）
- n8n不在によるCaddyエラー（デフォルトルート修正）

#### A-2. 配信機能の段階的有効化 🚧 実施中

**ステップ1: 配信なしテスト** ✅ API動作確認完了
```bash
DEV_PUSH_DISABLE=1  # 配信無効（設定済み）
```
- [x] API疎通確認（`/rcline/api/liff/me` 認証エラーで正常）
- [ ] 管理画面ログイン確認
- [ ] イベント作成（ドライラン）確認
- [ ] LIFF画面での紐付け確認
- [ ] 会員登録フロー確認

**ステップ2: 配信ありテスト**
```bash
DEV_PUSH_DISABLE=0  # 配信有効化
```
- [ ] テスト用audienceで小規模配信
- [ ] LINE受信確認
- [ ] LIFF遷移確認
- [ ] 出欠回答反映確認

#### A-3. セキュリティ設定

```bash
# 本番環境での必須設定
DEV_ALLOW_INSECURE=0              # 署名検証有効
ADMIN_USERNAME=production_admin    # 本番用管理者ID
ADMIN_PASSWORD=complex_password    # 強固なパスワード
SESSION_SECRET=production_secret   # 本番用セッションキー
JWT_SECRET=production_jwt_secret   # 本番用JWTキー
```

#### A-4. E2Eテスト項目（最小限）

**E2E（End-to-End）テスト**: ユーザーの実際の操作フローを最初から最後まで確認

1. **管理者フロー**
   - ログイン → イベント作成 → 配信実行 → 統計確認

2. **会員フロー**
   - LINE友だち追加 → 自動紐付け → 出欠回答 → 履歴確認

3. **配信フロー**
   - イベント配信 → LINE受信 → LIFF遷移 → 回答 → 反映確認

**Phase A 完了条件**: 小規模配信で上記E2Eテストが全て成功

---

### Phase B: 管理画面改善（運用しながら実施）

#### B-1. 代理回答機能の改善
- **現状**: テキスト入力不可
- **改善**: `extra_text_enabled=1`のイベントでテキスト入力対応

#### B-2. 「全会員」機能の実装
- **現状**: 「全員」選択で全audiences選択
- **改善**: 「全会員」で`members.role='member'`を直接選択
- **注意**: 「全会員」はaudiencesテーブルには登録しない

#### B-3. 会員の個別選択・追加
- **現状**: グループベースのみ
- **改善**: 
  - グループ選択後の個別除外機能
  - 名前検索による個別追加機能（実装難度により検討）

#### B-4. 管理画面のUI改善
- デモ画面からの正式版作成
- レイアウト最適化
- 使いやすさの向上

---

### 推奨作業順序

1. **Phase A 実施（1-2日）**
   - VPS環境構築
   - 配信なしテスト
   - 配信ありテスト（小規模）
   - 本番運用開始

2. **Phase B 実施（運用しながら）**
   - 優先度の高い機能から順次改善
   - ユーザーフィードバックを反映
   - 段階的なUI/UX改善

## Docker環境改善 完了 ✅ 2025.08.24

### 実施結果

**背景問題**: 
- 開発時にファイル変更が反映されない
- Caddy依存による起動失敗
- srcディレクトリのbind mount不足

**実施内容** 2025.08.24:

1. **docker-compose.override.yml作成・最適化** ✅
   - srcディレクトリのbind mount追加（即時反映）
   - 開発用環境変数の整理
   - Caddy依存関係の解消（profile制御）
   - 直接ポート4000アクセス対応

2. **メイン構成のクリーンアップ** ✅
   - linehookのCaddy依存を除去
   - 環境変数重複の整理
   - 開発・本番環境の明確な分離

3. **開発用API追加** ✅
   - `/api/liff/dev-config`エンドポイント
   - テスト用userIdの動的設定
   - フロントエンド開発支援機能

**改善結果**:
- ✅ ファイル変更の即時反映（src, public共に）
- ✅ Caddy停止時でも開発継続可能
- ✅ 開発効率の大幅改善
- ✅ 新規開発者の参画コスト削減
- ✅ 設定管理の体系化

**運用方法**:
```bash
# 日常開発（改善版）
docker compose up -d  # override.yml自動適用

# 本番相当テスト
docker compose --profile production up -d
```

**対処した問題**:
- 042_技術ノート_Docker環境_落穂ひろい.md記載の全問題を解決
- 013_RC公式LINE開発環境構築ガイド.mdを更新版に反映済み

---

## 参考資料
- 設計書: 012_RC公式LINE設計書.md
- 実装記録: 020_実装記録_サイレント自動紐づけ_20250818.md
- データベース変更: migration_role_staff.sql
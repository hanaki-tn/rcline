# LIFF開発とデバッグ手法

**作成日**: 2025-08-29  
**作成者**: Claude Code + hanaki-tn  
**対象**: LINE LIFF（LINE Front-end Framework）アプリ開発  

## 概要

本文書は、RC公式LINEシステムのLIFF認証問題解決過程で確立したデバッグ手法とノウハウを体系化したものです。LIFF開発特有の課題と効率的な解決方法を記録し、今後の開発・保守で活用できるようにします。

---

## 1. LIFF開発環境の基本構成

### 1.1 ファイル構造
```
services/api-server/public/liff/
├── common.css          # 共通スタイル
├── common.js           # フロントエンド共通JS（開発用）
├── common.vps.js       # VPS本番用JS
├── index.html          # イベント一覧画面
├── detail.html         # イベント詳細画面
└── register.html       # 会員登録画面
```

### 1.2 SDK読み込みパターン（重要）
```html
<!-- ✅ 正しいパターン（body終了直前） -->
<body>
    <!-- コンテンツ -->
    
    <!-- LIFF SDK（body終了直前に配置） -->
    <script
        charset="utf-8"
        src="https://static.line-scdn.net/liff/edge/2/sdk.js"
        onload="console.log('LIFF SDK loaded'); window.liffSdkLoaded = true;"
        onerror="console.error('LIFF SDK load FAILED'); window.liffSdkLoadError = true;">
    </script>
    <script src="common.js"></script>
</body>

<!-- ❌ 間違ったパターン（head内） -->
<head>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
```

**理由**: LIFF SDKはDOM完了後に読み込まれる必要がある

---

## 2. デバッグ機能の活用

### 2.1 画面デバッグUI（オンスクリーンログ）

**使い方**:
- 通常時: デバッグUI非表示（本番環境）
- `?debug=1`付きアクセス: デバッグUI表示

**アクセス方法**:
```
# 通常アクセス（デバッグUIなし）
https://liff.line.me/2007866921-LkR3yg4k

# デバッグアクセス（デバッグUI表示）
https://liff.line.me/2007866921-LkR3yg4k?liff.state=%2Frcline%2Fliff%2Findex.html%3Fdebug%3D1
```

### 2.2 デバッグログAPI

```javascript
// ログ出力（コンソール + 画面UI）
showDebugLog('メッセージ', 'info');    // 青: 情報
showDebugLog('エラー内容', 'error');   // 赤: エラー
showDebugLog('成功しました', 'success'); // 緑: 成功
showDebugLog('警告です', 'warn');      // 黄: 警告
```

### 2.3 CONFIG設定
```javascript
const CONFIG = {
    API_BASE: '/rcline',
    LIFF_ID: '2007866921-LkR3yg4k',
    showDebugUI: false,  // 本番環境では false
    isDev: false
};
```

---

## 3. よくある問題と解決法

### 3.1 LIFF SDK未読み込み問題

**症状**: `typeof liff === 'undefined'`エラー

**原因と対策**:
1. **SDKの配置位置**
   - ❌ `<head>`内 → ✅ `</body>`直前に移動

2. **CSPブロック**
   ```caddy
   # Caddyfile.vps
   header {
       Content-Security-Policy "script-src 'self' https://static.line-scdn.net"
   }
   ```

3. **ネットワーク問題**
   - onload/onerrorハンドラで診断
   - 開発者ツールのNetworkタブで確認

### 3.2 認証失敗パターン

**症状**: `LINE user id not available`

**診断手順**:
1. LIFF初期化確認
   ```javascript
   console.log('liff.isLoggedIn():', liff.isLoggedIn());
   console.log('liff.getProfile():', await liff.getProfile());
   ```

2. ヘッダ確認
   ```javascript
   // ✅ 正しいパターン
   headers['Authorization'] = `Bearer ${accessToken}`;
   headers['x-line-user-id'] = userId;
   
   // ❌ よくある間違い（マスクした値を送信）
   headers['Authorization'] = `Bearer ${accessToken.substring(0, 10)}...`;
   ```

### 3.3 キャッシュ問題

**LIFFアプリでのキャッシュクリア**:
1. URLパラメータ付加: `?v=20250829-1`
2. `liff.state`利用: `?liff.state=%2Fpath%3Fv%3Dxxx`
3. 開発者ツール: ハード再読み込み（通常ブラウザのみ）

---

## 4. トラブルシューティング手順

### 4.1 段階的切り分け方法

1. **LIFF SDK読み込み確認**
   ```javascript
   console.log('LIFF SDK loaded:', typeof liff !== 'undefined');
   console.log('window.liffSdkLoaded:', window.liffSdkLoaded);
   console.log('window.liffSdkLoadError:', window.liffSdkLoadError);
   ```

2. **LIFF初期化確認**
   ```javascript
   await liff.init({ liffId: CONFIG.LIFF_ID });
   await liff.ready;
   console.log('LIFF ready, logged in:', liff.isLoggedIn());
   ```

3. **認証ヘッダ確認**
   ```javascript
   const profile = await liff.getProfile();
   const accessToken = liff.getAccessToken();
   console.log('Profile:', profile);
   console.log('Token available:', !!accessToken);
   ```

4. **API通信確認**
   ```javascript
   const response = await apiRequest('/api/liff/me');
   console.log('API response:', response.status);
   ```

### 4.2 ログの確認場所

**フロントエンド**:
- ブラウザ開発者ツール → Console
- 画面デバッグUI（`?debug=1`時）

**サーバーサイド**:
- `docker compose logs -f api-server`
- Caddyアクセスログ: `/var/log/caddy/access.log`

**ファイル配信確認**:
```bash
# VPS上で実体確認
curl -s https://awf.technavigation.jp/rcline/liff/index.html | head -20
curl -s https://awf.technavigation.jp/rcline/liff/common.js | head -20

# ファイルハッシュ比較
sha256sum /opt/rcline/services/api-server/public/liff/common.js
curl -s https://awf.technavigation.jp/rcline/liff/common.js | sha256sum
```

---

## 5. 本番運用時の注意点

### 5.1 デバッグUIの制御

```javascript
// 本番環境設定
const CONFIG = {
    showDebugUI: false,  // 画面デバッグUI無効
    isDev: false         // 本番モード
};

// showDebugLog関数で自動制御
function showDebugLog(message, type = 'info') {
    const allowUI = CONFIG.showDebugUI || /(^|[?&])debug=1(&|$)/.test(location.search);
    console.log(`[DEBUG] ${message}`);  // コンソールは常に出力
    
    if (!allowUI) return;  // 本番では画面UI無効
    // ... 画面UI表示処理
}
```

### 5.2 ファイル管理

**VPS環境**:
- `common.vps.js` → `common.js` への手動コピーが必要
- Docker volume mount: `/opt/rcline/services/api-server/public`

### 5.3 セキュリティ考慮事項

- アクセストークンの完全送信（マスク表示は画面のみ）
- CSPによる外部スクリプトの適切な許可
- デバッグ情報の本番環境での非表示化

---

## 6. 参考情報

### 6.1 LIFF設定
- **LIFF ID**: `2007866921-LkR3yg4k`
- **エンドポイントURL**: `https://awf.technavigation.jp/rcline/liff`

### 6.2 関連ドキュメント
- [LINE Developers - LIFF](https://developers.line.biz/en/docs/liff/)
- `013_RC公式LINE開発環境構築ガイド.md`
- `044_技術ノート_DB初期化問題と対策_20250825.md`

### 6.3 公式参考実装
- `/reference/line-liff-v2-starter/` (LINE公式スターター)
- `/reference/liff-template-go/` (Go版テンプレート)

---

## 更新履歴

| 日付 | 更新者 | 内容 |
|------|--------|------|
| 2025-08-29 | Claude Code + hanaki-tn | 初版作成（LIFF認証問題解決を基に） |
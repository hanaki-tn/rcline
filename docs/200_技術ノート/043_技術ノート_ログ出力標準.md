# ログ出力方針

策定日: 2025年8月22日  
対象: RC公式LINE APIサーバー・管理画面

## 基本方針

### 1. ログレベル設計
- **ERROR**: システム異常、API失敗、DB接続エラー等
- **WARN**: 想定外の状況、リトライ、権限エラー等  
- **INFO**: 重要な処理開始・完了、API成功ログ
- **DEBUG**: 開発・デバッグ用詳細ログ（本番では無効）

### 2. 環境変数制御
```env
# 開発環境
LOG_LEVEL=DEBUG
NODE_ENV=development

# 本番環境  
LOG_LEVEL=INFO
NODE_ENV=production
```

### 3. 出力対象

#### 必須ログ（INFO以上、常時出力）
- **認証関連**: ログイン成功・失敗、権限エラー
- **API重要処理**: イベント作成、代理回答、送信成功・失敗
- **外部連携**: LINE API呼び出し、DB操作エラー
- **システム**: サーバー起動・停止、接続確立

#### デバッグログ（DEBUG、開発時のみ）
- **リクエスト詳細**: FormData内容、バリデーション詳細
- **処理追跡**: 関数開始・終了、中間処理状況
- **データ変換**: 日時変換、boolean変換等

### 4. ログ形式

#### サーバーサイド（console出力）
```js
// INFO以上
console.log(`[${new Date().toISOString()}] INFO: ユーザーログイン成功: ${username}`);

// ERROR
console.error(`[${new Date().toISOString()}] ERROR: イベント作成失敗:`, error);

// DEBUG（環境変数で制御）
if (process.env.LOG_LEVEL === 'DEBUG') {
  console.log(`[DEBUG] リクエスト内容:`, req.body);
}
```

#### フロントエンド（開発時のみ）
```js
// 開発環境でのみ有効
if (window.location.hostname === 'localhost') {
  console.log('[DEBUG] createEvent開始');
}
```

## 実装指針

### 1. ログ対象処理
- **認証**: ログイン・ログアウト・権限チェック
- **データ操作**: イベント作成・更新・削除、代理回答
- **外部API**: LINE送信、プロフィール取得
- **エラー処理**: バリデーション失敗、DB接続エラー

### 2. 除外対象
- **個人情報**: パスワード、トークン、会員詳細データ
- **冗長な情報**: 成功時の詳細レスポンス、正常なヘルスチェック
- **頻繁な処理**: 静的ファイル配信、軽微なバリデーション

### 3. エラー対応用ログ
```js
// API呼び出し時の必須ログ
console.log(`API呼び出し開始: ${endpoint}`);
try {
  const result = await apiCall();
  console.log(`API成功: ${endpoint} - ${result.status}`);
} catch (error) {
  console.error(`API失敗: ${endpoint} -`, error.message);
}
```

## 今後の拡張

- 本格運用時: ファイル出力（日付ローテーション）
- 監視システム連携: 構造化ログ（JSON形式）
- メトリクス収集: 処理時間、成功・失敗率

---

**目的**: 開発効率と運用安定性の両立  
**原則**: シンプル・必要十分・環境別制御
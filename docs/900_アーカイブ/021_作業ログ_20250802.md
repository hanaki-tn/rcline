# 作業ログ 📒 2025‑08‑03 — WF‑Register & LIFF

> RC‑Notice プロジェクトで実施した作業の詳細な時系列メモ。時刻はおおよそ JST。

## 概要

* 公式LINEアカウントをBotモードで作成し、無料プラン適用を確認
* Messaging APIチャネルとLINEログインチャネルを新規作成し、相互にリンク
* LIFFアプリを登録し、Deep Linkをあいさつメッセージに組み込み
* VPSに`register.html`を配置し、Caddyで`/static`ルーティングを設定
* PCおよびスマホ実機でDeep Link→会員ID入力フォームの動作を確認（userId取得成功）
* 次ステップ：`/register/step2` Webhook実装、Sheets更新、RSVPワークフロー

---

## 🕒 10:05 — キックオフ

* ChatGPT に「公式 LINE アカウント作成からリードしてほしい」と依頼。
* 前提整理（Google/Notion アカウント保持、VPS+n8n+Sheets 連携済み）。

## 🕒 10:25 — 公式アカウント／Bot 方針確定

* アカウント名を **「浦和北東ロータリークラブ」** と決定（事務局限定感を避けるため）。
* 無料プラン（1,000 通/月）で十分と確認。（その後、アカウントを作成し確認したところ、無料プランは200 通/月と判明）
* OA Manager › 応答設定を **Bot モード** に設定済みであることをキャプチャで確認。

## 🕒 11:10 — Messaging API チャネル新規作成

1. LINE Developers Console で **Provider: 浦和北東ロータリークラブ** を選択。
2. 「Messaging API」チャネルを新規作成。

   * チャネル名: *浦和北東ロータリークラブ*
   * カテゴリ: 非営利団体／団体
   * メールアドレス: 個人アドレスを登録
3. **チャネル ID / シークレット / アクセストークン(長期)** を控え。
4. 暫定 Webhook URL: `https://awf.technavigation.jp/line/follow` を入力し **Webhook ON**（Verify は後回し）。

## 🕒 12:00 — 登録フローを LIFF 方式に変更決定

* 課題: LINE in‑app browser では `x‑line-user-id` が渡らない。
* 解決: **LIFF + LINE ログインチャネル** で `liff.getProfile()` を使い `userId` 取得。
* 2 ステップ会員登録フロー（ID 入力→氏名確認）を LIFF で実装する方針を確定。

## 🕒 13:10 — LINE ログインチャネル作成 & Bot 連携

1. Provider 内で **LINE ログイン**チャネルを新規作成。

   * チャネル名: *浦和北東RC – 会員ログイン*
   * 仮 Callback URL: `https://awf.technavigation.jp/callback`
2. チャネル公開 → **チャネル ID / シークレット** を控え。
3. チャネル基本設定 › 友だち追加オプション › **リンクされた LINE 公式アカウント** に Messaging API チャネルを指定し保存。

## 🕒 13:35 — LIFF アプリ登録

1. LINE ログインチャネル › **LIFF** タブ → ［＋追加］。
2. 設定

   * タイプ: **Web App (Full)**
   * エンドポイント URL: `https://awf.technavigation.jp/static/register.html`
   * スコープ: profile
3. **LIFF ID** (`165xxxxxxxxx`) を取得。
4. チャネル基本設定で **LIFF アプリドメイン** に `awf.technavigation.jp` が自動登録されていることを確認。

## 🕒 14:10 — 静的 HTML 配置（register.html）

```bash
sudo mkdir -p /opt/www
nano /opt/www/register.html   # サンプルコード貼付 & LIFF_ID 差替
```

内容（要約）

```html
<script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
<script>
  liff.init({ liffId: "LIFF_ID" }).then(() => {
    if (!liff.isLoggedIn()) { liff.login(); return; }
    /* 省略 */
  });
</script>
```

## 🕒 14:30 — Caddy 設定に `/static` ハンドラ追加

* `/opt/n8n/caddy/Caddyfile` を編集:

```caddy
handle_path /static/* {
    root * /opt/www
    file_server
}
reverse_proxy n8n:5678
```

* `docker compose down && docker compose up -d` で再起動。

## 🕒 14:45 — Deep Link 確認（PC）

* ブラウザで `https://liff.line.me/LIFF_ID` → `register.html` 表示直後に LINE ログイン画面へ遷移 → **LIFF 起動を確認**。

## 🕒 15:10 — あいさつメッセージに Deep Link 設置

1. OA Manager › あいさつメッセージ

```
ご登録ありがとうございます！
▼会員ID入力はこちら
https://liff.line.me/LIFF_ID
```

2. 変更を保存・あいさつメッセージ ON。

## 🕒 15:30 — スマホ実機テスト

1. 公式アカウントを友だち追加 → あいさつメッセージ受信。
2. Deep Link タップ → LINE in‑app browser で **会員ID入力フォームが即表示**。
3. 会員IDを入力 → まだ n8n 連携前のため 404 だが **POST が送信されている**ことを Network Log で確認。

## 🕒 16:00 — 結果 & 次工程

* **テスト全項目 OK**（PC ログイン誘導 / スマホ即表示）。
* 次の作業：`/register/step2` Webhook, Sheets 更新ロジック, RSVP ワークフロー実装。

---

### To‑Do（次回）

*

---

> **備考**
>
> * VPS: Ubuntu 22.04 + Docker Compose /opt/n8n
> * n8n v1.26, Caddy v2.8.4
> * All timestamps JST (UTC+9)

# VPS セキュリティ運用メモ
## SSHポート変更手順（10022に変更）

### 1. 概要
- SSHのデフォルトポートは **22**。
- 世界中のボットは22番をスキャンし、不正ログインを試みる。
- ポートを **10022** に変更することで、スキャンの対象から外れ、攻撃ノイズが激減する。
- セキュリティ強化というより、**実用的な防御（不要な攻撃の排除）**。

---

### 2. リスク
1. **ログインできなくなる（ロックアウト）**
   - 新ポートのテスト前に22を閉じてしまうと、自分も入れなくなる。
   - 最悪はVPS管理画面の「コンソール」から修正可能。

2. **ツール設定忘れ**
   - PuTTYや自動スクリプトがあれば、ポート番号を変更する必要あり。

---

### 3. 手順

#### Step 1. 新ポートをファイアウォールで許可
```bash
ufw allow 10022/tcp
```

#### Step 2. sshd_configを編集
```bash
nano /etc/ssh/sshd_config
```
以下を追加（22は残す）：
```
Port 22
Port 10022
```
保存後リロード：
```bash
systemctl reload ssh
```

#### Step 3. 新ポートで接続テスト
別のターミナル/Puttyで:
```bash
ssh -p 10022 <ユーザ名>@<サーバIP>
```
→ ログインできることを確認。

#### Step 4. 旧ポートを閉じる
問題なければ設定から `Port 22` を削除して：
```bash
systemctl reload ssh
ufw delete allow 22/tcp
```

#### Step 5. fail2banの設定更新
`/etc/fail2ban/jail.local` を編集：
```ini
[sshd]
enabled  = true
port     = 10022
backend  = systemd

# 即BANルール（例）
maxretry = 1
findtime = 600
bantime  = 36000
ignoreip = 127.0.0.1/8
```
反映：
```bash
systemctl restart fail2ban
```

---

### 4. 確認コマンド
- 状態確認  
  ```bash
  fail2ban-client status sshd
  ```
- ログ確認  
  ```bash
  tail -f /var/log/fail2ban.log
  ```

---

### 5. ポイントまとめ
- **新旧ポートを併用してから切り替える**のが安全。
- 旧ポート22を閉じるのは最後。
- ロックアウトしてもVPS管理画面の「コンソール」から復旧可能。


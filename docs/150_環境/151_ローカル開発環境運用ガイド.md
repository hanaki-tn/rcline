# ローカル開発環境ガイド

## 環境構成の変更点

### 1. docker-compose.yml
- **Caddyをコメントアウト**: 直接ポートアクセス（`http://localhost:4000`）を使用
- **FILES_PUBLIC_URL_BASE**: `http://localhost:4000/files` に変更
- **DEV_PUSH_DISABLE**: 環境変数に追加（LINE送信を無効化）

### 2. アクセス方法
- **APIサーバー**: `http://localhost:4000`
- **LIFF画面**: `http://localhost:4000/liff/`
- **管理画面**: `http://localhost:4000/admin/admin.html`
- **管理画面（デモ）**: `http://localhost:4000/admin/admin-demo.html`

## 起動方法

```bash
# コンテナ起動
docker compose up -d

# ログ確認
docker compose logs -f api-server

# 停止
docker compose down
```

## テスト方法

### 1. LIFF画面テスト
ブラウザで以下にアクセス：
- 出欠回答: `http://localhost:4000/liff/detail.html?eventId=1`
- 会員登録: `http://localhost:4000/liff/register.html`

**注意**: 
- LINE認証はスキップされます
- 開発用ユーザーID（`U45bc8ea2cb931b9ff43aa41559dbc7fc`）が自動的に使用されます

### 2. Webhookテスト
用意されたスクリプトを使用：

```bash
# 友だち追加イベント
./local_scripts/test-webhook-local.sh follow

# メッセージイベント
./local_scripts/test-webhook-local.sh message

# ポストバックイベント
./local_scripts/test-webhook-local.sh postback
```

**注意**: `local_scripts/`フォルダはGit管理対象外です

### 3. 開発用ユーザーIDの変更
ブラウザのコンソールで：

```javascript
// 現在のユーザーID確認
window.debugLiff.getDevUserId()

// ユーザーID変更
window.debugLiff.setDevUserId('U_test_other_user')

// ユーザー情報確認
await window.debugLiff.getCurrentUser()
```

## 環境変数（.env）

重要な設定：
- `DEV_PUSH_DISABLE=1`: LINE送信を無効化
- `DEV_ALLOW_INSECURE=1`: 署名検証を無効化
- `NODE_ENV=development`: 開発モード

## ログ確認

```bash
# APIサーバーログ
docker compose logs -f api-server

# 特定のキーワードで絞り込み
docker compose logs api-server | grep ERROR
docker compose logs api-server | grep "LINE"
```

## VPS環境との違い

| 項目 | ローカル環境 | VPS環境 |
|------|------------|---------|
| URL | `http://localhost:4000` | `https://awf.technavigation.jp/rcline` |
| Caddy | 使用しない | 使用（リバースプロキシ） |
| LINE送信 | 無効（DEV_PUSH_DISABLE=1） | 有効 |
| 署名検証 | 無効（DEV_ALLOW_INSECURE=1） | 有効 |
| LIFF認証 | 疑似認証（固定ID） | 実認証 |

## トラブルシューティング

### ポート競合エラー
```bash
# 使用中のポート確認
lsof -i :4000

# プロセス停止
kill -9 <PID>
```

### データベース初期化
```bash
# SQLiteに接続
docker compose exec api-server sqlite3 /app/data/rcline.db

# テーブル確認
.tables
```

### キャッシュクリア
```bash
# Redisクリア
docker compose exec redis redis-cli FLUSHALL
```
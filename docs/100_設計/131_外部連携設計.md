# 3. 全体アーキテクチャに向けた「機能×連携」洗い出し（図の素案）

Claudeに渡して図化できるよう、\*\*機能ごとに“入口→処理→LINE連携→DB更新→出力”\*\*を並べます。
（不明・仮置きは《※要確認》で注記しています）

## A. 友だち追加 → 会員初期登録（サイレント自動紐づけ）

* 入口：ユーザーが公式LINEアカウントを友だち追加
* LINE連携：
  - LINEプラットフォームからWebhookイベント（followイベント）が送信される
  - `/api/line/webhook`エンドポイントでイベントを受信
  - HTTPヘッダー`X-Line-Signature`による署名検証を実施（改ざん防止）
* サーバー処理：
  1. Webhookイベントを受信後、非同期ジョブキュー（Bull Queue）に処理を登録
  2. `linkFollowProcessor`（processors/linkFollow.js）が非同期でジョブを処理開始
  3. LINE Profile API (`https://api.line.me/v2/bot/profile/{userId}`)を呼び出し、ユーザーの表示名（displayName）を取得
  4. 取得した表示名を`linker.js`の`normalizeName()`関数で正規化（全ての空白を除去、英字を小文字化）
  5. 正規化した名前を`members`テーブルの`name_key`カラムと完全一致で検索
  6. 一致する会員が1名のみ存在する場合、その会員にLINEユーザーIDを紐づけ
  7. 処理条件：イベント発生から24時間以内のみ処理、既に他のLINE IDと紐づけ済みの会員は上書きしない
  8. 重複一致（AMBIGUOUS）、不一致（UNMATCHED）、既存紐づけ（ALREADY_LINKED）の場合は処理停止
* DB：`members`テーブルをUPDATE（line_user_id、line_display_name、is_target=1、updated_atを更新）
* ログ：処理結果をNDJSON形式でログファイル（`/app/logs/line/WEBHOOK-YYYY-MM-DD.ndjson`）に記録
* 出力：何もしない（初回メッセージは送信しない）

## B. 会員がLINE連携を手動で実施（LIFF会員登録）

* 入口：ユーザーがLIFFアプリを起動した際、システムが未紐づけユーザーを検出して登録画面へ誘導
  - LIFFアプリ起動時（例：イベント一覧を開こうとした時）に、APIサーバーへ会員情報確認リクエストを送信
  - `/api/liff/me`エンドポイントでLINEユーザーIDと会員情報の紐づけ状態を確認
  - 未紐づけ（is_target=0）の場合、自動的に会員登録画面（register.html）へリダイレクト
* LINE連携：
  - LIFF SDKを使用してLINEユーザーのプロフィール情報（userId、displayName）を取得
  - 取得したユーザーIDを使って、既存の会員データベースとの紐づけ状態を確認
* 画面：会員登録画面（register.html）で氏名入力フォームを表示
  - 入力欄：お名前（漢字フルネーム）
  - ボタン：「登録」（紐づけ処理実行）、「スキップ」（登録せずに終了）
* サーバー処理：
  1. 登録ボタン押下時：POSTメソッドで`/api/liff/register`エンドポイントへ氏名データを送信
  2. サーバー側で受信した氏名を正規化処理（空白除去、英字小文字化）
  3. 正規化した氏名を`members`テーブルの`name_key`カラムと照合
  4. 完全一致する会員が1名のみ存在する場合、その会員レコードにLINEユーザーIDを紐づけ
  5. 重複や不一致の場合はエラーとして処理
* DB：`members`テーブルをUPDATE（line_user_id、line_display_name、is_target=1を設定）
* 出力：
  - 登録成功時：イベント一覧画面（index.html）へ自動遷移
  - エラー時：登録画面にエラーメッセージを表示（画面にとどまる）
  - スキップ時：LIFF画面を閉じる（liff.closeWindow()を実行）

## C. 出欠依頼メッセージ配信

* 入口：管理画面からイベント作成・配信操作
  - 管理者がイベント情報（タイトル、日時、詳細、画像）を入力
  - 配信対象となる会員を選択（全員または特定グループ）
  - 配信実行ボタンを押下（即時配信または予約配信を選択可能）
* LINE連携：
  - LINE Messaging APIを使用してメッセージを送信
  - 送信方式は対象人数により選択：
    - `pushMessage`：個別ユーザーへの送信（1名ずつ）
    - `multicast`：複数ユーザーへの一括送信（最大500名まで）
    - `narrowcast`：オーディエンス機能を使った大規模配信（※未実装）
  - アクセストークン（LINE_CHANNEL_ACCESS_TOKEN）を使用して認証
* サーバー処理：
  1. 管理画面から受信したイベント情報を元にメッセージペイロードを構築
  2. Flex Message形式（`flex-payload.js`の`buildEventFlexMessage()`）でリッチなレイアウトを生成
     - hero部：イベント画像（※現在不具合：画像URLの設定に問題あり）
     - body部：イベントタイトル、開催日時
     - footer部：「出欠を回答」ボタン（LIFFアプリへのリンク）
  3. LIFF URLにイベントIDをパラメータとして付与（例：`liff://xxxxx/detail?id=123`）
  4. 配信レート制御（LINE APIの制限を考慮してバッチ分割処理）
  5. 配信ジョブをキューに登録して非同期処理
* DB：
  - `events`テーブル：イベント情報を保存
  - `send_jobs`テーブル：配信ジョブの進行状況を記録（※未実装の可能性）
  - `send_results`テーブル：各ユーザーへの送信結果（成功/失敗）を記録（※未実装の可能性）
* 出力：会員のLINEトーク画面にFlex Messageを配信（画像付きカード形式で「出欠を回答」ボタンを表示）

## D. 出欠回答（メインフロー／LIFF）

* 入口：ユーザーがLINEトーク画面のメッセージから「出欠を回答」ボタンをタップしてLIFFアプリを起動
  - Flex Messageのボタン、またはリッチメニューからアクセス
  - URLパラメータでイベントID を受け取る（例：`detail.html?id=123`）
* LINE連携：
  - LIFF SDK（`liff.init()`）でLIFFアプリを初期化
  - 必要に応じて`liff.login()`でLINEログインを実行
  - `liff.getProfile()`でユーザープロフィール（userId、displayName）を取得
  - 取得したプロフィール情報をAPIサーバーへの認証に使用
* 画面：イベント詳細・出欠回答画面（`detail.html`）
  - イベント詳細情報（タイトル、日時、場所、説明）を表示
  - 回答済みの場合：現在の回答内容をメッセージで表示（例：「現在の回答：出席」）
  - 出欠選択ボタン：「出席」「欠席」の2択
  - 追加メモ入力欄（オプション）
* サーバー処理：
  1. LIFFからPOSTメソッドで`/api/liff/events/{id}/attendance`エンドポイントへ回答データを送信
  2. 送信データ：LINEユーザーID、イベントID、回答ステータス（attend/absent）、追加メモ（extra_text）
  3. サーバー側でLINEユーザーIDから会員情報を特定
  4. 未紐づけユーザーの場合は会員登録画面（register.html）へリダイレクト
  5. 紐づけ済みユーザーの場合は出欠情報を記録
* DB：`event_responses`テーブルへINSERT
  - event_id：イベントID
  - member_id：会員ID
  - status：'attend' または 'absent'
  - extra_text：追加メモ（任意）
  - via：'liff'（LIFF経由での回答）
  - responded_at：回答日時
* 出力：
  - 回答完了メッセージを画面に表示
  - （オプション）LINE Messaging APIで回答確認メッセージを送信することも可能（※現在は未実装）

## E. 代理回答（会員がLINE未登録でも対応）

* 入口：管理画面のイベント詳細ページから管理者が代理で出欠を登録
  - 管理者がイベント詳細画面を開き、会員一覧から対象者を選択
  - 出欠状態を手動で設定（出席/欠席）
* LINE連携：なし（LINE未登録会員も対象となるため）
* サーバー処理：
  1. 管理画面からPOSTメソッドで出欠データを送信
  2. 会員IDとイベントIDで対象を特定
  3. 管理者による代理回答であることを記録
* DB：`event_responses`テーブルへINSERT
  - event_id：イベントID
  - member_id：会員ID
  - status：'attend' または 'absent'
  - extra_text：管理者によるメモ（任意）
  - via：'admin'（管理画面経由での代理回答）
  - responded_at：登録日時
* 出力：
  - 管理画面の会員一覧に回答状態を即座に反映
  - （将来実装）LINE登録済み会員には確認通知を送信する可能性

## F. リマインド配信（未回答者）

* 《※将来実装予定》
* 想定機能：イベント開催前に未回答者へ自動リマインド送信

## G. 回答結果の集計・可視化

* 入口：管理画面のイベント詳細ページ
  - 管理者がイベント一覧から特定のイベントを選択
  - イベント詳細画面で出欠状況を確認
* LINE連携：なし（管理画面内での完結）
* サーバー処理：
  1. `event_responses`テーブルから該当イベントの全回答を取得
  2. 出席者数、欠席者数、未回答者数を集計
  3. 会員ごとの回答状態を一覧表示用に整形
  4. （将来実装）CSV形式でのエクスポート機能
* DB：`event_responses`テーブルを参照のみ（更新なし）
* 出力：
  - 出席/欠席の統計情報を表示
  - 会員ごとの回答状態一覧（LIFFからの回答/管理者代理回答を区別）
  - 未回答者のリストアップ

## H. ブロック（unfollow）・退会

* 入口：ユーザーが公式LINEアカウントをブロック
* LINE連携：
  - LINEプラットフォームからWebhookイベント（unfollowイベント）が送信される
  - `/api/line/webhook`エンドポイントでイベントを受信
* サーバー処理：《※現在は処理なし》
  - 将来的にはブロック状態をDBに記録する可能性
* DB：更新なし
* 出力：なし

## I. リッチメニュー

* 設定・管理：LINE Official Account Manager（OA Manager）で直接設定
* 内容：イベント一覧へのリンクなど、LIFFアプリへの導線を配置
* 《※APIでの動的切り替えは未実装》

---

## 図化用の共通ノード（Claude向け語彙）

* クライアント：User（LINEアプリ） / LIFF（Web）
* サーバ：API Server（Node/Express《※実装》） / DB（SQLite《※現状》）
* LINE：LINE App / LINE LIFF / LINE Messaging API / LINE Webhook
* ストレージ：Members / Events / Attendances / SendJobs / AuditLogs

### 代表シーケンス（D. 出欠回答）

1. User → LINE App：配信メッセージをタップ
2. LINE App → LIFF：LIFF起動（`liffId`）
3. LIFF → LINE：`liff.login()`（必要時）
4. LIFF → API Server：`POST /attendances`（idToken or userId, eventId, status）
5. API Server → LINE（任意）：`pushMessage`（回答確認）
6. API Server → DB：`attendances`にUPSERT
7. LIFF → User：完了画面

---

## メモ（確定済みおよび検討事項）

### 確定済み事項
* **サイレント自動紐づけのキー**：`name_key`（氏名を正規化：空白除去＋英字小文字化）による完全一致
* **初回メッセージ**：followイベント時には送信しない（LINE OA Managerで設定）
* **未紐づけユーザーの対応**：LIFF起動時に会員登録画面（register.html）へ誘導
* **署名検証**：本番環境では`DEV_ALLOW_INSECURE=0`で有効化が必要（※現在は課題あり）

### 要検討事項
* **Audience運用**：現在はmulticast使用、大規模配信時のnarrowcast導入は未定
* **ステージング環境**：開発用の別Channelは未設定（現在は本番Channelでテスト）
* **画像配信の不具合**：Flex Messageの画像URLが正しく設定されていない
* **LIFF遷移の不具合**：ボタンからLIFFアプリへの遷移が失敗する場合がある
* **配信ジョブ管理**：`send_jobs`/`send_results`テーブルは未実装の可能性

---

## 付録：外部連携図解のための補足資料（後で別資料に振り分けるなど、整理する必要あり）

  1. システム構成の明確化

  Dockerコンテナ構成（VPS環境）

  コンテナ構成:
  - api-server      : Node.js/Express APIサーバー（内部ポート: 4000）
  - redis          : Redis（Bull Queueジョブ管理用、内部ポート: 6379）
  - caddy          : リバースプロキシ/SSL終端（外部ポート: 80, 443）
  - linehook       : 旧Webhook処理サービス（移行中、内部ポート: 3000）

  ボリューム:
  - rcline.db      : SQLiteデータベース
  - logs           : ログファイル格納
  - /var/www/files : アップロード画像ファイル
  - caddy_data/config : SSL証明書等

  ポート番号とURL構成

  外部アクセス（HTTPS:443 / HTTP:80）→ Caddy → 内部サービス

  URL構成:
  - https://awf.technavigation.jp/api/admin/*   → api-server:4000（管理画面API）
  - https://awf.technavigation.jp/api/liff/*    → api-server:4000（LIFF API）
  - https://awf.technavigation.jp/api/line/*    → api-server:4000（LINE Webhook）
  - https://awf.technavigation.jp/files/*       → 静的ファイル配信（画像等）
  - https://awf.technavigation.jp/admin/*       → 管理画面（静的HTML）
  - https://awf.technavigation.jp/liff/*        → LIFF画面（静的HTML）

  主要エンドポイント一覧

  LINE Webhook:
  - POST /api/line/webhook                        # follow/unfollowイベント受信

  LIFF API:
  - GET  /api/liff/me                            # 会員情報取得
  - POST /api/liff/register                      # 会員登録（手動紐づけ）
  - GET  /api/liff/events                        # イベント一覧
  - GET  /api/liff/events/:id                    # イベント詳細
  - POST /api/liff/events/:id/response           # 出欠回答

  管理画面API:
  - POST /api/admin/login                        # ログイン
  - GET  /api/admin/events                       # イベント一覧
  - POST /api/admin/events                       # イベント作成
  - POST /api/admin/events/:id/proxy-response    # 代理回答

  2. 認証フローの詳細

  LIFF認証フロー

  1. LIFFアプリ起動
     ↓
  2. liff.init({liffId}) でLIFF SDKを初期化
     ↓
  3. liff.isLoggedIn() でログイン状態確認
     ↓ 未ログインの場合
  4. liff.login() でLINEログイン画面へ
     ↓
  5. liff.getProfile() でプロフィール取得
     - userId（LINEユーザーID）
     - displayName（表示名）
     ↓
  6. APIリクエスト時にHTTPヘッダーで送信
     - x-line-user-id: {userId}
     ↓
  7. サーバー側でrequireLineUserミドルウェアが検証
     - req.lineUserId に格納
     - membersテーブルと照合

  開発環境でのヘッダー認証

  開発環境（NODE_ENV=development）の場合：
  - x-dev-line-user-id ヘッダーを許可
  - LIFF SDK不要でテスト可能
  - 例: x-dev-line-user-id: U_test_user_123

  3. エラーハンドリング

  未紐づけユーザーの処理フロー

  1. LIFF起動（例：イベント一覧を開く）
     ↓
  2. /api/liff/me で会員情報確認
     ↓
  3. is_target=0（未紐づけ）を検出
     ↓
  4. register.html?from=events へリダイレクト
     ↓
  5. 氏名入力フォーム表示
     ↓
  6-A. 登録成功 → イベント一覧へ遷移
  6-B. 登録失敗 → エラーメッセージ表示（画面にとどまる）
  6-C. スキップ → LIFF終了

  署名検証失敗時の処理

  Webhook受信時：
  1. X-Line-Signatureヘッダーと計算値を比較
     ↓
  2-A. 一致 → 処理継続
  2-B. 不一致 → エラーログ記録
     ↓
  3. 常にHTTP 200を返す（LINEプラットフォーム仕様）

  ※現在の課題：
  - DEV_ALLOW_INSECURE=1 で署名検証をスキップ中
  - 本番環境での署名検証に問題あり

  その他のエラー処理

  API共通エラーレスポンス形式：
  {
    "code": "ERROR_CODE",
    "message": "エラーメッセージ"
  }

  主なエラーコード：
  - UNAUTHENTICATED : 認証失敗
  - NOT_FOUND       : リソース未発見
  - VALIDATION_ERROR: 入力値検証エラー
  - INTERNAL_ERROR  : サーバー内部エラー

  ---

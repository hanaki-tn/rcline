# 134_外部連携_実装マッピング資料

## 1. 概要

本資料は、RC公式LINEシステムにおけるLINE連携機能の実装詳細をマッピングしたものです。
設計書（131_外部連携設計.md）に記載された機能が、実際のコードのどこで実装されているかを明確にします。

**対象システム**: api-server（現行稼働システム）
**作成日**: 2025-01-04
**対象読者**: 開発者、保守担当者

## 2. システム構成図

### 2.1 Dockerコンテナ構成

```
┌─────────────────────────────────────────┐
│  インターネット（HTTPS:443）             │
└─────────────────────────────────────────┘
                    │
┌─────────────────────────────────────────┐
│  Caddy（リバースプロキシ/SSL終端）       │
│  設定: /caddy/Caddyfile.vps             │
└─────────────────────────────────────────┘
                    │
      ┌─────────────┴──────────────┐
      ↓                            ↓
┌──────────────────┐    ┌──────────────────┐
│  api-server:4000  │    │  redis:6379      │
│  Node.js/Express  │←→  │  ジョブキュー    │
└──────────────────┘    └──────────────────┘
      ↓
┌──────────────────┐
│  SQLite DB       │
│  /app/data/      │
└──────────────────┘
```

### 2.2 ネットワーク設定

- **外部URL**: https://awf.technavigation.jp
- **内部ネットワーク**: rcline（Dockerネットワーク）
- **ポートマッピング**:
  - Caddy: 80, 443（外部）
  - api-server: 4000（内部のみ）
  - redis: 6379（内部のみ）

## 3. LINE Webhook処理フロー

### 3.1 URLマッピング

| 外部URL | 内部転送先 | 処理内容 |
|---------|-----------|----------|
| https://awf.technavigation.jp/api/line/webhook | api-server:4000/api/line/webhook | Webhook受信 |
| https://awf.technavigation.jp/api/liff/* | api-server:4000/api/liff/* | LIFF API |
| https://awf.technavigation.jp/api/admin/* | api-server:4000/api/admin/* | 管理API |

### 3.2 ファイルパス対応表

#### Webhook処理

| 処理段階 | ファイルパス | 主な役割 |
|---------|-------------|----------|
| リバースプロキシ | `/caddy/Caddyfile.vps:35-37` | HTTPSリクエスト受信・転送 |
| アプリケーション起動 | `/services/api-server/src/index.js` | Express起動・ミドルウェア設定 |
| ルーティング | `/services/api-server/src/index.js:82` | `/api/line`を`lineRoutes`へ |
| Webhookハンドラ | `/services/api-server/src/routes/line.js:8-55` | イベント受信・検証・処理 |
| 署名検証 | `/services/api-server/src/routes/line.js:58-88` | HMAC-SHA256検証 |
| 非同期処理 | `/services/api-server/src/processors/linkFollow.js` | 友だち追加処理 |

### 3.3 処理シーケンス

```
1. LINEプラットフォーム
   ↓ POST https://awf.technavigation.jp/api/line/webhook
   ↓ Headers: x-line-signature, Content-Type: application/json
   
2. Caddy（/caddy/Caddyfile.vps）
   ↓ SSL終端
   ↓ `/api/*` → `api-server:4000`へ転送
   
3. Express.js（/services/api-server/src/index.js）
   ↓ express.json()でボディパース
   ↓ `/api/line`ルート判定
   
4. Webhookハンドラ（/services/api-server/src/routes/line.js）
   ↓ 署名検証（LINE_CHANNEL_SECRET使用）
   ↓ イベントタイプ判定
   
5. 非同期ジョブ追加
   ↓ Bull Queue（Redis使用）
   ↓ req.queue.linkFollow.add()
   
6. レスポンス返却
   → 常に { ok: true } を返却（200 OK）
```

## 4. LINE API送信処理フロー

### 4.1 メッセージ送信処理

| 処理内容 | ファイルパス | 説明 |
|---------|-------------|------|
| イベント作成API | `/services/api-server/src/routes/admin.js:700-1058` | 管理画面からのイベント作成 |
| SDK実装（新） | `/services/api-server/src/line/line-client.js` | @line/bot-sdk使用 |
| Flexメッセージ構築 | `/services/api-server/src/line/flex-payload.js` | メッセージペイロード作成 |
| 直接実装（旧） | `/services/api-server/src/routes/admin.js:969-1033` | axios使用（移行予定） |

### 4.2 送信フロー

```
1. 管理画面
   ↓ POST /api/admin/events（multipart/form-data）
   
2. イベント作成処理
   ↓ 画像アップロード
   ↓ DB保存（events, event_targets）
   
3. LINE送信
   ↓ 対象者のline_user_id取得
   ↓ multicast API呼び出し（150件ずつ分割）
   ↓ Flex Message送信
   
4. 結果記録
   → event_push_statsテーブル更新
```

## 5. 環境変数マッピング

### 5.1 LINE関連環境変数

| 環境変数名 | 用途 | 使用箇所 | 備考 |
|-----------|------|----------|------|
| LINE_CHANNEL_SECRET | Webhook署名検証 | `/routes/line.js:14` | Messaging APIチャネル用 |
| LINE_CHANNEL_ACCESS_TOKEN | API認証トークン | `/line/line-client.js:6`<br>`/routes/admin.js:974` | メッセージ送信用 |
| LIFF_ID | LIFFアプリID | `/public/liff/common.vps.js:11` | 2007866921-LkR3yg4k |
| DEV_ALLOW_INSECURE | 署名検証スキップ | `/routes/line.js:60` | 0=本番, 1=開発 |
| ONBOARDING_MODE | 紐付けモード | `/routes/line.js:38` | silent/interactive |

### 5.2 設定ファイル

- **本番環境**: `.env.production`
- **開発環境**: `.env`
- **Docker経由**: `docker-compose.yml`で環境変数を渡す

## 6. ログファイル配置

### 6.1 ログファイルパス

| ログ種別 | ファイルパス | 内容 |
|---------|-------------|------|
| Webhookログ | `/app/logs/line/WEBHOOK-YYYY-MM-DD.ndjson` | 友だち追加等のイベント |
| 登録ログ | `/app/logs/line/REGISTER-YYYY-MM-DD.ndjson` | LIFF手動登録 |
| アプリケーションログ | Docker標準出力 | console.log出力 |
| Caddyアクセスログ | `/var/log/caddy/access.log` | HTTPアクセスログ |

### 6.2 ログ確認コマンド

```bash
# APIサーバーのリアルタイムログ
docker compose logs -f api-server

# 直近100行のログ
docker compose logs api-server --tail=100

# Webhook処理のログを絞り込み
docker compose logs api-server | grep "LINE Webhook"

# 署名検証エラーの確認
docker compose logs api-server | grep "署名検証"

# LINE SDK送信ログ
docker compose logs api-server | grep "LINE SDK"

# NDJSONログファイルの確認
docker compose exec api-server sh -c "cat /app/logs/line/WEBHOOK-*.ndjson | jq ."

# 未紐付けユーザーの抽出
docker compose exec api-server npm run extract-unlinked-users
```

## 7. トラブルシューティング

### 7.1 よくあるエラーと対処

#### 署名検証エラー
```
ERROR: LINE署名検証失敗
```
**原因**: LINE_CHANNEL_SECRETの不一致
**対処**: 
1. `.env.production`のLINE_CHANNEL_SECRETを確認
2. LINE DevelopersでMessaging APIチャネルのChannel Secretを確認
3. 値が一致していることを確認

#### メッセージ送信エラー
```
[LINE SDK] 送信エラー: invalid uri scheme
```
**原因**: 画像URLがhttpsでない、またはアクセストークン不正
**対処**:
1. 画像URLがhttps://で始まることを確認
2. LINE_CHANNEL_ACCESS_TOKENの有効性を確認

#### 友だち追加が紐付かない
```
result: UNMATCHED
```
**原因**: displayNameとname_keyが一致しない
**対処**:
1. NDJSONログで正規化後の名前を確認
2. membersテーブルのname_keyと比較
3. 手動紐付けまたはLIFF登録を案内

### 7.2 デバッグコマンド集

```bash
# 環境変数の確認
docker compose exec api-server env | grep LINE

# DBの会員情報確認
docker compose exec api-server sqlite3 /app/data/rcline.db \
  "SELECT id, name, name_key, line_user_id FROM members WHERE line_user_id IS NOT NULL;"

# Redisキューの状態確認
docker compose exec redis redis-cli
> KEYS bull:*
> LLEN bull:linkFollow:wait

# プロセスの再起動
docker compose restart api-server

# 設定ファイルの確認
docker compose exec api-server cat /app/.env

# テスト送信（開発環境）
docker compose exec api-server node src/test-line-sdk.js
```

### 7.3 動作確認手順

1. **Webhook接続テスト**
   - LINE Developersコンソール → Webhook URL → 「接続確認」
   - 成功時：ログに`INFO: LINE Webhook受信開始`

2. **署名検証テスト**
   - 実際に友だち追加
   - ログで`INFO: LINE署名検証成功`を確認

3. **送信テスト**
   - 管理画面からテストイベント作成
   - 1名のみ選択して送信
   - ログで`[LINE SDK] 送信成功: 1件`を確認

## 8. 関連資料

- **設計書**: `131_外部連携設計.md` - 機能要件と概念設計
- **Webhook仕様**: `133_Webhookハンドラ設計.md` - Webhook処理の詳細設計
- **SDK移行仕様**: `029_LINE_SDK導入によるメッセージ送信改善_変更仕様.md`
- **LINE設定情報**: `018_LINE_Developers設定情報.md` - チャネル設定値

## 注意事項

- 本資料は実装変更時に都度更新が必要
- 環境変数の実際の値（トークン等）は記載していない
- セキュリティ上重要な情報は`.env.production`で管理
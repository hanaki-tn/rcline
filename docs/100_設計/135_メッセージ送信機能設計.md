# 135_メッセージ送信機能設計

## 1. 概要

### 1.1 目的
管理画面から公式LINEへ直接メッセージ（テキストまたは画像）を送信する機能を提供する。従来のFAX・メール配信をLINE配信に置き換える。

### 1.2 対象ユーザー
- 事務局（admin_users）
- 各委員長（admin_users）

### 1.3 主要機能
- テキストメッセージ送信
- 画像メッセージ送信
- 会員グループ（audiences）単位での送信
- 送信履歴の記録
- 開発環境での送信制御（DEV_PUSH_DISABLE対応）

---

## 2. 機能仕様

### 2.1 メニュー構成
```
管理画面メニュー（左から）：
[イベント作成] [イベント一覧] [メッセージ送信] [会員グループ作成] [会員グループ一覧] [会員一覧] [ログアウト]
```

### 2.2 画面仕様

#### 2.2.1 メッセージ送信画面（A-MESSAGE-SEND）

**レイアウト**：
```
┌─────────────────────────────────────┐
│ メッセージ送信                        │
├─────────────────────────────────────┤
│ 送信先：[▼理事会（12名）        ]     │
│ ☑ 送信者にも送信（推奨）               │
├─────────────────────────────────────┤
│ [テキスト] [画像] ← 画像がデフォルト   │
│                                      │
│ 《画像タブ》                          │
│ ┌─ 画像アップロード ─────────┐       │
│ │ [ファイル選択] または          │       │
│ │ ドラッグ&ドロップ             │       │
│ └─────────────────────────┘       │
│                                      │
│ 《テキストタブ》                      │
│ ┌────────────────────────┐        │
│ │メッセージを入力...            │        │
│ │                             │        │
│ └────────────────────────┘        │
│ 残り文字数：480/500                   │
│                                      │
│ [送信] ← テストモード時は横に🧪表示   │
└─────────────────────────────────────┘
```

**入力項目**：

1. **送信先**
   - 形式：ドロップダウン
   - 選択肢：audiences テーブルの全レコード
   - 表示形式：「{name}（{member_count}名）」
   - 並び順：audiences.sort_order 昇順
   - デフォルト：sort_orderが最小値のaudience

2. **送信者にも送信**
   - 形式：チェックボックス
   - デフォルト：ON
   - 説明：ログイン中の管理者にもメッセージを送信

3. **メッセージタイプ**
   - 形式：タブ切り替え
   - タブ：[テキスト] [画像]
   - デフォルト：画像タブ

4. **画像アップロード**（画像タブ選択時）
   - 対応形式：JPG, JPEG, PNG
   - サイズ上限：5MB
   - UI：ドラッグ&ドロップ + ファイル選択ボタン
   - プレビュー：アップロード後に縮小画像を表示

5. **テキスト入力**（テキストタブ選択時）
   - 形式：textarea
   - 文字数制限：500文字
   - 文字数カウンター表示

**バリデーション**：
- 送信先：必須選択
- 画像：JPGファイル必須（画像タブ選択時）
- テキスト：1文字以上（テキストタブ選択時）

**送信確認ダイアログ**：
```
「{audience_name}（{audience_count}名）に送信します。よろしいですか？」
※送信者込みの場合は実際の送信対象数を表示（重複排除済み）
[キャンセル] [送信]
```

### 2.3 送信処理仕様

#### 2.3.1 送信対象の決定
1. 選択されたaudienceのメンバー取得
2. 送信者のline_user_id取得（admin_users.member_id → members.line_user_id）
3. 重複排除（送信者が既にaudienceに含まれる場合）
4. 最終送信対象リスト作成

#### 2.3.2 送信処理フロー
```
1. フォームバリデーション
2. 画像アップロード処理（画像の場合）
   - オリジナル保存
   - プレビュー生成（幅1080px）
3. 送信対象リスト作成
4. message_logs レコード作成
5. LINE API送信処理
   - multicast優先、pushフォールバック
6. 送信結果の集計・保存
7. レスポンス返却
```

#### 2.3.3 DEV_PUSH_DISABLE対応
```javascript
if (process.env.DEV_PUSH_DISABLE === '1') {
  // 実際の送信は行わず、ログのみ出力
  console.log('[DEV] メッセージ送信をスキップしました');
  return { success_count: target_count, fail_count: 0 };
}
```

---

## 3. データベース設計

### 3.1 新規テーブル

```sql
CREATE TABLE message_logs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  type TEXT NOT NULL CHECK(type IN ('text', 'image')),
  message_text TEXT,                    -- テキストメッセージ内容
  image_url TEXT,                       -- 画像URL（オリジナル）
  image_preview_url TEXT,               -- プレビュー画像URL
  image_size INTEGER,                   -- 画像ファイルサイズ
  image_preview_size INTEGER,           -- プレビュー画像ファイルサイズ
  audience_id INTEGER,                  -- 送信先audience
  recipient_count INTEGER NOT NULL,     -- 送信対象者数
  sent_by_admin INTEGER NOT NULL,       -- 送信者
  sent_at TEXT NOT NULL,                -- 送信日時（JST ISO8601）
  success_count INTEGER DEFAULT 0,      -- 送信成功数
  fail_count INTEGER DEFAULT 0,         -- 送信失敗数
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  FOREIGN KEY(audience_id) REFERENCES audiences(id) ON UPDATE CASCADE,
  FOREIGN KEY(sent_by_admin) REFERENCES admin_users(id) ON UPDATE CASCADE
);

CREATE INDEX idx_message_logs_sent_at ON message_logs(sent_at);
CREATE INDEX idx_message_logs_sent_by_admin ON message_logs(sent_by_admin);
```

---

## 4. API設計

### 4.1 エンドポイント

#### POST /api/admin/messages/send
**目的**：メッセージ送信

**認証**：要（admin_users）

**リクエスト**：
- Content-Type: multipart/form-data

**パラメータ**：
```javascript
{
  type: 'text' | 'image',           // 必須
  message_text: string,             // text時必須
  image: File,                      // image時必須
  audience_id: number,              // 必須
  include_sender: boolean           // デフォルト: true
}
```

**レスポンス**：
```javascript
// 成功時
{
  success: true,
  message_log_id: number,
  recipient_count: number,
  success_count: number,
  fail_count: number
}

// エラー時
{
  success: false,
  error: string
}
```

#### GET /api/admin/messages/audiences
**目的**：送信先audience一覧取得

**レスポンス**：
```javascript
{
  audiences: [
    {
      id: number,
      name: string,
      member_count: number,
      sort_order: number
    }
  ]
}
```

---

## 5. ファイル構成

### 5.1 フロントエンド

#### admin.html
```html
<!-- メッセージ送信セクション追加 -->
<div id="message-send-section" class="card hidden">
  <h3>メッセージ送信</h3>
  
  <form id="message-form">
    <!-- 送信先選択 -->
    <div class="form-group">
      <label>送信先</label>
      <select id="message-audience" required></select>
      <label>
        <input type="checkbox" id="include-sender" checked>
        送信者にも送信（推奨）
      </label>
    </div>
    
    <!-- タブ切り替え -->
    <div class="tab-container">
      <div class="tab-buttons">
        <button type="button" class="tab-btn" data-tab="text">テキスト</button>
        <button type="button" class="tab-btn active" data-tab="image">画像</button>
      </div>
      
      <!-- テキストタブ -->
      <div id="text-tab" class="tab-content">
        <textarea id="message-text" placeholder="メッセージを入力..."></textarea>
        <div class="char-count">残り文字数: <span id="char-remaining">500</span>/500</div>
      </div>
      
      <!-- 画像タブ -->
      <div id="image-tab" class="tab-content active">
        <div class="file-upload-area">
          <input type="file" id="message-image" accept="image/jpeg,image/jpg,image/png">
          <div class="upload-placeholder">
            <p>画像をドラッグ&ドロップ または [ファイル選択]</p>
          </div>
          <div id="image-preview" class="hidden"></div>
        </div>
      </div>
    </div>
    
    <button type="submit" id="send-message-btn">送信</button>
  </form>
</div>
```

#### admin.js
```javascript
// メッセージ送信機能
async function loadMessageSendSection() {
  await loadAudiences();
  initMessageForm();
}

async function loadAudiences() {
  // audiences一覧取得・表示
}

function initMessageForm() {
  // フォーム初期化・イベント設定
}

function switchMessageTab(tabName) {
  // タブ切り替え処理
}

async function sendMessage() {
  // メッセージ送信処理
}
```

### 5.2 バックエンド

#### routes/admin.js
```javascript
// メッセージ送信エンドポイント
router.post('/messages/send', requireAuth, upload.single('image'), async (req, res) => {
  // メッセージ送信処理
});

// audience一覧取得
router.get('/messages/audiences', requireAuth, (req, res) => {
  // audiences + member_count を取得
});
```

#### line/message-sender.js（新規作成）
```javascript
// メッセージ送信ロジック
async function sendTextMessage(targets, text) {
  // テキストメッセージ送信
}

async function sendImageMessage(targets, imageUrl) {
  // 画像メッセージ送信
}

function buildMessageTargets(audienceId, includeSender, adminUserId) {
  // 送信対象リスト作成
}
```

---

## 6. 実装手順

### Phase 1: 基本機能実装
1. データベーススキーマ作成
2. バックエンドAPI実装
3. フロントエンド画面実装
4. テキスト送信機能
5. 画像送信機能

### Phase 2: 機能強化
1. エラーハンドリング強化
2. UI改善
3. 送信履歴表示機能（将来的）

---

## 7. テスト項目

### 7.1 機能テスト
- [ ] テキストメッセージ送信
- [ ] 画像メッセージ送信
- [ ] audience選択
- [ ] 送信者込み送信
- [ ] DEV_PUSH_DISABLE動作確認

### 7.2 バリデーションテスト
- [ ] 必須入力チェック
- [ ] ファイルサイズ制限
- [ ] 文字数制限
- [ ] 対応形式チェック

### 7.3 エラーケーステスト
- [ ] 送信失敗時の処理
- [ ] 部分送信失敗時の処理
- [ ] ネットワークエラー時の処理

---

## 8. 運用考慮事項

### 8.1 送信制限
- LINE API制限に準拠
- レート制限対応

### 8.2 ログ・監査
- 送信履歴の保持
- エラーログの記録

### 8.3 セキュリティ
- ファイルアップロードの制限
- XSS対策（テキスト入力）
- CSRF対策

---

以上の設計書に基づいて実装を進めることで、要求仕様を満たすメッセージ送信機能を構築できます。
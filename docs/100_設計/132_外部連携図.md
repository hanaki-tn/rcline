# 公式LINE出欠回答システム 外部連携図（Mermaidコード）

## 1. システム全体概要図

```mermaid
graph TB
    subgraph "外部サービス"
        LINE[LINE Platform]
        SHEETS[Google Sheets<br/>会員名簿]
    end
    
    subgraph "VPS環境 (awf.technavigation.jp)"
        subgraph "Caddyプロキシ層"
            CADDY[Caddy<br/>リバースプロキシ/SSL終端<br/>ポート: 80, 443]
        end
        
        subgraph "アプリケーション層"
            API[api-server<br/>Node.js/Express<br/>ポート: 4000]
            REDIS[Redis<br/>Bull Queue<br/>ポート: 6379]
        end
        
        subgraph "データ層"
            DB[(SQLite<br/>rcline.db)]
            FILES["ファイルストレージ<br/>/var/www/files"]
            LOGS["ログファイル<br/>/app/logs"]
        end
    end
    
    subgraph "クライアント"
        ADMIN[管理画面<br/>PCブラウザ]
        LIFF[LIFF画面<br/>LINE内ブラウザ]
        USER[会員<br/>LINEアプリ]
    end
    
    %% 外部連携
    LINE -.->|Webhook<br/>follow/unfollow| CADDY
    API -->|Profile API<br/>Messaging API| LINE
    API -.->|手動同期<br/>CLI| SHEETS
    
    %% 内部連携
    CADDY --> API
    API --> REDIS
    API --> DB
    API --> FILES
    API --> LOGS
    
    %% クライアント連携
    ADMIN --> CADDY
    USER --> LINE
    LINE --> LIFF
    LIFF --> CADDY
    
    %% スタイル
    classDef external fill:#1976d2,stroke:#0d47a1,stroke-width:2px,color:#ffffff
    classDef internal fill:#7b1fa2,stroke:#4a148c,stroke-width:2px,color:#ffffff
    classDef client fill:#388e3c,stroke:#1b5e20,stroke-width:2px,color:#ffffff
    
    class LINE,SHEETS external
    class CADDY,API,REDIS,DB,FILES,LOGS internal
    class ADMIN,LIFF,USER client
```

## 2. 友だち追加時の自動紐付けフロー

```mermaid
sequenceDiagram
    participant U as 会員
    participant L as LINE Platform
    participant C as Caddy
    participant A as api-server
    participant R as Redis/Bull Queue
    participant D as SQLite DB
    participant LOG as NDJSONログ
    
    Note over U,LOG: サイレント自動紐付け（非同期処理）
    
    U->>L: 友だち追加
    L->>C: POST /api/line/webhook<br/>follow event
    C->>A: プロキシ転送
    
    Note over A: 署名検証 (X-Line-Signature)
    A-->>A: HMAC-SHA256検証
    
    A->>R: 非同期ジョブ登録<br/>link_follow
    A->>L: 200 OK (即座に応答)
    
    Note over R,D: 非同期ワーカー処理開始
    R->>A: ジョブ処理開始
    A->>L: Profile API呼び出し<br/>displayName取得
    L->>A: プロフィール情報
    
    A-->>A: 名前正規化<br/>(空白除去・小文字化)
    A->>D: SELECT name_key完全一致
    
    alt 一致1名の場合
        A->>D: UPDATE members<br/>line_user_id設定<br/>is_target=1
        A->>LOG: 結果記録 (LINKED)
    else 不一致・曖昧・既存紐付けの場合
        A->>LOG: 結果記録 (UNMATCHED/AMBIGUOUS等)
    end
    
    Note over U: メッセージ送信なし（サイレント）
```

## 3. 出欠依頼メッセージ配信フロー

```mermaid
sequenceDiagram
    participant ADM as 管理者
    participant A as api-server
    participant D as SQLite DB
    participant R as Redis/Bull Queue
    participant L as LINE Platform
    participant U as 会員

    Note over ADM,U: イベント作成→配信
    
    ADM->>A: POST /api/admin/events<br/>(multipart/form-data)
    Note over A: 画像処理<br/>オリジナル+プレビュー生成
    A->>D: events INSERT
    A->>D: event_targets INSERT
    
    A->>R: 送信ジョブ登録<br/>(非同期)
    A->>ADM: 201 Created
    
    Note over R,U: 非同期送信処理
    R->>A: 送信ジョブ実行
    
    loop 対象会員ごと
        A->>L: Push/Multicast API<br/>画像+テキスト(LIFFリンク)
        L->>U: メッセージ配信
        A->>D: event_push_stats更新
    end
    
    A->>D: 送信結果集計
```

## 4. 出欠回答フロー（LIFF）

```mermaid
sequenceDiagram
    participant U as 会員
    participant L as LINE Platform
    participant LIFF as LIFF画面
    participant A as api-server
    participant D as SQLite DB
    
    Note over U,D: LIFF経由での出欠回答
    
    U->>L: メッセージのリンクタップ
    L->>LIFF: LIFF起動
    LIFF->>L: liff.init()<br/>liff.getProfile()
    L->>LIFF: userId, displayName
    
    LIFF->>A: GET /api/liff/me<br/>(x-line-user-id)
    A->>D: SELECT members WHERE line_user_id
    
    alt 未紐付け (is_target=0)
        A->>LIFF: 未紐付け応答
        LIFF->>LIFF: register.html?from=eventsへ遷移
        Note over LIFF: セルフ登録フロー
        LIFF->>A: POST /api/liff/register<br/>{full_name}
        A->>D: 名前照合・紐付け処理
        alt 紐付け成功
            A->>LIFF: 200 OK
            LIFF->>LIFF: index.htmlへ遷移
        else 紐付け失敗
            A->>LIFF: 404 NO_MATCH
            Note over LIFF: エラー表示・画面に留まる
        end
    else 紐付け済み (is_target=1)
        A->>LIFF: 会員情報返却
        LIFF->>A: GET /api/liff/events/:id
        A->>D: SELECT event詳細
        A->>LIFF: イベント詳細+自分の回答状況
        
        U->>LIFF: 出席/欠席ボタンクリック
        LIFF->>A: POST /api/liff/events/:id/response<br/>{status, extra_text}
        A->>D: INSERT event_responses<br/>(via='liff')
        A->>LIFF: 200 OK
        LIFF->>U: 回答完了表示
    end
```

## 5. 代理回答フロー（管理画面）

```mermaid
sequenceDiagram
    participant ADM as 管理者
    participant A as api-server
    participant D as SQLite DB
    
    Note over ADM,D: LINE未登録会員への代理回答
    
    ADM->>A: GET /api/admin/events/:id
    A->>D: SELECT event詳細+出欠状況
    A->>ADM: イベント詳細画面表示
    
    Note over ADM: 会員一覧で代理回答ボタン表示<br/>（作成者のみ権限あり）
    
    ADM->>A: POST /api/admin/events/:id/proxy-response<br/>{member_id, status, extra_text}
    
    Note over A: 権限確認<br/>events.created_by_admin = session.adminUser.id
    
    A->>D: INSERT event_responses<br/>(via='admin')
    A->>ADM: 200 OK
    
    Note over ADM: 管理画面・LIFF画面で✏️マーカー表示
```

## 6. 未紐付けユーザーの自動誘導フロー

```mermaid
sequenceDiagram
    participant U as 未紐付け会員
    participant LIFF as LIFF画面
    participant A as api-server
    
    U->>LIFF: リッチメニュー「出欠回答」
    LIFF->>A: GET /api/liff/me
    A->>LIFF: is_target=0 (未紐付け)
    LIFF->>LIFF: location.href = 'register.html?from=events'
    
    Note over LIFF: 会員登録画面で氏名入力
    
    alt 登録成功
        LIFF->>LIFF: location.href = 'index.html'
    else 登録失敗
        Note over LIFF: エラーメッセージ表示・画面継続
    else スキップ
        LIFF->>LIFF: liff.closeWindow()
    end
```

## 7. LINE認証・連携の詳細フロー

```mermaid
sequenceDiagram
    participant U as 会員
    participant L as LINE Platform
    participant LIFF as LIFFアプリ
    participant A as api-server
    participant D as SQLite DB
    
    Note over U,D: LIFF認証とAPI連携
    
    U->>L: LIFFアプリ起動
    L->>LIFF: LIFFアプリロード
    
    LIFF->>L: liff.init({liffId})
    L->>LIFF: 初期化完了
    
    LIFF->>L: liff.isLoggedIn()
    
    alt 未ログインの場合
        LIFF->>L: liff.login()
        L->>U: LINEログイン画面
        U->>L: ログイン許可
        L->>LIFF: ログイン完了
    end
    
    LIFF->>L: liff.getProfile()
    L->>LIFF: {userId, displayName}
    
    Note over LIFF: HTTPヘッダーに設定<br/>x-line-user-id: {userId}
    
    LIFF->>A: APIリクエスト<br/>(x-line-user-id ヘッダー)
    
    Note over A: requireLineUserミドルウェア<br/>でユーザー検証
    
    A->>D: SELECT members WHERE line_user_id
    A->>LIFF: APIレスポンス
```

## 8. エラーハンドリングフロー

```mermaid
flowchart TD
    START([APIリクエスト受信]) --> AUTH{認証ヘッダー確認}
    
    AUTH -->|x-line-user-id なし| UNAUTH[401 UNAUTHENTICATED]
    AUTH -->|ヘッダーあり| DB_CHECK{DB照合}
    
    DB_CHECK -->|会員未登録| NOT_FOUND[404 NOT_FOUND]
    DB_CHECK -->|is_target=0| REDIRECT[未紐付け処理へ]
    DB_CHECK -->|is_target=1| PROCESS[正常処理続行]
    
    REDIRECT --> REGISTER[register.html表示]
    REGISTER --> INPUT{氏名入力}
    
    INPUT -->|登録ボタン| MATCH{名前照合}
    INPUT -->|スキップ| CLOSE["liff.closeWindow()"]
    
    MATCH -->|一致1名| SUCCESS[紐付け成功]
    MATCH -->|不一致/重複| ERROR[404 NO_MATCH]
    
    SUCCESS --> TARGET_UPDATE[is_target=1に更新]
    ERROR --> STAY[画面に留まる]
    
    TARGET_UPDATE --> EVENTS[イベント一覧へ]
    
    classDef error fill:#d32f2f,stroke:#b71c1c,stroke-width:2px,color:#ffffff
    classDef success fill:#388e3c,stroke:#1b5e20,stroke-width:2px,color:#ffffff
    classDef process fill:#1976d2,stroke:#0d47a1,stroke-width:2px,color:#ffffff

    class UNAUTH,NOT_FOUND,ERROR,STAY error
    class SUCCESS,TARGET_UPDATE,EVENTS success
    class REDIRECT,REGISTER,MATCH,PROCESS process
```

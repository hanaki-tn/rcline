# 212_ソフトウェアセキュリティ設計

**作成日**: 2025-01-15  
**対象範囲**: アプリケーション層・データベース層・認証層のセキュリティ  
**関連文書**: [211_VPSセキュリティ構成.md](./211_VPS_セキュリティ構成.md)（インフラ層）

## 1. 概要

### 1.1 目的
RC公式LINEシステムにおけるソフトウェア層のセキュリティ設計と実装状況を文書化し、セキュリティホールの予防と対策を明確にする。

### 1.2 対象範囲
- アプリケーションセキュリティ（Node.js/Express）
- データベースセキュリティ（SQLite）
- 認証・認可システム
- LINE API連携のセキュリティ
- セッション管理
- 入力値検証・出力エスケープ

### 1.3 セキュリティレベル
**対象**: 内部システム（管理者限定）+ 外部API連携（LINE）  
**重要度**: 高（個人情報・会員情報を扱う）

---

## 2. 認証・認可システム

### 2.1 管理画面認証

#### 実装方式
- **認証方式**: セッション認証（Cookie-based）
- **パスワードハッシュ**: bcrypt（ソルト付きハッシュ）
- **セッション管理**: express-session + SQLiteStore

#### セキュリティ対策

**✅ 実装済み対策:**
```javascript
// パスワードハッシュ化
const isValidPassword = await bcrypt.compare(password, user.password_hash);

// ログイン試行制限
const attemptCheck = checkLoginAttempts(username);
if (!attemptCheck.allowed) {
  return res.status(401).json({
    code: 'ACCOUNT_LOCKED',
    message: `アカウントがロックされています。${attemptCheck.remainingTime}秒後に再試行してください。`
  });
}
```

**セキュリティ機能:**
- アカウントロック機能（連続ログイン失敗時）
- セッション有効期限管理
- CSRF対策（SameSite Cookie設定）

### 2.2 LIFF認証

#### 実装方式
- **認証方式**: LINE IDトークン検証
- **トークン検証**: LINE公式SDKによる署名検証
- **プロフィール取得**: LINE Messaging API

#### セキュリティ対策
```javascript
// IDトークン検証例
const idToken = liff.getIDToken();
const profile = await liff.getProfile();
```

---

## 3. SQLインジェクション対策

### 3.1 対策状況: ✅ **完全対応済み**

#### プリペアードステートメントの一貫使用
```javascript
// ✅ 安全な実装例
// ログイン処理
'SELECT * FROM admin_users WHERE username = ?'
[username]

// データ挿入
'INSERT INTO audiences (name, sort_order, created_at, updated_at) VALUES (?, ?, ?, ?)'
[name, sortOrder, createdAt, updatedAt]

// データ更新
'UPDATE audiences SET updated_at = ? WHERE id = ?'
[updatedAt, id]
```

#### 危険なパターンの排除
```javascript
// ❌ 使用していない危険なパターン
`SELECT * FROM users WHERE name = '${userInput}'`  // 文字列結合
db.run("INSERT INTO table VALUES ('" + data + "')")  // 動的SQL
```

### 3.2 検証結果
**調査対象**: `/services/api-server/src/routes/admin.js`  
**結果**: 全SQLクエリでプリペアードステートメント使用確認  
**評価**: SQLインジェクション攻撃に対して安全

---

## 4. 入力値検証・出力処理

### 4.1 入力値検証（express-validator）

#### 実装例
```javascript
// ログイン時の検証
router.post('/login', [
  body('username').trim().isLength({ min: 1 }).withMessage('ユーザー名は必須です'),
  body('password').isLength({ min: 1 }).withMessage('パスワードは必須です')
], async (req, res) => {
  const errors = validationResult(req);
  if (!errors.isEmpty()) {
    return res.status(400).json({
      code: 'INVALID_INPUT',
      message: '入力エラー',
      details: errors.array()
    });
  }
});

// audience作成時の検証
body('name').trim().isLength({ min: 1, max: 100 }).withMessage('名前は1-100文字で入力してください'),
body('sort_order').optional().isInt({ min: 0 }).withMessage('ソート順は0以上の整数にしてください')
```

#### 検証項目
- **文字列長制限**: 各フィールドに適切な上限設定
- **データ型検証**: 数値・日付・真偽値の型チェック
- **必須項目検証**: 必要なフィールドの存在確認
- **文字エスケープ**: trim()による前後空白除去

### 4.2 ファイルアップロード対策

#### 画像ファイル検証
```javascript
// multerによるファイル制限
const upload = multer({
  dest: 'uploads/',
  limits: {
    fileSize: 5 * 1024 * 1024  // 5MB制限
  },
  fileFilter: (req, file, cb) => {
    // MIMEタイプチェック
    if (file.mimetype.startsWith('image/')) {
      cb(null, true);
    } else {
      cb(new Error('画像ファイルのみアップロード可能です'));
    }
  }
});
```

#### セキュリティ機能
- ファイルサイズ制限（5MB）
- MIMEタイプ検証（画像のみ）
- ファイル拡張子検証
- アップロード先ディレクトリの制限

---

## 5. LINE API連携セキュリティ

### 5.1 Webhook署名検証

#### 実装状況
```javascript
// LINE Webhook署名検証
const signature = req.headers['x-line-signature'];
const channelSecret = process.env.LINE_CHANNEL_SECRET;

// 署名検証ロジック（LINE SDKで実装）
if (!validateSignature(body, channelSecret, signature)) {
  return res.status(401).send('Unauthorized');
}
```

### 5.2 トークン管理

#### 環境変数による管理
```env
LINE_CHANNEL_ACCESS_TOKEN=<秘匿情報>
LINE_CHANNEL_SECRET=<秘匿情報>
LIFF_ID=<公開情報だが環境別>
```

#### セキュリティ対策
- 環境変数による秘匿情報管理
- `.env`ファイルのGit除外設定
- 本番・開発環境での分離管理

---

## 6. セッション・Cookie管理

### 6.1 セッション設定

#### セキュリティ設定
```javascript
app.use(session({
  secret: process.env.SESSION_SECRET,
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: process.env.NODE_ENV === 'production',  // HTTPS必須
    httpOnly: true,                                  // XSS対策
    maxAge: 24 * 60 * 60 * 1000,                    // 24時間
    sameSite: 'strict'                               // CSRF対策
  },
  store: new SQLiteStore({
    db: 'sessions.db',
    table: 'sessions'
  })
}));
```

### 6.2 CSRF対策

#### 実装方針
- **SameSite Cookie**: `strict`設定でCSRF攻撃を防止
- **Origin検証**: 必要に応じてOriginヘッダーチェック
- **認証済みユーザー限定**: 重要操作は認証必須

---

## 7. ログ・監査

### 7.1 セキュリティログ

#### 記録対象
```javascript
// ログイン失敗の記録
console.error(`[SECURITY] ログイン失敗 - Username: ${username}, IP: ${req.ip}, Time: ${new Date().toISOString()}`);

// 認証エラーの記録
console.error(`[SECURITY] 認証エラー - Endpoint: ${req.path}, User: ${req.session.adminUser?.username}, Time: ${new Date().toISOString()}`);
```

#### 監査対象
- ログイン成功・失敗
- 管理者操作（イベント作成・削除等）
- ファイルアップロード
- 異常なAPIアクセス

### 7.2 個人情報保護

#### ログ出力時の注意事項
```javascript
// ✅ 安全なログ出力
console.log(`[INFO] メッセージ送信完了 - 対象者数: ${recipientCount}名`);

// ❌ 危険なログ出力（個人情報含む）
console.log(`[INFO] 送信対象: ${memberNames.join(', ')}`);  // 名前を出力するのは避ける
```

---

## 8. 開発環境でのセキュリティ

### 8.1 開発時の安全機能

#### DEV_PUSH_DISABLE設定
```javascript
if (process.env.DEV_PUSH_DISABLE === '1') {
  console.log('[DEV] メッセージ送信をスキップしました');
  return { success_count: userIds.length, fail_count: 0 };
}
```

#### 目的
- 開発環境での誤送信防止
- テストデータの実環境流出防止

---

## 9. 脆弱性対策チェックリスト

### 9.1 OWASP Top 10 対策状況

| 脆弱性 | 対策状況 | 実装内容 |
|--------|----------|----------|
| **A01: Broken Access Control** | ✅ 対策済み | セッション認証・認可チェック |
| **A02: Cryptographic Failures** | ✅ 対策済み | bcryptパスワードハッシュ化 |
| **A03: Injection** | ✅ 対策済み | プリペアードステートメント |
| **A04: Insecure Design** | ✅ 対策済み | セキュアな設計原則に準拠 |
| **A05: Security Misconfiguration** | ✅ 対策済み | 適切なCookie・セッション設定 |
| **A06: Vulnerable Components** | ⚠️ 要監視 | 依存関係の定期的な更新が必要 |
| **A07: Identification and Authentication Failures** | ✅ 対策済み | ログイン試行制限・セッション管理 |
| **A08: Software and Data Integrity Failures** | ✅ 対策済み | LINE API署名検証 |
| **A09: Security Logging Failures** | ✅ 対策済み | セキュリティイベントのログ記録 |
| **A10: Server-Side Request Forgery** | 🟡 該当なし | 外部API呼び出しはLINE APIのみ |

### 9.2 定期的な確認項目

#### 月次チェック
- [ ] npm audit による脆弱性チェック
- [ ] アクセスログの異常パターン確認
- [ ] セッション有効期限の確認

#### 四半期チェック
- [ ] 依存関係パッケージの更新
- [ ] セキュリティパッチの適用
- [ ] ログイン試行制限の設定見直し

---

## 10. インシデント対応

### 10.1 セキュリティインシデント時の対応手順

#### 即座に実行する対応
1. **システム停止**: 必要に応じてサービス停止
2. **アクセス制限**: 該当IPアドレスのブロック
3. **ログ保全**: 関連ログの保存・確保
4. **影響範囲調査**: 被害状況の把握

#### 復旧後の対応
1. **原因分析**: 脆弱性の特定と修正
2. **再発防止策**: セキュリティ強化の実装
3. **監視強化**: ログ監視の強化
4. **文書更新**: 本設計書の更新

### 10.2 緊急連絡先
- **システム管理者**: [連絡先を記載]
- **開発責任者**: [連絡先を記載]

---

## 11. 今後の改善予定

### 11.1 短期的改善項目
- [ ] パスワード複雑性要件の追加
- [ ] 2FA（二要素認証）の導入検討
- [ ] CSP（Content Security Policy）の設定

### 11.2 長期的改善項目
- [ ] 侵入検知システム（IDS）の導入
- [ ] 脆弱性スキャンの自動化
- [ ] セキュリティ監査の定期実施

---

## 12. 参考資料

### 12.1 セキュリティガイドライン
- [OWASP Top 10](https://owasp.org/Top10/)
- [Node.js Security Checklist](https://blog.risingstack.com/node-js-security-checklist/)
- [Express.js Security Best Practices](https://expressjs.com/en/advanced/best-practice-security.html)

### 12.2 関連ツール
- **依存関係チェック**: `npm audit`
- **コード解析**: ESLint security rules
- **パスワードハッシュ**: bcryptjs

---

**最終更新**: 2025-01-15  
**次回見直し予定**: 2025-04-15（四半期レビュー）
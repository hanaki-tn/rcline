<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´° - RCå…¬å¼LINE</title>
    <link rel="stylesheet" href="common.css">
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“… ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°</h1>
        </div>

        <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="nav">
            <a href="index.html" class="nav-button">â† ä¸€è¦§</a>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div id="main-content">
            <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
            <div class="loading">
                <div class="spinner"></div>
                <div>ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆé–‹ç™ºç”¨ï¼‰ -->
        <div id="dev-info" class="d-none"></div>
    </div>

    <script src="common.js"></script>
    <script>
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿
        let currentUser = null;
        let eventData = null;
        let eventId = null;

        // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
        async function initPage() {
            try {
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆIDã‚’å–å¾—
                eventId = getUrlParameter('id');
                if (!eventId) {
                    showError('main-content', 'ã‚¤ãƒ™ãƒ³ãƒˆIDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                    return;
                }

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
                currentUser = await getCurrentUser();
                if (!currentUser) {
                    showError('main-content', 'èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚LINEã‹ã‚‰å†åº¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                // é–‹ç™ºç’°å¢ƒã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º
                if (CONFIG.isDev) {
                    const devInfo = document.getElementById('dev-info');
                    devInfo.classList.remove('d-none');
                    devInfo.innerHTML = `
                        <div class="message message-info">
                            <strong>é–‹ç™ºãƒ¢ãƒ¼ãƒ‰:</strong> ${currentUser.name || 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼'} (ID: ${currentUser.member_id || 'N/A'})
                            <br><strong>ã‚¤ãƒ™ãƒ³ãƒˆID:</strong> ${eventId}
                        </div>
                    `;
                }

                // ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°èª­ã¿è¾¼ã¿
                await loadEventDetail();

            } catch (error) {
                console.error('ãƒšãƒ¼ã‚¸åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showError('main-content', 'ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°èª­ã¿è¾¼ã¿
        async function loadEventDetail() {
            try {
                showLoading('main-content');
                
                const response = await apiRequest(`/api/liff/events/${eventId}`);
                eventData = await response.json();
                
                displayEventDetail(eventData);
                
            } catch (error) {
                console.error('ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                
                if (error.message.includes('403')) {
                    showError('main-content', 'ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                } else {
                    showError('main-content', 'ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°è¡¨ç¤º
        function displayEventDetail(event) {
            const container = document.getElementById('main-content');
            
            // ç¾åœ¨æ™‚åˆ»ã¨é–‹å‚¬æ—¥æ™‚ã®æ¯”è¼ƒ
            const now = new Date();
            const heldAt = new Date(event.held_at);
            const isPastEvent = now > heldAt;
            
            // ç¾åœ¨ã®å›ç­”çŠ¶æ³
            const currentResponse = event.my_response || {};
            const hasResponse = currentResponse.status;
            const isAttend = currentResponse.status === 'attend';
            const isAbsent = currentResponse.status === 'absent';
            
            // ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãƒ»å¯¾è±¡è€…ç¢ºèªï¼ˆä»®å®šï¼šcan_respondãŒfalseãªã‚‰å¯¾è±¡å¤–ï¼‰
            const isTarget = event.can_respond;
            
            // åŸºæœ¬æƒ…å ±è¡¨ç¤º
            let html = `
                <div class="card">
                    <div class="card-body">
                        <!-- 1. ã‚¿ã‚¤ãƒˆãƒ« -->
                        <h2 class="event-title">${escapeHtml(event.title)}</h2>
                        
                        <!-- 2. æ—¥æ™‚ -->
                        <div class="event-date mb-2">
                            ğŸ“… ${formatDate(event.held_at)} ${formatTime(event.held_at)}
                        </div>
                        
                        <!-- 3. ç”»åƒè¡¨ç¤º -->
                        ${event.image_preview_url ? `
                            <div class="mb-3">
                                <img src="${escapeHtml(event.image_preview_url)}" 
                                     alt="ã‚¤ãƒ™ãƒ³ãƒˆç”»åƒ" 
                                     style="width: 100%; border-radius: 6px; cursor: pointer;"
                                     onclick="showFullImage('${escapeHtml(event.image_url)}')">
                                ${event.image_url ? '<p class="text-center mt-2"><small>ğŸ” ã‚¿ãƒƒãƒ—ã§å…¨ç”»é¢è¡¨ç¤º</small></p>' : ''}
                            </div>
                        ` : ''}
                        
                        <!-- 4. ã‚³ãƒ¡ãƒ³ãƒˆ -->
                        ${event.body ? `<div class="event-description mb-3">${escapeHtml(event.body)}</div>` : ''}
                        
                        <!-- 5. ç¾åœ¨ã®å›ç­”çŠ¶æ³ -->
                        ${hasResponse ? `
                            <div class="mb-3 message message-info">
                                ç¾åœ¨ã®å›ç­”: <strong>${getStatusText(currentResponse.status)}</strong>
                                ${currentResponse.responded_at ? `<br><small>å›ç­”æ—¥æ™‚: ${formatDateTime(currentResponse.responded_at)}</small>` : ''}
                            </div>
                        ` : ''}
                        
                        <!-- 6. å‡ºæ¬ å›ç­”ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                        <h3>ğŸ—³ï¸ å‡ºæ¬ å›ç­”</h3>
                        
                        <!-- 7. è¿½åŠ ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ï¼ˆãƒœã‚¿ãƒ³ã®ä¸Šã«é…ç½®ï¼‰ -->
                        ${event.extra_text_enabled ? `
                            <div class="mt-3" id="extra-text-section" ${event.extra_text_attend_only && !isAttend ? 'style="display: none;"' : ''}>
                                <label for="extra-text">${escapeHtml(event.extra_text_label || 'è¿½åŠ ãƒ¡ãƒ¢')}</label>
                                <textarea id="extra-text" rows="3" placeholder="ãƒ¡ãƒ¢ãŒã‚ã‚Œã°ã”è¨˜å…¥ãã ã•ã„">${escapeHtml(currentResponse.extra_text || '')}</textarea>
                            </div>
                        ` : ''}
                        
                        <!-- 8. ãƒœã‚¿ãƒ³ï¼ˆæ¨ªä¸¦ã³ï¼‰ -->
                        <div class="mt-3 d-flex" style="gap: 10px;">
                            <button onclick="submitResponse('attend')" 
                                    id="attend-button"
                                    class="button button-primary" 
                                    style="flex: 1; ${getButtonStyle('attend', isTarget, isPastEvent, isAttend, isAbsent)}">
                                âœ… å‡ºå¸­
                            </button>
                            <button onclick="submitResponse('absent')" 
                                    id="absent-button"
                                    class="button button-secondary" 
                                    style="flex: 1; ${getButtonStyle('absent', isTarget, isPastEvent, isAttend, isAbsent)}">
                                âŒ æ¬ å¸­
                            </button>
                        </div>
                        
                        <!-- 9. ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–ã®ç†ç”±è¡¨ç¤º -->
                        ${getButtonDisabledMessage(isTarget, isPastEvent)}
                        
                    </div>
                </div>
            `;

            // å‡ºæ¬ çŠ¶æ³ä¸€è¦§ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰
            if (event.attendance_status && event.attendance_status.length > 0) {
                html += `
                    <div class="collapsible">
                        <div class="collapsible-header">
                            <span>ğŸ‘¥ å‡ºæ¬ çŠ¶æ³ä¸€è¦§ (${event.attendance_status.length}å)</span>
                            <span class="collapse-icon">â–¼</span>
                        </div>
                        <div class="collapsible-content">
                            <div class="status-list">
                                ${event.attendance_status.map(member => {
                                    const lineStatusEmoji = member.is_target ? 'ğŸŸ¢' : 'âšª';
                                    const statusText = getStatusText(member.status);
                                    const statusClass = getStatusClass(member.status);
                                    const proxyMarker = member.via === 'admin' ? ' âœï¸' : '';
                                    
                                    return `
                                        <div class="member-row">
                                            <div class="member-name">${lineStatusEmoji} ${escapeHtml(member.name)}</div>
                                            <div class="member-status ${statusClass}">
                                                ${statusText}${proxyMarker}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            // å›ç­”å±¥æ­´ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰
            if (event.response_history && event.response_history.length > 0) {
                html += `
                    <div class="collapsible">
                        <div class="collapsible-header">
                            <span>ğŸ“ å›ç­”å±¥æ­´ (${event.response_history.length}ä»¶)</span>
                            <span class="collapse-icon">â–¼</span>
                        </div>
                        <div class="collapsible-content">
                            <div class="history-list">
                                ${event.response_history.map(history => {
                                    const statusText = getStatusText(history.status);
                                    const statusClass = getStatusClass(history.status);
                                    const proxyMarker = history.via === 'admin' ? ' âœï¸' : '';
                                    
                                    return `
                                        <div class="member-row">
                                            <div class="member-name">
                                                ${formatDateTime(history.responded_at)}<br>
                                                <small>${escapeHtml(history.name)}</small>
                                            </div>
                                            <div class="member-status ${statusClass}">
                                                ${statusText}${proxyMarker}
                                                ${history.extra_text ? `<br><small>${escapeHtml(history.extra_text)}</small>` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            // å‡¡ä¾‹
            html += `
                <div class="legend">
                    <div class="legend-title">å‡¡ä¾‹</div>
                    <div>ğŸŸ¢ï¼šå…¬å¼LINEç™»éŒ²æ¸ˆã¿ã€€âšªï¼šå…¬å¼LINEæœªç™»éŒ²ã€€âœï¸ï¼šä»£ç†å›ç­”</div>
                </div>
            `;

            container.innerHTML = html;
            
            // æŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½ã‚’å†åˆæœŸåŒ–
            initCollapsible();
        }

        // ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«åˆ¶å¾¡
        function getButtonStyle(buttonType, isTarget, isPastEvent, isAttend, isAbsent) {
            // å„ªå…ˆåº¦é †ã§æ¡ä»¶ãƒã‚§ãƒƒã‚¯
            if (!isTarget) {
                return 'opacity: 0.4; cursor: not-allowed; pointer-events: none;';
            }
            
            if (isPastEvent) {
                return 'opacity: 0.4; cursor: not-allowed; pointer-events: none;';
            }
            
            if ((buttonType === 'attend' && isAttend) || (buttonType === 'absent' && isAbsent)) {
                return 'opacity: 0.6; cursor: not-allowed; pointer-events: none;';
            }
            
            return '';
        }

        // ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        function getButtonDisabledMessage(isTarget, isPastEvent) {
            if (!isTarget) {
                return `<div class="mt-2 message message-error"><small>ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã®å¯¾è±¡è€…ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</small></div>`;
            }
            
            if (isPastEvent) {
                return `<div class="mt-2 message message-error"><small>é–‹å‚¬æ—¥æ™‚ãŒéãã¦ã„ã‚‹ãŸã‚ã€å›ç­”ã§ãã¾ã›ã‚“ã€‚</small></div>`;
            }
            
            return '';
        }

        // å‡ºæ¬ å›ç­”é€ä¿¡
        async function submitResponse(status) {
            if (!eventId) return;

            // ãƒœã‚¿ãƒ³çŠ¶æ…‹ç¢ºèªï¼ˆå¿µã®ãŸã‚ï¼‰
            const button = document.getElementById(status === 'attend' ? 'attend-button' : 'absent-button');
            if (button && button.style.pointerEvents === 'none') {
                return; // ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒœã‚¿ãƒ³ãªã®ã§å‡¦ç†ã—ãªã„
            }

            try {
                const extraText = eventData?.extra_text_enabled 
                    ? document.getElementById('extra-text')?.value || ''
                    : '';

                const response = await apiRequest(`/api/liff/events/${eventId}/response`, {
                    method: 'POST',
                    body: JSON.stringify({
                        status: status,
                        extra_text: extraText
                    })
                });

                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                const statusText = getStatusText(status);
                showSuccess('response-message', `${statusText}ã§å›ç­”ã—ã¾ã—ãŸã€‚`);
                
                // ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ã‚’å†èª­ã¿è¾¼ã¿
                setTimeout(() => {
                    loadEventDetail();
                }, 1000);

            } catch (error) {
                console.error('å›ç­”é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                showError('response-message', 'å›ç­”ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }

        // å…¨ç”»é¢ç”»åƒè¡¨ç¤º
        function showFullImage(imageUrl) {
            if (!imageUrl) return;
            
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.style.cssText = `
                max-width: 95%;
                max-height: 95%;
                object-fit: contain;
            `;
            
            overlay.appendChild(img);
            overlay.onclick = () => document.body.removeChild(overlay);
            
            document.body.appendChild(overlay);
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚å®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', initPage);
    </script>

    <!-- å›ç­”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="response-message"></div>

    <style>
        /* è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
        .selected {
            opacity: 0.8;
            transform: scale(0.98);
        }
        
        .history-list .member-row {
            border-bottom: 1px solid #e9ecef;
            padding: 12px 0;
        }
        
        .history-list .member-row:last-child {
            border-bottom: none;
        }
        
        .event-description {
            line-height: 1.6;
            color: #495057;
        }
    </style>
</body>
</html>
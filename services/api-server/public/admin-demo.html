<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCå…¬å¼LINE ç®¡ç†ç”»é¢ - Demo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .login-form { max-width: 400px; margin: 50px auto; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .member-list, .audience-list { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; }
        .badge { padding: 2px 8px; border-radius: 12px; font-size: 12px; }
        .badge-member { background: #e3f2fd; color: #1976d2; }
        .badge-staff { background: #fff3e0; color: #f57c00; }
        .badge-linked { background: #e8f5e8; color: #2e7d32; }
        .badge-unlinked { background: #ffebee; color: #d32f2f; }
        .hidden { display: none; }
        .nav { margin: 20px 0; }
        .nav button { margin-right: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
        <div id="login-section" class="card">
            <div class="login-form">
                <h2>RCå…¬å¼LINE ç®¡ç†ç”»é¢</h2>
                <div class="form-group">
                    <label for="username">ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</label>
                    <input type="text" id="username" value="hanaki">
                </div>
                <div class="form-group">
                    <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                    <input type="password" id="password" value="vLJCUJ">
                </div>
                <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <div id="login-message" class="error"></div>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ç®¡ç†ç”»é¢ -->
        <div id="main-section" class="hidden">
            <h1>RCå…¬å¼LINE ç®¡ç†ç”»é¢</h1>
            <div class="nav">
                <button onclick="showSection('members')">ä¼šå“¡ä¸€è¦§</button>
                <button onclick="showSection('audiences')">audiencesç®¡ç†</button>
                <button onclick="showSection('audience-members')" id="audience-members-btn" class="hidden">audienceãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</button>
                <button onclick="showSection('events')">ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†</button>
                <button onclick="logout()" class="danger">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>

            <!-- ä¼šå“¡ä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="members-section" class="card">
                <h3>ä¼šå“¡ä¸€è¦§</h3>
                <div class="form-group">
                    <label for="role-filter">Role ãƒ•ã‚£ãƒ«ã‚¿:</label>
                    <select id="role-filter" onchange="loadMembers()">
                        <option value="">ã™ã¹ã¦</option>
                        <option value="member" selected>member ã®ã¿</option>
                        <option value="staff">staff ã®ã¿</option>
                    </select>
                </div>
                <div class="member-list">
                    <table id="members-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>åå‰</th>
                                <th>Role</th>
                                <th>LINEç´ã¥ã‘</th>
                                <th>é€ä¿¡å¯¾è±¡</th>
                                <th>è¡¨ç¤ºé †</th>
                            </tr>
                        </thead>
                        <tbody id="members-tbody"></tbody>
                    </table>
                </div>
                <button onclick="loadMembers()">æ›´æ–°</button>
            </div>

            <!-- audiencesç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="audiences-section" class="card">
                <h3>Audiencesç®¡ç†</h3>
                
                <!-- æ–°è¦ä½œæˆ -->
                <div class="form-group">
                    <h4>æ–°è¦audienceä½œæˆ</h4>
                    <label for="audience-name">åå‰:</label>
                    <input type="text" id="audience-name" placeholder="ä¾‹: ç†äº‹ä¼š">
                    <label for="audience-sort">ã‚½ãƒ¼ãƒˆé †:</label>
                    <input type="number" id="audience-sort" placeholder="1">
                    <button onclick="createAudience()">ä½œæˆ</button>
                </div>

                <!-- ä¸€è¦§ -->
                <div class="audience-list">
                    <table id="audiences-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>åå‰</th>
                                <th>ã‚½ãƒ¼ãƒˆé †</th>
                                <th>ä½œæˆæ—¥æ™‚</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="audiences-tbody"></tbody>
                    </table>
                </div>
                <button onclick="loadAudiences()">æ›´æ–°</button>
                <div id="audience-message"></div>
            </div>

            <!-- audienceãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="audience-members-section" class="card hidden">
                <h3>Audienceãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</h3>
                <div id="audience-info">
                    <h4 id="current-audience-name">-</h4>
                    <button onclick="showSection('audiences')">â† audiencesä¸€è¦§ã«æˆ»ã‚‹</button>
                </div>
                
                <div class="form-group">
                    <h4>ç¾åœ¨ã®æ‰€å±ãƒ¡ãƒ³ãƒãƒ¼</h4>
                    <div id="current-members">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
                
                <div class="form-group">
                    <h4>ãƒ¡ãƒ³ãƒãƒ¼é¸æŠ</h4>
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                        <div id="member-selection">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                    <button onclick="saveAudienceMembers()" style="margin-top: 10px;">é¸æŠã—ãŸãƒ¡ãƒ³ãƒãƒ¼ã‚’ä¿å­˜</button>
                    <div id="member-save-message"></div>
                </div>
            </div>

            <!-- ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="events-section" class="card hidden">
                <h3>ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†</h3>
                <!-- ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ -->
                <div class="form-group">
                    <h4>ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§</h4>
                    <button onclick="loadEvents()">èª­ã¿è¾¼ã¿</button>
                    <div id="events-list">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
                
                <!-- ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆãƒ•ã‚©ãƒ¼ãƒ  -->
                <div class="form-group">
                    <h4>æ–°è¦ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ</h4>
                    <form id="event-form" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="event-title">ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå¿…é ˆï¼‰:</label>
                            <input type="text" id="event-title" name="title" required maxlength="100" placeholder="ä¾‹: å®šä¾‹ä¼šè­°">
                        </div>
                        
                        <div class="form-group">
                            <label for="event-held-at">é–‹å‚¬æ—¥æ™‚ï¼ˆå¿…é ˆï¼‰:</label>
                            <input type="datetime-local" id="event-held-at" name="held_at" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="event-deadline-at">å›ç­”æœŸé™ï¼ˆå¿…é ˆï¼‰:</label>
                            <input type="date" id="event-deadline-at" name="deadline_at" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="event-body">æœ¬æ–‡:</label>
                            <textarea id="event-body" name="body" rows="3" maxlength="2000">å‡ºæ¬ ã®ã”å›ç­”ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="event-image">ç”»åƒï¼ˆJPGã€å¿…é ˆã€5MBä»¥ä¸‹ï¼‰:</label>
                            <input type="file" id="event-image" name="image" accept="image/jpeg" required>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="extra-text-enabled" name="extra_text_enabled">
                                è¿½åŠ ãƒ¡ãƒ¢æ¬„ã‚’æœ‰åŠ¹ã«ã™ã‚‹
                            </label>
                            <div id="extra-text-options" class="hidden" style="margin-left: 20px;">
                                <div class="form-group">
                                    <label for="extra-text-label">ãƒ¡ãƒ¢æ¬„ã®ãƒ©ãƒ™ãƒ«:</label>
                                    <input type="text" id="extra-text-label" name="extra_text_label" value="å‚™è€ƒ" maxlength="50">
                                </div>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="extra-text-attend-only" name="extra_text_attend_only" checked>
                                        å‡ºå¸­æ™‚ã®ã¿è¡¨ç¤º
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <h4>é…ä¿¡å¯¾è±¡é¸æŠ</h4>
                            <div id="audience-selection">
                                <div style="margin: 10px 0;">
                                    <label>
                                        <input type="checkbox" id="select-all-members" onchange="toggleAllMembers()">
                                        å…¨å“¡
                                    </label>
                                </div>
                                <div id="audience-checkboxes">èª­ã¿è¾¼ã¿ä¸­...</div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <h4>å—ä¿¡è€…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h4>
                            <div id="target-preview">é…ä¿¡å¯¾è±¡ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                            <button type="button" onclick="updateTargetPreview()">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°</button>
                        </div>
                        
                        <button type="submit" id="event-create-button">ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆï¼†é€ä¿¡</button>
                        <div id="event-create-message"></div>
                    </form>
                </div>
            </div>

            <!-- ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="event-detail-section" class="card hidden">
                <h3>ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°</h3>
                <div>
                    <button onclick="showSection('events')">â† ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã«æˆ»ã‚‹</button>
                </div>
                
                <div id="event-detail-content">èª­ã¿è¾¼ã¿ä¸­...</div>
                
                <!-- åŸºæœ¬æƒ…å ± -->
                <div class="form-group">
                    <h4>åŸºæœ¬æƒ…å ±</h4>
                    <div id="event-basic-info">-</div>
                </div>
                
                <!-- é€ä¿¡è¦ç´„ -->
                <div class="form-group">
                    <h4>é€ä¿¡è¦ç´„</h4>
                    <div id="event-push-summary">-</div>
                </div>
                
                <!-- ç”»åƒè¡¨ç¤º -->
                <div class="form-group">
                    <h4>ç”»åƒ</h4>
                    <div id="event-image-display">-</div>
                </div>
                
                <!-- å‡ºæ¬ çŠ¶æ³ -->
                <div class="form-group">
                    <h4>å‡ºæ¬ çŠ¶æ³</h4>
                    <div id="event-attendance-summary">-</div>
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                        <div id="event-attendance-list">-</div>
                    </div>
                </div>
                
                <!-- CSVå‡ºåŠ› -->
                <div class="form-group">
                    <h4>CSVå‡ºåŠ›</h4>
                    <button onclick="downloadCSV('latest')" id="csv-latest-btn">æœ€æ–°çŠ¶æ…‹ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    <button onclick="downloadCSV('history')" id="csv-history-btn">å›ç­”å±¥æ­´ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentSection = 'members';
        let currentAudienceId = null;
        let currentAudienceName = null;
        let currentEventId = null;
        let currentEventTitle = null;
        let allMembers = [];
        let audiencesData = [];

        // ãƒ­ã‚°ã‚¤ãƒ³
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const messageDiv = document.getElementById('login-message');

            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    currentUser = data.user;
                    messageDiv.innerHTML = '<span class="success">ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ</span>';
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('main-section').classList.remove('hidden');
                    showSection('members');
                } else {
                    messageDiv.innerHTML = `<span class="error">${data.message}</span>`;
                }
            } catch (error) {
                messageDiv.innerHTML = `<span class="error">ã‚¨ãƒ©ãƒ¼: ${error.message}</span>`;
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        async function logout() {
            try {
                await fetch('/api/admin/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
            }

            currentUser = null;
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('main-section').classList.add('hidden');
        }

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆ
        function showSection(section) {
            currentSection = section;
            document.getElementById('members-section').style.display = section === 'members' ? 'block' : 'none';
            document.getElementById('audiences-section').style.display = section === 'audiences' ? 'block' : 'none';
            document.getElementById('audience-members-section').style.display = section === 'audience-members' ? 'block' : 'none';
            document.getElementById('events-section').style.display = section === 'events' ? 'block' : 'none';
            document.getElementById('event-detail-section').style.display = section === 'event-detail' ? 'block' : 'none';

            if (section === 'members') loadMembers();
            if (section === 'audiences') loadAudiences();
            if (section === 'audience-members') loadAudienceMembers();
            if (section === 'events') loadEventsSection();
            if (section === 'event-detail') loadEventDetail();
        }

        // ä¼šå“¡ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadMembers() {
            const role = document.getElementById('role-filter').value;
            const params = role ? `?role=${role}` : '';

            try {
                const response = await fetch(`/api/admin/members${params}`, {
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('èªè¨¼ãŒå¿…è¦ã§ã™');

                const data = await response.json();
                const tbody = document.getElementById('members-tbody');
                
                tbody.innerHTML = data.items.map(member => `
                    <tr>
                        <td>${member.id}</td>
                        <td>${member.name}</td>
                        <td><span class="badge badge-${member.role}">${member.role}</span></td>
                        <td><span class="badge badge-${member.line_user_id_present ? 'linked' : 'unlinked'}">${member.line_user_id_present ? 'ç´ã¥ã‘æ¸ˆã¿' : 'æœªç´ã¥ã‘'}</span></td>
                        <td>${member.is_target ? 'â—‹' : 'Ã—'}</td>
                        <td>${member.display_order || '-'}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('ä¼šå“¡ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // audiencesä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadAudiences() {
            try {
                const response = await fetch('/api/admin/audiences', {
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('èªè¨¼ãŒå¿…è¦ã§ã™');

                const data = await response.json();
                const tbody = document.getElementById('audiences-tbody');
                
                tbody.innerHTML = data.items.map(audience => `
                    <tr>
                        <td>${audience.id}</td>
                        <td>${audience.name}</td>
                        <td>${audience.sort_order || '-'}</td>
                        <td>${new Date(audience.created_at).toLocaleString('ja-JP')}</td>
                        <td>
                            <button onclick="manageAudienceMembers(${audience.id}, '${audience.name}')">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</button>
                            <button onclick="deleteAudience(${audience.id})" class="danger">å‰Šé™¤</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('audiencesä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // audienceä½œæˆ
        async function createAudience() {
            const name = document.getElementById('audience-name').value;
            const sort_order = document.getElementById('audience-sort').value;
            const messageDiv = document.getElementById('audience-message');

            if (!name) {
                messageDiv.innerHTML = '<span class="error">åå‰ã¯å¿…é ˆã§ã™</span>';
                return;
            }

            try {
                const response = await fetch('/api/admin/audiences', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ 
                        name, 
                        sort_order: sort_order ? parseInt(sort_order) : undefined 
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    messageDiv.innerHTML = '<span class="success">ä½œæˆå®Œäº†</span>';
                    document.getElementById('audience-name').value = '';
                    document.getElementById('audience-sort').value = '';
                    loadAudiences();
                } else {
                    messageDiv.innerHTML = `<span class="error">${data.message}</span>`;
                }
            } catch (error) {
                messageDiv.innerHTML = `<span class="error">ã‚¨ãƒ©ãƒ¼: ${error.message}</span>`;
            }
        }

        // audienceå‰Šé™¤
        async function deleteAudience(id) {
            if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                const response = await fetch(`/api/admin/audiences/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    loadAudiences();
                } else {
                    alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // audienceãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ç”»é¢ã‚’è¡¨ç¤º
        function manageAudienceMembers(audienceId, audienceName) {
            currentAudienceId = audienceId;
            currentAudienceName = audienceName;
            document.getElementById('current-audience-name').textContent = `${audienceName} (ID: ${audienceId})`;
            showSection('audience-members');
        }

        // audienceãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadAudienceMembers() {
            if (!currentAudienceId) return;
            
            try {
                // ç¾åœ¨ã®æ‰€å±ãƒ¡ãƒ³ãƒãƒ¼ã‚’å–å¾—
                const currentResponse = await fetch(`/api/admin/audiences/${currentAudienceId}/members`, {
                    credentials: 'include'
                });
                
                if (!currentResponse.ok) throw new Error('èªè¨¼ãŒå¿…è¦ã§ã™');
                
                const currentData = await currentResponse.json();
                
                // ç¾åœ¨ã®æ‰€å±ãƒ¡ãƒ³ãƒãƒ¼è¡¨ç¤º
                const currentDiv = document.getElementById('current-members');
                if (currentData.items.length === 0) {
                    currentDiv.innerHTML = '<p>æ‰€å±ãƒ¡ãƒ³ãƒãƒ¼ã¯ã„ã¾ã›ã‚“</p>';
                } else {
                    let html = '<table><thead><tr><th>åå‰</th><th>Role</th><th>LINEç´ã¥ã‘</th></tr></thead><tbody>';
                    currentData.items.forEach(member => {
                        html += `<tr>
                            <td>${member.name}</td>
                            <td><span style="background: ${member.role === 'member' ? '#e3f2fd' : '#fff3e0'}; color: ${member.role === 'member' ? '#1976d2' : '#f57c00'}; padding: 2px 8px; border-radius: 12px; font-size: 12px;">${member.role}</span></td>
                            <td><span style="background: ${member.line_user_id_present ? '#e8f5e8' : '#ffebee'}; color: ${member.line_user_id_present ? '#2e7d32' : '#d32f2f'}; padding: 2px 8px; border-radius: 12px; font-size: 12px;">${member.line_user_id_present ? 'ç´ã¥ã‘æ¸ˆã¿' : 'æœªç´ã¥ã‘'}</span></td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                    currentDiv.innerHTML = html;
                }
                
                // å…¨ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã‚’å–å¾—ã—ã¦ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤º
                const allResponse = await fetch('/api/admin/members?role=member', {
                    credentials: 'include'
                });
                
                if (!allResponse.ok) throw new Error('èªè¨¼ãŒå¿…è¦ã§ã™');
                
                const allData = await allResponse.json();
                const currentMemberIds = new Set(currentData.items.map(m => m.member_id));
                
                const selectionDiv = document.getElementById('member-selection');
                let selectionHtml = '';
                allData.items.forEach(member => {
                    const isSelected = currentMemberIds.has(member.id);
                    selectionHtml += `
                        <div style="margin: 5px 0;">
                            <label>
                                <input type="checkbox" name="member-checkbox" value="${member.id}" ${isSelected ? 'checked' : ''}>
                                ${member.name} (${member.role}) ${member.line_user_id_present ? 'âœ“' : 'âœ—'}
                            </label>
                        </div>
                    `;
                });
                selectionDiv.innerHTML = selectionHtml;
                
            } catch (error) {
                document.getElementById('current-members').innerHTML = `<div class="error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                document.getElementById('member-selection').innerHTML = `<div class="error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }

        // audienceãƒ¡ãƒ³ãƒãƒ¼ä¿å­˜
        async function saveAudienceMembers() {
            if (!currentAudienceId) return;
            
            const checkboxes = document.querySelectorAll('input[name="member-checkbox"]:checked');
            const memberIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            const messageDiv = document.getElementById('member-save-message');
            
            try {
                const response = await fetch(`/api/admin/audiences/${currentAudienceId}/members`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ member_ids: memberIds })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    messageDiv.innerHTML = `<div class="success">ä¿å­˜å®Œäº†: ${data.count}åã‚’å‰²ã‚Šå½“ã¦ã¾ã—ãŸ</div>`;
                    loadAudienceMembers(); // ç”»é¢ã‚’æ›´æ–°
                } else {
                    messageDiv.innerHTML = `<div class="error">ä¿å­˜å¤±æ•—: ${data.message}</div>`;
                }
            } catch (error) {
                messageDiv.innerHTML = `<div class="error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }

        // ===== ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†é–¢æ•° =====

        // ã‚¤ãƒ™ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
        async function loadEventsSection() {
            await loadEvents();
            await loadAudiencesForEvents();
            await loadMembersForEvents();
            initializeEventForm();
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadEvents() {
            const listDiv = document.getElementById('events-list');
            
            try {
                const response = await fetch('/api/admin/events', {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('èªè¨¼ãŒå¿…è¦ã§ã™');
                
                const data = await response.json();
                
                if (data.items.length === 0) {
                    listDiv.innerHTML = '<p>ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                } else {
                    let html = '<table><thead><tr><th>ID</th><th>ã‚¿ã‚¤ãƒˆãƒ«</th><th>é–‹å‚¬æ—¥æ™‚</th><th>å¯¾è±¡è€…æ•°</th><th>ä½œæˆæ—¥æ™‚</th><th>æ“ä½œ</th></tr></thead><tbody>';
                    data.items.forEach(event => {
                        const heldAt = new Date(event.held_at).toLocaleString('ja-JP');
                        const createdAt = new Date(event.created_at).toLocaleString('ja-JP');
                        html += `<tr>
                            <td>${event.id}</td>
                            <td>${event.title}</td>
                            <td>${heldAt}</td>
                            <td>${event.target_count}å</td>
                            <td>${createdAt}</td>
                            <td>
                                <button onclick="showEventDetail(${event.id}, '${event.title}')">è©³ç´°</button>
                            </td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                    listDiv.innerHTML = html;
                }
            } catch (error) {
                listDiv.innerHTML = `<div class="error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }

        // audiences ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆç”¨ï¼‰
        async function loadAudiencesForEvents() {
            try {
                const response = await fetch('/api/admin/audiences', {
                    credentials: 'include'
                });
                
                if (!response.ok) return;
                
                const data = await response.json();
                audiencesData = data.items;
                
                const checkboxDiv = document.getElementById('audience-checkboxes');
                let html = '';
                audiencesData.forEach(audience => {
                    html += `
                        <div style="margin: 5px 0;">
                            <label>
                                <input type="checkbox" name="audience-checkbox" value="${audience.id}" onchange="updateTargetPreview()">
                                ${audience.name}
                            </label>
                        </div>
                    `;
                });
                checkboxDiv.innerHTML = html;
            } catch (error) {
                console.error('Audiencesèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // å…¨ãƒ¡ãƒ³ãƒãƒ¼èª­ã¿è¾¼ã¿ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆç”¨ï¼‰
        async function loadMembersForEvents() {
            try {
                const response = await fetch('/api/admin/members?role=member', {
                    credentials: 'include'
                });
                
                if (!response.ok) return;
                
                const data = await response.json();
                allMembers = data.items;
            } catch (error) {
                console.error('Membersèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // å…¨å“¡ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleAllMembers() {
            const selectAll = document.getElementById('select-all-members');
            const audienceCheckboxes = document.querySelectorAll('input[name="audience-checkbox"]');
            
            audienceCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateTargetPreview();
        }

        // å—ä¿¡è€…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
        async function updateTargetPreview() {
            const previewDiv = document.getElementById('target-preview');
            const selectAll = document.getElementById('select-all-members');
            const checkedAudiences = document.querySelectorAll('input[name="audience-checkbox"]:checked');
            
            if (selectAll.checked) {
                previewDiv.innerHTML = `<p><strong>å…¨å“¡: ${allMembers.length}å</strong></p>`;
                return;
            }
            
            if (checkedAudiences.length === 0) {
                previewDiv.innerHTML = '<p>é…ä¿¡å¯¾è±¡ã‚’é¸æŠã—ã¦ãã ã•ã„</p>';
                return;
            }
            
            try {
                // é¸æŠã•ã‚ŒãŸaudienceã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’å–å¾—
                const selectedAudienceIds = Array.from(checkedAudiences).map(cb => parseInt(cb.value));
                let targetMemberIds = new Set();
                
                for (const audienceId of selectedAudienceIds) {
                    const response = await fetch(`/api/admin/audiences/${audienceId}/members`, {
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        data.items.forEach(member => targetMemberIds.add(member.member_id));
                    }
                }
                
                const targetMembers = allMembers.filter(member => targetMemberIds.has(member.id));
                targetMembers.sort((a, b) => (a.display_order || 999) - (b.display_order || 999));
                
                let html = `<p><strong>å¯¾è±¡: ${targetMembers.length}å</strong></p>`;
                html += '<div style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 5px;">';
                targetMembers.forEach(member => {
                    html += `<div>${member.name} (${member.role})</div>`;
                });
                html += '</div>';
                
                previewDiv.innerHTML = html;
            } catch (error) {
                previewDiv.innerHTML = `<div class="error">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ åˆæœŸåŒ–
        function initializeEventForm() {
            // è¿½åŠ ãƒ¡ãƒ¢æ¬„ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ¶å¾¡
            document.getElementById('extra-text-enabled').addEventListener('change', function() {
                const options = document.getElementById('extra-text-options');
                options.classList.toggle('hidden', !this.checked);
            });
            
            // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
            const form = document.getElementById('event-form');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await createEvent();
                });
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆå‡¦ç†
        async function createEvent() {
            const messageDiv = document.getElementById('event-create-message');
            const form = document.getElementById('event-form');
            const formData = new FormData();
            
            // åŸºæœ¬é …ç›®ã®è¿½åŠ 
            formData.append('title', document.getElementById('event-title').value);
            formData.append('body', document.getElementById('event-body').value);
            
            const imageFile = document.getElementById('event-image').files[0];
            if (imageFile) {
                formData.append('image', imageFile);
            }
            
            formData.append('extra_text_label', document.getElementById('extra-text-label').value);
            
            // å¯¾è±¡ãƒ¡ãƒ³ãƒãƒ¼IDsã‚’å–å¾—
            const selectAll = document.getElementById('select-all-members');
            let targetMemberIds = [];
            
            if (selectAll.checked) {
                targetMemberIds = allMembers.map(m => m.id);
            } else {
                const checkedAudiences = document.querySelectorAll('input[name="audience-checkbox"]:checked');
                const selectedAudienceIds = Array.from(checkedAudiences).map(cb => parseInt(cb.value));
                
                if (selectedAudienceIds.length === 0) {
                    messageDiv.innerHTML = '<div class="error">é…ä¿¡å¯¾è±¡ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
                    return;
                }
                
                // é¸æŠã•ã‚ŒãŸaudienceã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’å–å¾—
                const targetMemberIdsSet = new Set();
                for (const audienceId of selectedAudienceIds) {
                    try {
                        const response = await fetch(`/api/admin/audiences/${audienceId}/members`, {
                            credentials: 'include'
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            data.items.forEach(member => targetMemberIdsSet.add(member.member_id));
                        }
                    } catch (error) {
                        console.error('Audience memberså–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    }
                }
                
                targetMemberIds = Array.from(targetMemberIdsSet);
            }
            
            if (targetMemberIds.length === 0) {
                messageDiv.innerHTML = '<div class="error">å¯¾è±¡ãƒ¡ãƒ³ãƒãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            formData.append('target_member_ids', JSON.stringify(targetMemberIds));
            
            // datetime-localã®å€¤ã‚’ISO8601å½¢å¼ã«å¤‰æ›
            const heldAtInput = document.getElementById('event-held-at');
            if (heldAtInput.value) {
                const localDateTime = new Date(heldAtInput.value);
                const jstDateTime = new Date(localDateTime.getTime() - localDateTime.getTimezoneOffset() * 60000);
                const iso8601 = jstDateTime.toISOString().slice(0, 19) + '+09:00';
                formData.append('held_at', iso8601);
            }
            
            // å›ç­”æœŸé™ã®å‡¦ç†ï¼ˆæ—¥ä»˜ã®ã¿ â†’ 23:59:59 JSTã«å¤‰æ›ï¼‰
            const deadlineAtInput = document.getElementById('event-deadline-at');
            if (deadlineAtInput.value) {
                // æ—¥ä»˜ã«23:59:59ã‚’ä»˜ä¸ã—ã¦JSTå½¢å¼ã«å¤‰æ›
                const deadlineDate = deadlineAtInput.value + 'T23:59:59+09:00';
                formData.append('deadline_at', deadlineDate);
            }
            
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å€¤ã‚’æ˜ç¤ºçš„ã«booleanæ–‡å­—åˆ—ã§è¿½åŠ 
            const extraTextEnabled = document.getElementById('extra-text-enabled').checked;
            const extraTextAttendOnly = document.getElementById('extra-text-attend-only').checked;
            formData.append('extra_text_enabled', extraTextEnabled ? 'true' : 'false');
            formData.append('extra_text_attend_only', extraTextAttendOnly ? 'true' : 'false');
            
            messageDiv.innerHTML = '<div>ä½œæˆä¸­...</div>';
            
            try {
                const response = await fetch('/api/admin/events', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    messageDiv.innerHTML = `<div class="success">ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆæˆåŠŸï¼<br>ã‚¤ãƒ™ãƒ³ãƒˆID: ${data.event_id}<br>å¯¾è±¡è€…: ${data.targets}å<br>é€ä¿¡: æˆåŠŸ${data.push.success}ä»¶ã€å¤±æ•—${data.push.fail}ä»¶</div>`;
                    form.reset();
                    document.getElementById('extra-text-options').classList.add('hidden');
                    document.getElementById('target-preview').innerHTML = 'é…ä¿¡å¯¾è±¡ã‚’é¸æŠã—ã¦ãã ã•ã„';
                    loadEvents(); // ä¸€è¦§ã‚’æ›´æ–°
                } else {
                    let errorMsg = `<div class="error">ä½œæˆå¤±æ•—: ${data.message}`;
                    if (data.details) {
                        console.error('[ERROR] ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:', data.details);
                        errorMsg += '<br><br>è©³ç´°:<br>' + data.details.map(d => `â€¢ ${d.msg} (${d.param})`).join('<br>');
                    }
                    errorMsg += '</div>';
                    messageDiv.innerHTML = errorMsg;
                }
            } catch (error) {
                messageDiv.innerHTML = `<div class="error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }

        // ===== ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°é–¢æ•° =====

        // ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°è¡¨ç¤ºï¼ˆè©³ç´°ãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ï¼‰
        function showEventDetail(eventId, eventTitle) {
            currentEventId = eventId;
            currentEventTitle = eventTitle;
            showSection('event-detail');
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadEventDetail() {
            if (!currentEventId) return;
            
            const contentDiv = document.getElementById('event-detail-content');
            contentDiv.innerHTML = 'èª­ã¿è¾¼ã¿ä¸­...';
            
            try {
                const response = await fetch(`/api/admin/events/${currentEventId}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('èªè¨¼ãŒå¿…è¦ã§ã™');
                
                const event = await response.json();
                
                // åŸºæœ¬æƒ…å ±è¡¨ç¤º
                const basicInfoDiv = document.getElementById('event-basic-info');
                const heldAt = new Date(event.held_at).toLocaleString('ja-JP');
                const deadlineAt = event.deadline_at ? new Date(event.deadline_at).toLocaleString('ja-JP') : 'æœªè¨­å®š';
                basicInfoDiv.innerHTML = `
                    <p><strong>ã‚¿ã‚¤ãƒˆãƒ«:</strong> ${event.title}</p>
                    <p><strong>é–‹å‚¬æ—¥æ™‚:</strong> ${heldAt}</p>
                    <p><strong>å›ç­”æœŸé™:</strong> ${deadlineAt}</p>
                    <p><strong>æœ¬æ–‡:</strong></p>
                    <div style="white-space: pre-wrap; background: #f8f9fa; padding: 10px; border-radius: 4px;">${event.body || '-'}</div>
                    <p><strong>è¿½åŠ ãƒ¡ãƒ¢æ¬„:</strong> ${event.extra_text.enabled ? `æœ‰åŠ¹ï¼ˆ${event.extra_text.label}${event.extra_text.attend_only ? ', å‡ºå¸­æ™‚ã®ã¿è¡¨ç¤º' : ''}ï¼‰` : 'ç„¡åŠ¹'}</p>
                `;
                
                // é€ä¿¡è¦ç´„è¡¨ç¤º
                const pushSummaryDiv = document.getElementById('event-push-summary');
                const lastSent = event.push_stats.last_sent_at ? new Date(event.push_stats.last_sent_at).toLocaleString('ja-JP') : 'æœªé€ä¿¡';
                pushSummaryDiv.innerHTML = `
                    <p><strong>é€ä¿¡çµæœ:</strong> æˆåŠŸ ${event.push_stats.success_count}ä»¶ / å¤±æ•— ${event.push_stats.fail_count}ä»¶ / åˆè¨ˆ ${event.push_stats.total_count}ä»¶</p>
                    <p><strong>æœ€çµ‚é€ä¿¡æ—¥æ™‚:</strong> ${lastSent}</p>
                `;
                
                // ç”»åƒè¡¨ç¤º
                const imageDisplayDiv = document.getElementById('event-image-display');
                if (event.image_preview_url) {
                    imageDisplayDiv.innerHTML = `
                        <div>
                            <img src="${event.image_preview_url}" style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px;">
                            <p><a href="${event.image_url}" target="_blank">å…¨ç”»é¢ã§é–‹ãï¼ˆã‚ªãƒªã‚¸ãƒŠãƒ«ï¼‰</a></p>
                        </div>
                    `;
                } else {
                    imageDisplayDiv.innerHTML = '<p>ç”»åƒãªã—</p>';
                }
                
                // å‡ºæ¬ çŠ¶æ³è¡¨ç¤º
                displayAttendanceStatus(event.current_status, event.can_proxy_respond);
                
                contentDiv.innerHTML = 'èª­ã¿è¾¼ã¿å®Œäº†';
                
            } catch (error) {
                contentDiv.innerHTML = `<div class="error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }

        // å‡ºæ¬ çŠ¶æ³è¡¨ç¤º
        function displayAttendanceStatus(statusData, canProxyRespond = false) {
            const summaryDiv = document.getElementById('event-attendance-summary');
            const listDiv = document.getElementById('event-attendance-list');
            
            // é›†è¨ˆ
            const attendCount = statusData.filter(s => s.status === 'attend').length;
            const absentCount = statusData.filter(s => s.status === 'absent').length;
            const pendingCount = statusData.filter(s => s.status === 'pending').length;
            
            summaryDiv.innerHTML = `
                <p><strong>å‡ºå¸­:</strong> ${attendCount}å / <strong>æ¬ å¸­:</strong> ${absentCount}å / <strong>æœªå›ç­”:</strong> ${pendingCount}å / <strong>åˆè¨ˆ:</strong> ${statusData.length}å</p>
            `;
            
            // ä¸€è¦§
            if (statusData.length === 0) {
                listDiv.innerHTML = '<p>å¯¾è±¡è€…ãŒã„ã¾ã›ã‚“</p>';
            } else {
                const headerCols = canProxyRespond 
                    ? '<th>åå‰</th><th>å‡ºæ¬ </th><th>ãƒ¡ãƒ¢</th><th>å›ç­”æ—¥æ™‚</th><th>ä»£ç†å›ç­”</th>'
                    : '<th>åå‰</th><th>å‡ºæ¬ </th><th>ãƒ¡ãƒ¢</th><th>å›ç­”æ—¥æ™‚</th>';
                
                let html = `<table style="width: 100%; border-collapse: collapse;"><thead><tr>${headerCols}</tr></thead><tbody>`;
                statusData.forEach(member => {
                    const statusText = member.status === 'attend' ? 'å‡ºå¸­' : member.status === 'absent' ? 'æ¬ å¸­' : 'æœªå›ç­”';
                    const statusColor = member.status === 'attend' ? '#28a745' : member.status === 'absent' ? '#dc3545' : '#6c757d';
                    const respondedAt = member.responded_at ? new Date(member.responded_at).toLocaleString('ja-JP') : '-';
                    
                    // LINEç™»éŒ²çŠ¶æ³ã®çµµæ–‡å­—
                    const lineStatusEmoji = member.is_target ? 'ğŸŸ¢' : 'âšª';
                    
                    // ä»£ç†å›ç­”ãƒãƒ¼ã‚«ãƒ¼ï¼ˆâœï¸ï¼‰
                    const proxyMarker = member.via === 'admin' ? ' âœï¸' : '';
                    
                    const proxyButtons = canProxyRespond 
                        ? `<td>
                            <button onclick="proxyRespond(${member.member_id}, '${member.name}', 'attend')" style="background: #28a745; color: white; padding: 4px 8px; margin-right: 4px; border: none; border-radius: 3px; font-size: 12px;">å‡ºå¸­ä»£ç†</button>
                            <button onclick="proxyRespond(${member.member_id}, '${member.name}', 'absent')" style="background: #dc3545; color: white; padding: 4px 8px; border: none; border-radius: 3px; font-size: 12px;">æ¬ å¸­ä»£ç†</button>
                           </td>`
                        : '';
                    
                    html += `<tr>
                        <td>${lineStatusEmoji} ${member.name}</td>
                        <td><span style="color: ${statusColor}; font-weight: bold;">${statusText}</span>${proxyMarker}</td>
                        <td>${member.extra_text || '-'}</td>
                        <td>${respondedAt}</td>
                        ${proxyButtons}
                    </tr>`;
                });
                html += '</tbody></table>';
                
                // å‡¡ä¾‹ã‚’è¿½åŠ 
                html += `<div style="margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 4px; font-size: 12px; color: #6c757d;">
                    <strong>å‡¡ä¾‹:</strong> ğŸŸ¢ï¼šå…¬å¼LINEç™»éŒ²æ¸ˆã¿ã€€âšªï¼šå…¬å¼LINEæœªç™»éŒ²ã€€âœï¸ï¼šä»£ç†å›ç­”
                </div>`;
                
                listDiv.innerHTML = html;
            }
        }

        // CSV ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadCSV(type) {
            if (!currentEventId) return;
            
            const url = type === 'latest' 
                ? `/api/admin/events/${currentEventId}/export/latest.csv`
                : `/api/admin/events/${currentEventId}/export/history.csv`;
                
            // èªè¨¼ä»˜ããƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            fetch(url, {
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) throw new Error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = type === 'latest' 
                    ? `event_${currentEventId}_latest.csv`
                    : `event_${currentEventId}_history.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                alert(`CSV ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            });
        }

        // ===== ä»£ç†å›ç­”æ©Ÿèƒ½ =====

        // ä»£ç†å›ç­”å®Ÿè¡Œ
        async function proxyRespond(memberId, memberName, status) {
            const statusText = status === 'attend' ? 'å‡ºå¸­' : 'æ¬ å¸­';
            
            // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
            if (!confirm(`${memberName}ã•ã‚“ã®ä»£ç†ã§ã€Œ${statusText}ã€ã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/events/${currentEventId}/proxy-response`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        member_id: memberId,
                        status: status,
                        extra_text: '' // ä»Šå›ã¯ç°¡æ˜“å®Ÿè£…ã§ãƒ†ã‚­ã‚¹ãƒˆãªã—
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'ä»£ç†å›ç­”ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                // æˆåŠŸæ™‚ã¯è©³ç´°ã‚’å†èª­ã¿è¾¼ã¿
                await loadEventDetail();
                alert(`${memberName}ã•ã‚“ã®ä»£ç†å›ç­”ï¼ˆ${statusText}ï¼‰ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚`);
                
            } catch (error) {
                alert(`ä»£ç†å›ç­”ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
    </script>
</body>
</html>